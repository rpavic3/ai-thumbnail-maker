<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Thumbnail Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
       :root {
      --bg: #0e0d11;
      --surface: #1c1a23;
      --text: #f5f5f7;
      --accent: #a78bfa;
      --accent-hover: #c4b5fd;
      --input-bg: #2a2733;
      --logout: #fca5a5;
      --logout-hover: #f87171;
      --radius: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      font-family: 'Outfit', sans-serif;
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .container {
      width: 100%;
      max-width: 820px;
      margin-top: 4rem;
      background: var(--surface);
      border-radius: var(--radius);
      padding: 3rem 2rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      position: relative;
    }

    h1 {
      font-size: 2.6rem;
      color: var(--accent);
      text-align: center;
      margin-bottom: 1.5rem;
    }

    input, textarea {
      width: 100%;
      padding: 1rem;
      font-size: 1rem;
      background: var(--input-bg);
      border: 1px solid transparent;
      border-radius: var(--radius);
      color: var(--text);
      transition: border 0.2s;
      margin-bottom: 1rem;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    label {
      font-weight: 600;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      display: block;
    }

    button {
      background: var(--accent);
      color: #000;
      padding: 0.9rem 1.2rem;
      border: none;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: var(--accent-hover);
    }

    .secondary-button {
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent);
    }

    .secondary-button:hover {
      background: var(--accent);
      color: #000;
    }

    #auth-status {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #bbb;
    }

    #result img, #history img {
      max-width: 100%;
      border-radius: 12px;
      box-shadow: 0 0 16px rgba(0,0,0,0.5);
    }

    .prompt-text {
      background: #292733;
      padding: 1rem;
      border-radius: var(--radius);
      margin-top: 1rem;
      font-size: 0.95rem;
    }

    .card {
      background: #222028;
      padding: 1.2rem;
      border-radius: var(--radius);
      margin-bottom: 1.5rem;
    }

    .card p {
      margin: 0.5rem 0;
    }

    #logout-button {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      background: var(--logout);
      color: #1a1a1a;
    }

    #logout-button:hover {
      background: var(--logout-hover);
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚ú® AI Thumbnail Maker</h1>

    <div id="auth">
      <h2>Login or Sign up</h2>
      <label>Email</label>
      <input type="email" id="auth-email" placeholder="you@example.com" required />

      <label>Password</label>
      <input type="password" id="auth-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />

      <button onclick="login()">Log In</button>
      <button class="secondary-button" onclick="signup()">Sign Up</button>
      <p id="auth-status"></p>
    </div>

    <button id="logout-button" onclick="logout()" style="display: none;">Log Out</button>

    <form id="thumbnailForm" style="display: none;">
      <label for="title">Video Title</label>
      <input type="text" id="title" placeholder="e.g. How I Got 1M Views From Shorts" required />

      <label for="niche">Channel Niche</label>
      <input type="text" id="niche" placeholder="e.g. Education, Gaming, Vlogs" required />

      <div style="margin-top: 0rem;"><button type="submit">Generate Thumbnail</button></div>
    </form>

    <div id="result"></div>
    <button id="history-button" onclick="fetchHistory()" style="display: none;" class="secondary-button">Show My History</button>

    <div id="prompt-preview" style="display: none;">
      <label for="custom-prompt">Edit Prompt</label>
      <textarea id="custom-prompt" rows="4"></textarea>
      <button onclick="confirmPrompt()">Generate Thumbnail from This Prompt</button>
    </div>

    <div id="history" style="display: none;"></div>
  </div>
  <script>
    const SUPABASE_URL = "https://mjwjxxfnqbaroxwjewms.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qd2p4eGZucWJhcm94d2pld21zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQzNDg1NDQsImV4cCI6MjA1OTkyNDU0NH0.dYc-6m6gjpWlCD-qXYP5q_biO0Ai_CdpZMsPcPfD6Vk";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const form = document.getElementById('thumbnailForm');
    const resultDiv = document.getElementById('result');

    async function login() {
  const email = document.getElementById("auth-email").value;
  const password = document.getElementById("auth-password").value;

  const { data, error } = await supabaseClient.auth.signInWithPassword({
    email,
    password,
  });

  if (error) {
    document.getElementById("auth-status").innerText = "Login failed: " + error.message;
  } else {
    localStorage.setItem("supabase_token", data.session.access_token);
refreshUI(); // ‚úÖ instantly show the generator

  }
}

async function signup() {
  const email = document.getElementById("auth-email").value;
  const password = document.getElementById("auth-password").value;

  const { data, error } = await supabaseClient.auth.signUp({
    email,
    password,
  });

  if (error) {
    document.getElementById("auth-status").innerText = "Signup failed: " + error.message;
  } else {
    document.getElementById("auth-status").innerText = "Signup successful! Check your email.";
    refreshUI(); // ‚úÖ updates UI right after signup
  }
}

async function logout() {
  const { error } = await supabaseClient.auth.signOut();

  if (error) {
    console.error("Logout failed:", error.message);
    return;
  }

  document.getElementById("auth-status").innerText = "Logged out.";
  document.getElementById("auth").style.display = "block";
  document.getElementById("thumbnailForm").style.display = "none";
  document.getElementById("logout-button").style.display = "none";
}


function refreshUI() {
  document.getElementById("auth-status").innerText = "Logged in!";
  document.getElementById("auth").style.display = "none";
  document.getElementById("thumbnailForm").style.display = "block";
  document.getElementById("logout-button").style.display = "block";
  document.getElementById("history-button").style.display = "block"; // ‚úÖ Show history
}



    form.addEventListener('submit', async (e) => {
  e.preventDefault();
  resultDiv.innerHTML = "<p>üß† Generating prompt...</p>";

  const title = document.getElementById('title').value;
  const niche = document.getElementById('niche').value;

  try {
    const session = await supabaseClient.auth.getSession();
    const token = session.data.session?.access_token;

    if (!token) {
      resultDiv.innerHTML = '<p style="color:red;">Error: You must be logged in to generate thumbnails.</p>';
      return;
    }

    const res = await fetch("https://ai-thumbnail-maker.onrender.com/generate_prompt", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ title, niche })
    });

    const data = await res.json();

    if (data.prompt) {
      resultDiv.innerHTML = `<p><strong>‚úÖ Prompt Generated!</strong></p>`;
      document.getElementById("custom-prompt").value = data.prompt;
      document.getElementById("prompt-preview").style.display = "block";
    } else {
      resultDiv.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
    }

  } catch (err) {
    resultDiv.innerHTML = `<p style="color:red;">Request failed: ${err.message}</p>`;
  }
});


        // Check login state on page load
    window.addEventListener("DOMContentLoaded", async () => {
      const { data, error } = await supabaseClient.auth.getSession();

      if (error) {
        console.error("Error getting session:", error);
      }

      if (data.session) {
  document.getElementById("auth-status").innerText = "Logged in!";
  document.getElementById("auth").style.display = "none";
  document.getElementById("thumbnailForm").style.display = "block";
  document.getElementById("logout-button").style.display = "block"; // ‚úÖ Show logout
  document.getElementById("history-button").style.display = "block";
} else {
  document.getElementById("auth-status").innerText = "You are not logged in.";
  document.getElementById("auth").style.display = "block";
  document.getElementById("thumbnailForm").style.display = "none";
  document.getElementById("logout-button").style.display = "none"; // ‚úÖ Hide logout
  document.getElementById("history-button").style.display = "none";
  
}

    });


    async function fetchHistory() {
  const historyDiv = document.getElementById("history");
  const historyButton = document.getElementById("history-button");

  // üîÅ Toggle: if history is visible, hide it
  if (historyDiv.style.display === "block") {
    historyDiv.style.display = "none";
    historyButton.innerText = "Show My History";
    return;
  }

  // Else: show it and fetch
  historyDiv.style.display = "block";
  historyDiv.innerHTML = "<p>üì¶ Loading your thumbnail history...</p>";
  historyButton.innerText = "Hide History";

  try {
    const session = await supabaseClient.auth.getSession();
    const token = session.data.session?.access_token;

    if (!token) {
      historyDiv.innerHTML = '<p style="color:red;">You must be logged in to view history.</p>';
      return;
    }

    const res = await fetch("https://ai-thumbnail-maker.onrender.com/history", {
      method: "GET",
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });

    const data = await res.json();

    if (res.ok) {
      if (data.length === 0) {
        historyDiv.innerHTML = "<p>üï∏Ô∏è No thumbnails found yet.</p>";
        return;
      }

      const items = data.map(item => `
  <div style="margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #333;">
    <img src="${item.image_url}" style="max-width:100%; border-radius: 10px;" />
    <button onclick="downloadImage('${item.image_url}')" style="
  display: inline-block;
  margin-top: 0.6rem;
  margin-bottom: 1rem;
  padding: 0.5rem 1rem;
  background: #444;
  color: #fff;
  border-radius: 6px;
  border: none;
  font-size: 0.9rem;
  cursor: pointer;
">‚¨á Download</button>

    <p><strong>Prompt:</strong> ${item.prompt}</p>
    <p><strong>Title:</strong> ${item.title}</p>
    <p><strong>Niche:</strong> ${item.niche}</p>
  </div>
`).join("");


      historyDiv.innerHTML = `<div>${items}</div>`;
    } else {
      historyDiv.innerHTML = `<p style="color:red;">Error: ${data.error || 'Failed to fetch history.'}</p>`;
    }

  } catch (err) {
    historyDiv.innerHTML = `<p style="color:red;">Request failed: ${err.message}</p>`;
  }
}


async function confirmPrompt() {
  const prompt = document.getElementById("custom-prompt").value;
  const session = await supabaseClient.auth.getSession();
  const token = session.data.session?.access_token;

  if (!token) {
    resultDiv.innerHTML = '<p style="color:red;">Error: You must be logged in to generate thumbnails.</p>';
    return;
  }

  resultDiv.innerHTML = "<p>üé® Generating image...</p>";

  const title = document.getElementById("title").value;
  const niche = document.getElementById("niche").value;

  try {
    const res = await fetch("https://ai-thumbnail-maker.onrender.com/generate", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ title, niche, prompt }) // include prompt here!
    });

    const data = await res.json();

    if (data.image_url) {
      resultDiv.innerHTML = `
  <img src="${data.image_url}" alt="Generated Thumbnail" style="width: 100%; max-width: 100%; border-radius: 12px; box-shadow: 0 0 12px rgba(0,0,0,0.2); margin-top: 1rem;" />
  <button onclick="downloadImage('${data.image_url}')" style="
    display: inline-block;
    margin-top: 0.8rem;
    padding: 0.6rem 1.2rem;
    background: #444;
    color: #fff;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
  ">‚¨á Download</button>
  <div class="prompt-text"><strong>Prompt:</strong><br>${data.prompt}</div>
`;

      document.getElementById("prompt-preview").style.display = "none";
    } else {
      resultDiv.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
    }

  } catch (err) {
    resultDiv.innerHTML = `<p style="color:red;">Request failed: ${err.message}</p>`;
  }
}

function downloadImage(url) {
  fetch(url)
    .then(response => response.blob())
    .then(blob => {
      const blobUrl = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = blobUrl;
      link.download = "thumbnail.jpg"; // Optional: customize filename
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(blobUrl); // cleanup
    })
    .catch(err => {
      alert("Failed to download image: " + err.message);
    });
}



  </script>
</body>
</html>
