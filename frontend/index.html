<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <title>AI Thumbnail Maker for YouTube Creators | AI Thumbnail Copilot</title>
    <meta name="description" content="Generate viral YouTube thumbnails using AI with AI Thumbnail Copilot. Instantly create engaging thumbnails from your title and niche. No design skills needed." />
    <meta name="author" content="AI Thumbnail Copilot" /> <meta name="robots" content="index, follow" /> <meta property="og:title" content="AI Thumbnail Maker for YouTube Creators | AI Thumbnail Copilot" />
    <meta property="og:description" content="Instantly create stunning YouTube thumbnails with AI. Enter your title/niche, get ideas, generate!" />
    <meta property="og:url" content="https://ai-thumbnail-copilot.vercel.app" /> <meta property="og:site_name" content="AI Thumbnail Copilot" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://ai-thumbnail-copilot.vercel.app/og-image.jpg" /> <meta property="og:image:width" content="1200" /> <meta property="og:image:height" content="630" /> <meta name="twitter:card" content="summary_large_image" /> <meta name="twitter:title" content="AI Thumbnail Maker for YouTube Creators | AI Thumbnail Copilot" /> <meta name="twitter:description" content="Instantly create stunning YouTube thumbnails with AI. Enter your title/niche, get ideas, generate!" /> <meta name="twitter:image" content="https://ai-thumbnail-copilot.vercel.app/og-image.jpg" /> <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>

    <style>
      :root {
        --bg: #0e0d11;
        --surface: #1c1a23;
        --text: #f5f5f7;
        --accent: #a78bfa;
        --accent-hover: #c4b5fd; /* Lighter accent for hover/highlight */
        --input-bg: #2a2733;
        --logout: #fca5a5;
        --logout-hover: #f87171;
        --alt-tab: #22d3ee;
        --alt-tab-hover: #38bdf8;
        --radius: 16px;
        --tab-inactive: #2e2e38;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        font-family: 'Outfit', sans-serif;
        color: var(--text);
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }

      .tab-bar {
        display: flex;
        width: 100%;
        max-width: 820px;
        border-top-left-radius: var(--radius);
        border-top-right-radius: var(--radius);
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        overflow: hidden;
        box-shadow: 0 0 12px rgba(0,0,0,0.2);
      }

      .tab-button {
        flex: 1;
        padding: 1rem;
        font-weight: 600;
        font-size: 1rem;
        border: none; /* Remove default border */
        border-top: 3px solid transparent; /* Add space for active border */
        cursor: pointer;
        transition: background 0.2s, color 0.2s, border-color 0.2s;
        border-radius: 0;
        background: var(--tab-inactive); /* Default inactive background */
        color: #888; /* Default inactive color */
      }

      .tab-button.active {
        background: var(--accent); /* Active background */
        color: #000; /* Active text color */
        border-top: 3px solid var(--accent-hover); /* Modern top border highlight */
        z-index: 1;
      }

      .tab-button:not(.active):hover {
          background: #3a3843; /* Slightly lighter bg for inactive hover */
          color: #ccc;
      }

      .tab-button.secondary-tab::after {
        content: "Coming Soon";
        display: block;
        font-size: 0.7rem;
        margin-top: 0.2rem;
        color: #aaa; /* Adjusted color slightly */
      }

      .container {
        width: 100%;
        max-width: 820px;
        background: var(--surface);
        border-top-left-radius: 0;
        border-top-right-radius: 0;
        border-bottom-left-radius: var(--radius);
        border-bottom-right-radius: var(--radius);
        padding: 3rem 2rem;
        box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        position: relative;
        /* Adjusted margin for cleaner connection without thick bottom border */
        margin-top: -1px;
        z-index: 0; /* Ensure container is behind active tab's z-index */
      }

      h1 {
        font-size: 2.6rem;
        color: var(--accent);
        text-align: center;
        margin-bottom: 1.5rem;
        margin-top: 0; /* Keep this if you have it */
        padding-top: 2rem;
      }

      h2 {
        margin-top: 0; /* Adjusted margin */
      }

      input, textarea {
        width: 100%;
        padding: 1rem;
        font-size: 1rem;
        background: var(--input-bg);
        border: 1px solid transparent;
        border-radius: var(--radius);
        color: var(--text);
        transition: border 0.2s;
        margin-bottom: 1rem;
      }

      input:focus, textarea:focus {
        outline: none;
        border-color: var(--accent);
      }

      label {
        font-weight: 600;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        display: block;
      }

      button {
        background: var(--accent);
        color: #000;
        padding: 0.9rem 1.2rem;
        border: none;
        border-radius: var(--radius);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s, opacity 0.2s;
      }

      button:hover {
        background: var(--accent-hover);
      }

        button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: var(--accent); /* Keep background color but change opacity */
        }
        button:disabled:hover {
         background: var(--accent); /* Prevent hover effect when disabled */
        }


      .secondary-button {
        background: transparent;
        color: var(--accent);
        border: 1px solid var(--accent);
      }

      .secondary-button:hover {
        background: var(--accent);
        color: #000;
      }

      .secondary-button:disabled {
          opacity: 0.5;
          cursor: not-allowed;
          background: transparent; /* Keep background */
          color: var(--accent); /* Keep text color */
          border: 1px solid var(--accent);
       }
      .secondary-button:disabled:hover {
          background: transparent; /* Prevent hover background change */
          color: var(--accent); /* Prevent hover text color change */
      }

      /* NEW: Style for smaller purchase buttons */
      .buy-credits-button {
          padding: 0.6rem 1rem; /* Reduced padding */
          font-size: 0.9rem; /* Reduced font size */
          background: var(--alt-tab); 
          /* Inherits other button styles */
      }

      .buy-credits-button:hover {
    background: var(--alt-tab-hover); /* #38bdf8 - Lighter Cyan/Blue */
}

#purchase-section h2 {
  font-size: 1.4rem; /* Adjust this value as needed - default h2 is often larger */
  /* You might also want to adjust margin if needed */
  /* margin-bottom: 0.8rem; */ /* Example: reduce space below heading */
}


      #auth-status {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #bbb;
        min-height: 1.2em; /* Reserve space */
      }

      #result img, #history img {
        max-width: 100%;
        border-radius: 12px;
        box-shadow: 0 0 16px rgba(0,0,0,0.5);
        display: block; /* Ensure image is block for margin/spacing */
      }

      .prompt-text {
        background: #292733;
        padding: 1rem;
        border-radius: var(--radius);
        margin-top: 1rem;
        font-size: 0.95rem;
        line-height: 1.5; /* Improve readability */
        word-wrap: break-word;
      }

      .card {
        background: #222028;
        padding: 1.2rem;
        border-radius: var(--radius);
        margin-bottom: 1.5rem;
      }

      .card p {
        margin: 0.5rem 0;
        word-wrap: break-word;
      }
      .card p strong {
         color: var(--text); /* Ensure strong text is clearly visible */
      }

      #logout-button {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
        background: var(--logout);
        color: #1a1a1a;
        border-radius: calc(var(--radius) / 2); /* Slightly smaller radius */
      }

      #logout-button:hover {
        background: var(--logout-hover);
        color: white;
      }

      /* --- Style for credit display --- */
      .credits-display {
        position: absolute;
        top: 0.4rem;  /* Original top position */
        left: 1.5rem; /* Position from the left */
        font-size: 0.9rem;
        color: var(--accent);
        font-weight: 600;
        background-color: rgba(0,0,0, 0.2);
        padding: 0.3rem 0.6rem;
        border-radius: 8px;
        z-index: 10;
      }

      /* --- User Info (Email) Display Styling --- */
      .user-info-display {
        position: absolute;
        top: 2.2rem;  /* Original top position */
        left: 1.5rem; /* Position from the left */
        font-size: 0.85rem;
        color: #ccc;
        background-color: rgba(0,0,0, 0.2);
        padding: 0.3rem 0.6rem;
        border-radius: 8px;
        z-index: 10;
        max-width: calc(100% - 3rem); /* Adjust max-width */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* --- How It Works Section Styling --- */
      #how-it-works-section {
        width: 100%;
        max-width: 820px;
        margin: 3rem auto;
        padding: 2.5rem 2rem;
        background: var(--surface);
        border-radius: var(--radius);
        text-align: center;
        color: var(--text);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      }

      #how-it-works-section h2 {
        color: var(--accent);
        margin-top: 0;
        margin-bottom: 2.5rem;
        font-size: 1.8rem;
        font-weight: 700;
      }

      .steps-container {
        display: block;
        text-align: left;
      }

      .step-card {
        width: 100%;
        max-width: none;
        box-sizing: border-box;
        margin-bottom: 2rem;
        background: var(--input-bg);
        padding: 1.5rem;
        border-radius: calc(var(--radius) / 1.5);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
      }

      .step-card .step-number {
        font-size: 1.6rem;
        font-weight: 700;
        color: var(--accent);
        display: block;
        margin-bottom: 0.5rem;
        line-height: 1;
      }

      .step-card h3 {
        margin-top: 0;
        margin-bottom: 1rem;
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--text);
      }

      .step-card img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: block;
        border: 1px solid #444;
      }

      .step-card p {
        font-size: 1.05rem;
        color: #ccc;
        line-height: 1.6;
        margin-bottom: 0;
        flex-grow: 1;
      }

      #how-it-works-section button {
        margin-top: 2.5rem;
        padding: 0.9rem 1.5rem;
        background: var(--accent-hover);
        color: #000;
        border: none;
        border-radius: var(--radius);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s, transform 0.2s;
      }

      #how-it-works-section button:hover {
        opacity: 0.9;
        transform: translateY(-2px);
      }

      @media (max-width: 600px) {
        #how-it-works-section {
            padding: 2rem 1rem;
        }
        #how-it-works-section h2 {
            font-size: 1.6rem;
        }
        .step-card h3 {
            font-size: 1.2rem;
        }
        .step-card p {
            font-size: 1rem;
        }
      }

      /* Style for the link within the credit warning */
      #credit-warning a {
          color: var(--accent);
          text-decoration: underline;
          font-weight: bold;
          margin-left: 0.5em;
      }
      #credit-warning a:hover {
          color: var(--accent-hover);
      }

      /* Style for the horizontal rule separator (REMOVED as purchase section moved) */
      /* hr.section-separator { ... } */

    </style>
</head>
<body style="margin-top: 0;">

 <div class="tab-bar" style="margin-top: 2rem;">
    <button id="tab-prompt-gen" class="tab-button active">Prompt Image Gen</button>
    <button id="tab-png-dump" class="tab-button secondary-tab">PNG Dump</button>
 </div>

  <div class="container">
    <h1>✨ AI Thumbnail Copilot</h1>

    <div id="auth" style="display: none;">
        <h2>Login or Sign up</h2>
        <p id="signup-encouragement" style="color: var(--accent); text-align: center; margin-bottom: 1.5rem; font-size: 1.05rem;">
            ✨ New here? Sign up to get <strong>5 free credits</strong> and start creating amazing thumbnails! ✨
        </p>
        <label for="auth-email">Email</label>
        <input type="email" id="auth-email" placeholder="you@example.com" required />
        <label for="auth-password">Password</label>
        <input type="password" id="auth-password" placeholder="••••••••" required />
        <button onclick="login()">Log In</button>
        <button class="secondary-button" onclick="signup()">Sign Up</button>
        <p id="auth-status"></p>
    </div>

    <div id="main-app-content" style="display: none; width: 100%;">
        <button id="logout-button" onclick="logout()">Log Out</button>
        <div id="credits-container" class="credits-display" style="display: none;">
            Credits: <span id="credits-display">--</span>
        </div>
        <div id="user-info-display" class="user-info-display" style="display: none;">
            Logged in as: <span id="user-email-display"></span>
        </div>

        <div id="purchase-section" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--input-bg);">
            <h2>Buy More Credits</h2>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button class="buy-credits-button" data-price-id="price_1RGPLZFj9LYfI1R0bRYP2IJn">
                    Buy 50 Credits (€8.00) </button>
                </div>
            <p id="purchase-status" style="margin-top: 1rem; color: #bbb; min-height: 1.2em;"></p>
        </div>

        <div id="prompt-gen-tab-content" style="display: none; width: 100%;">
            <form id="thumbnailForm">
                <label for="title">Video Title</label>
                <input type="text" id="title" placeholder="e.g. How I Got 1M Views From Shorts" required />
                <label for="niche">Channel Niche</label>
                <input type="text" id="niche" placeholder="e.g. Education, Gaming, Vlogs" required />
                <div style="margin-top: 1.5rem;"><button type="submit" id="generate-prompt-button">Generate Prompt</button></div>
            </form>

            <div id="result" style="margin-top: 1.5rem;"></div>

            <div id="prompt-preview" style="display: none; margin-top: 1.5rem;">
                <label for="custom-prompt">Edit Prompt (Optional)</label>
                <textarea id="custom-prompt" rows="4"></textarea>
                <button onclick="confirmPrompt()" id="confirm-prompt-button" style="margin-top: 0.5rem;">Generate Thumbnail (Cost: 1 Credit)</button>
                <p id="credit-warning" style="color: orange; font-size: 0.9em; margin-top: 0.5em; display: none;"></p>
            </div>

            <button id="history-button" onclick="fetchHistory()" class="secondary-button" style="margin-top: 2rem;">Show My History</button>
            <div id="history" style="display: none; margin-top: 1rem;"></div>

            </div>

        <div id="png-dump-content" style="display: none; width: 100%; text-align: center;">
            <h2>PNG Dump</h2>
            <p>This section is coming soon!</p>
            <p style="color: #888;">(Content for the PNG Dump tab will go here)</p>
        </div>
    </div> </div> <div id="how-it-works-section" style="display: none;">
    <h2 style="color: var(--accent); margin-bottom: 2rem;">Create Thumbnails in 3 Easy Steps</h2>
    <div class="steps-container">
        <div class="step-card">
            <span class="step-number" style="font-size: 1.5rem; font-weight: bold; color: var(--accent);">1.</span>
            <h3 style="margin-top: 0.5rem; margin-bottom: 1rem;">Enter Video Details</h3>
            <img src="images/step1-input.png" alt="Screenshot of entering video title and niche">
            <p>Provide your video title and channel niche to give the AI context.</p>
        </div>
        <div class="step-card">
            <span class="step-number" style="font-size: 1.5rem; font-weight: bold; color: var(--accent);">2.</span>
            <h3 style="margin-top: 0.5rem; margin-bottom: 1rem;">Get Prompt Ideas</h3>
            <img src="images/step2-prompt.png" alt="Screenshot showing AI generated prompt">
            <p>Our AI suggests a visual prompt. You can edit it or use it as is.</p>
        </div>
        <div class="step-card">
            <span class="step-number" style="font-size: 1.5rem; font-weight: bold; color: var(--accent);">3.</span>
            <h3 style="margin-top: 0.5rem; margin-bottom: 1rem;">Generate Thumbnail</h3>
            <img src="images/step3-thumbnail.png" alt="Screenshot of a generated thumbnail">
            <p>Generate your unique, eye-catching thumbnail in seconds!</p>
        </div>
    </div>
    <button onclick="scrollToElement('auth')" style="margin-top: 2.5rem; background: var(--accent-hover); color: #000;">
        Sign Up Now & Get 5 Free Credits!
    </button>
</div>

 <script>
    // --- Configuration ---
    const SUPABASE_URL = "https://mjwjxxfnqbaroxwjewms.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qd2p4eGZucWJhcm94d2pld21zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQzNDg1NDQsImV4cCI6MjA1OTkyNDU0NH0.dYc-6m6gjpWlCD-qXYP5q_biO0Ai_CdpZMsPcPfD6Vk";
    const BACKEND_URL = "https://ai-thumbnail-maker.onrender.com";
    const STRIPE_PUBLISHABLE_KEY = "pk_live_51RGO3VFj9LYfI1R0cQJetymluTuFJypOZ50kEaYzTNuyldVzHAp44DzqZWasbk5mBd2Rw0x5dXW4zAJxnPsP7SKK00aGiig0wu";
    const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- Global state ---
    let currentSession = null;
    let currentUserCredits = null;

    // --- DOM Element References ---
    const form = document.getElementById('thumbnailForm');
    const resultDiv = document.getElementById('result');
    const authDiv = document.getElementById('auth');
    const authStatusP = document.getElementById('auth-status');
    const mainAppContentDiv = document.getElementById('main-app-content');
    const promptGenContentDiv = document.getElementById('prompt-gen-tab-content');
    const pngDumpContentDiv = document.getElementById('png-dump-content');
    const logoutButton = document.getElementById('logout-button');
    const historyButton = document.getElementById('history-button');
    const historyDiv = document.getElementById('history');
    const promptPreviewDiv = document.getElementById('prompt-preview');
    const creditsContainer = document.getElementById('credits-container');
    const creditsDisplaySpan = document.getElementById('credits-display');
    const generatePromptButton = document.getElementById('generate-prompt-button');
    const confirmPromptButton = document.getElementById('confirm-prompt-button');
    const creditWarningP = document.getElementById('credit-warning');
    const userInfoDisplayDiv = document.getElementById('user-info-display');
    const userEmailDisplaySpan = document.getElementById('user-email-display');
    const purchaseStatusP = document.getElementById('purchase-status');
    const purchaseSection = document.getElementById('purchase-section');

    // --- Purchase Button Event Listener ---
    if (purchaseSection) {
        purchaseSection.addEventListener('click', async (event) => {
            const button = event.target.closest('.buy-credits-button');
            if (button) {
                event.preventDefault();
                if (!currentSession) {
                    purchaseStatusP.innerText = "Please log in to purchase credits.";
                    return;
                }
                const priceId = button.dataset.priceId;
                if (!priceId) {
                     console.error("Buy button missing data-price-id attribute.");
                     purchaseStatusP.innerText = "Error: Purchase option misconfigured.";
                     return;
                }
                const originalButtonText = button.innerText;
                purchaseStatusP.innerText = "Processing...";
                button.disabled = true;
                button.innerText = "Redirecting...";
                try {
                    const token = currentSession.access_token;
                    const res = await fetch(`${BACKEND_URL}/create-checkout-session`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                        body: JSON.stringify({ priceId: priceId })
                    });
                    if (!res.ok) {
                        const errorData = await res.json().catch(() => ({ error: `Server error: ${res.status}` }));
                        throw new Error(errorData.error || `Failed to start purchase: ${res.status}`);
                    }
                    const data = await res.json();
                    if (data.url) {
                        window.location.href = data.url;
                    } else {
                        throw new Error("Could not get checkout URL.");
                    }
                } catch (err) {
                    console.error("Purchase initiation failed:", err);
                    purchaseStatusP.innerText = `Error: ${err.message}`;
                    button.disabled = false;
                    button.innerText = originalButtonText;
                }
            }
        });
    } else {
         console.warn("Purchase section not found.");
    }


    // --- Utility to update Credit UI and Button States ---
    function updateCreditState(credits) {
        currentUserCredits = credits; // Update global variable

        // Handle 'loading' state
        if (credits === 'loading') {
            creditsDisplaySpan.innerText = 'Loading...'; // Show loading text
            creditsContainer.style.display = 'block'; // Make container visible
            confirmPromptButton.disabled = true;
            creditWarningP.style.display = 'none'; // Hide warning while loading
            confirmPromptButton.innerText = "Generate Thumbnail (Loading Credits...)";
            return;
        }

        // Handle number or null
        if (credits !== null && credits >= 0) {
            creditsDisplaySpan.innerText = credits;
            creditsContainer.style.display = 'block';

            const hasEnoughCredits = credits > 0;
            confirmPromptButton.disabled = !hasEnoughCredits;

            if (!hasEnoughCredits) {
                // Show warning and add "Buy Credits" link
                creditWarningP.innerHTML = `You have 0 credits remaining. <a href="#" onclick="event.preventDefault(); scrollToElement('purchase-section');">Buy More Credits?</a>`;
                creditWarningP.style.display = 'block';
                confirmPromptButton.innerText = "Generate Thumbnail (0 Credits Left)";
            } else {
                // Hide warning when credits > 0
                creditWarningP.style.display = 'none';
                creditWarningP.innerHTML = ''; // Clear content
                confirmPromptButton.innerText = "Generate Thumbnail (Cost: 1 Credit)";
            }
        } else {
            // Hide credits if null or negative (error state or logged out)
            creditsContainer.style.display = 'none';
            creditsDisplaySpan.innerText = '--';
            confirmPromptButton.disabled = true;
            creditWarningP.style.display = 'none'; // Hide warning
            creditWarningP.innerHTML = ''; // Clear content
             if (!currentSession) { // Reset button text for logged out state
                 confirmPromptButton.innerText = "Generate Thumbnail (Cost: 1 Credit)";
             }
        }
    }

    // --- Function to Fetch User Credits ---
    async function fetchUserCredits() {
        if (!currentSession) {
            updateCreditState(null);
            return;
        }
        console.log("Fetching user credits...");
        updateCreditState('loading'); // Set UI to loading state

        try {
            const token = currentSession.access_token;
            const res = await fetch(`${BACKEND_URL}/get_profile`, {
                method: "GET",
                headers: { "Authorization": `Bearer ${token}` }
            });
            if (res.status === 401) {
                await logout(); return;
            }
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({ error: `Server error: ${res.status}` }));
                throw new Error(errorData.error || `Failed to fetch credits: ${res.status}`);
            }
            const data = await res.json();
            updateCreditState(data.credits); // Update UI with actual credits
        } catch (err) {
            console.error("Error fetching credits:", err);
            if(currentSession) {
                authStatusP.innerText = `Error loading credits. Try refreshing.`;
            }
            updateCreditState(null); // Reset credits on error
            if (err.message.includes("token") || err.message.includes("Authent")) {
                 await logout();
            }
        }
    }


    // --- Auth Functions ---
    async function login() {
        authStatusP.innerText = "Logging in...";
        const email = document.getElementById("auth-email").value;
        const password = document.getElementById("auth-password").value;
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) {
            authStatusP.innerText = "Login failed: " + error.message;
            updateCreditState(null);
        } else {
            authStatusP.innerText = "";
        }
    }

    async function signup() {
        authStatusP.innerText = "Signing up...";
        const email = document.getElementById("auth-email").value;
        const password = document.getElementById("auth-password").value;
        const { data, error } = await supabaseClient.auth.signUp({ email, password });
        if (error) {
            authStatusP.innerText = "Signup failed: " + error.message;
        } else {
            authStatusP.innerText = "Processing signup request. Please check your email for verification or try logging in if already registered.";
        }
    }

    async function logout() {
        console.log("--- Logout function called ---"); // Log when function starts
        try {
            const { error } = await supabaseClient.auth.signOut();
            if (error) {
                console.error("--- Supabase signOut error:", error.message); // Log Supabase specific error
            } else {
                console.log("--- Supabase signOut successful (callback pending) ---"); // Log success from Supabase call
            }
        } catch (e) {
             console.error("--- Error during logout function execution:", e); // Log any unexpected errors
        }
    }

    // --- Core View Update Logic ---
    function updateContentView() {
        const isLoggedIn = !!currentSession;
        const activeTabButton = document.querySelector('.tab-button.active');
        const activeTabId = activeTabButton ? activeTabButton.id : 'tab-prompt-gen';
        const howItWorksSection = document.getElementById('how-it-works-section');

        // Hide sections initially
        authDiv.style.display = 'none';
        mainAppContentDiv.style.display = 'none';
        promptGenContentDiv.style.display = 'none';
        pngDumpContentDiv.style.display = 'none';
        creditsContainer.style.display = 'none';
        userInfoDisplayDiv.style.display = 'none';
        if(howItWorksSection) howItWorksSection.style.display = 'none';

        // Reset common states
        resultDiv.innerHTML = "";
        historyDiv.style.display = "none";
        promptPreviewDiv.style.display = "none";
        if (historyButton) historyButton.innerText = "Show My History";

        if (isLoggedIn) {
            // Logged In View
            mainAppContentDiv.style.display = 'block';
            authDiv.style.display = 'none';
            if(howItWorksSection) howItWorksSection.style.display = 'none';
            authStatusP.innerText = "";

            // MOVED Purchase section logic here for correct placement
            if (purchaseSection) purchaseSection.style.display = 'block';


            if (activeTabId === 'tab-prompt-gen') {
                promptGenContentDiv.style.display = 'block';
            } else if (activeTabId === 'tab-png-dump') {
                 pngDumpContentDiv.style.display = 'block';
            }

            if (currentUserCredits === null) {
                updateCreditState('loading'); // Show loading initially
            } else {
                updateCreditState(currentUserCredits);
            }

            if (currentSession.user?.email) {
                userEmailDisplaySpan.innerText = currentSession.user.email;
                userInfoDisplayDiv.style.display = 'block';
            } else {
                userInfoDisplayDiv.style.display = 'none';
            }

        } else {
            // Logged Out View
            currentUserCredits = null;
            updateCreditState(null);
            userInfoDisplayDiv.style.display = 'none';
            mainAppContentDiv.style.display = 'none';
            if (purchaseSection) purchaseSection.style.display = 'none'; // Hide purchase section when logged out

            if (activeTabId === 'tab-prompt-gen') {
                authDiv.style.display = 'block';
                if(howItWorksSection) howItWorksSection.style.display = 'block';
                authStatusP.innerText = "Please log in to generate thumbnails.";
            } else if (activeTabId === 'tab-png-dump') {
                pngDumpContentDiv.style.display = 'block';
                if(howItWorksSection) howItWorksSection.style.display = 'none';
                authStatusP.innerText = "";
            }
        }
    }

    // --- Tab Switching ---
    function handleTabSwitch(button) {
         const tabButtons = document.querySelectorAll('.tab-button');
         tabButtons.forEach(btn => btn.classList.remove('active'));
         button.classList.add('active');
         updateContentView();
    }


    // --- API Call Logic ---
    // Generate Prompt (Step 1)
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentSession) {
             resultDiv.innerHTML = `<p style="color:orange;">Please log in first.</p>`; return;
        }
        resultDiv.innerHTML = "<p>🧠 Generating prompt...</p>";
        promptPreviewDiv.style.display = "none";
        generatePromptButton.disabled = true;
        const title = document.getElementById('title').value;
        const niche = document.getElementById('niche').value;
        try {
            const res = await fetch(`${BACKEND_URL}/generate_prompt`, {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title, niche })
             });
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({ error: `Server error: ${res.status}` }));
                throw new Error(errorData.error || `Server error: ${res.status}`);
            }
            const data = await res.json();
            if (data.prompt) {
                resultDiv.innerHTML = `<p><strong>✅ Prompt Generated!</strong> Review below.</p>`;
                document.getElementById("custom-prompt").value = data.prompt;
                promptPreviewDiv.style.display = "block";
                updateCreditState(currentUserCredits); // Re-check button state
            } else { throw new Error(data.error || 'Unknown error'); }
        } catch (err) {
            resultDiv.innerHTML = `<p style="color:red;">❌ Error: ${err.message}</p>`;
            if (err.message.includes("token") || err.message.includes("Unauthorized")) await logout();
        } finally { generatePromptButton.disabled = false; }
    });

    // Generate Image (Confirm Prompt - Step 2)
    async function confirmPrompt() {
        const prompt = document.getElementById("custom-prompt").value;
        if (!currentSession) { resultDiv.innerHTML = `<p style="color:orange;">Please log in first.</p>`; return; }
        if (currentUserCredits !== null && currentUserCredits <= 0) {
             // The warning with the link is already displayed by updateCreditState
             // resultDiv.innerHTML = `<p style="color:orange;">Insufficient credits.</p>`; // Keep this line? Optional.
             return;
        }
        resultDiv.innerHTML = "<p>🎨 Generating image... (costs 1 credit).</p>";
        promptPreviewDiv.style.display = "none";
        confirmPromptButton.disabled = true;
        confirmPromptButton.innerText = "Generating...";
        const title = document.getElementById("title").value;
        const niche = document.getElementById("niche").value;
        try {
            const token = currentSession.access_token;
            const res = await fetch(`${BACKEND_URL}/generate`, {
                method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                body: JSON.stringify({ title, niche, prompt })
            });
            const responseBody = await res.text();
            if (!res.ok) {
                let errorData; try { errorData = JSON.parse(responseBody); } catch { errorData = { error: `Server error: ${res.status}` }; }
                if (res.status === 403 && errorData.error?.includes("Insufficient credits")) throw new Error("Insufficient credits.");
                else if (res.status === 401) throw new Error("Authentication error.");
                throw new Error(errorData.error || `Server error: ${res.status}`);
            }
            const data = JSON.parse(responseBody);
            if (data.image_url) {
                resultDiv.innerHTML = `<h2>Generated Thumbnail:</h2><img src="${data.image_url}" alt="Generated Thumbnail" style="width: 100%; max-width: 100%; border-radius: 12px; box-shadow: 0 0 12px rgba(0,0,0,0.2); margin-top: 1rem;" /><button onclick="downloadImage('${data.image_url}', '${title || 'thumbnail'}')" style="margin-top: 1rem; margin-bottom: 1rem;">⬇ Download</button><div class="prompt-text"><strong>Final Prompt:</strong><br>${data.prompt || prompt}</div>`;
                if (data.new_credits !== undefined) updateCreditState(data.new_credits);
                else fetchUserCredits(); // Fallback
            } else { throw new Error(data.error || 'Unknown error'); }
        } catch (err) {
            resultDiv.innerHTML = `<p style="color:red;">❌ Failed: ${err.message}</p>`;
            promptPreviewDiv.style.display = "block"; // Show prompt edit again
            if (err.message.includes("Insufficient credits")) updateCreditState(0);
            else if (err.message.includes("Authentication")) await logout();
            else updateCreditState(currentUserCredits); // Re-enable button if credits > 0
        }
        // Button state/text handled by updateCreditState calls within try/catch
    }

    // --- History Fetch ---
    async function fetchHistory() {
         if (!currentSession) { historyDiv.innerHTML = `<p style="color:orange;">Log in to view history.</p>`; historyDiv.style.display = "block"; return; }
        if (historyDiv.style.display === "block") { historyDiv.style.display = "none"; historyButton.innerText = "Show My History"; return; }
        historyDiv.style.display = "block"; historyDiv.innerHTML = "<p>📦 Loading history...</p>"; historyButton.innerText = "Hide History"; historyButton.disabled = true;
        try {
            const token = currentSession.access_token;
            const res = await fetch(`${BACKEND_URL}/history`, { method: "GET", headers: { "Authorization": `Bearer ${token}` } });
            if (res.status === 401) throw new Error("Authentication error.");
            if (!res.ok) { const errorData = await res.json().catch(() => ({ error: `Server error: ${res.status}` })); throw new Error(errorData.error || `Server error: ${res.status}`); }
            const data = await res.json();
            if (data.length === 0) { historyDiv.innerHTML = "<h2>Your Past Thumbnails</h2><p>🕸️ No thumbnails found yet.</p>"; }
            else {
                 const items = data.map(item => `<div class="card" style="margin-bottom: 1.5rem;"><img src="${item.image_url}" alt="Generated thumbnail for ${item.title || 'untitled'}" style="max-width:100%; border-radius: 10px; display: block; margin-bottom: 1rem;" loading="lazy"/><button onclick="downloadImage('${item.image_url}', '${item.title || 'thumbnail'}')" class="secondary-button" style="padding: 0.5rem 1rem; font-size: 0.9rem; margin-bottom: 1rem;">⬇ Download</button><p><strong>Title:</strong> ${item.title || 'N/A'}</p><p><strong>Niche:</strong> ${item.niche || 'N/A'}</p><p style="font-size: 0.85em; color: #bbb;"><strong>Prompt:</strong> ${item.prompt}</p><p style="font-size: 0.75em; color: #888;">Generated: ${new Date(item.created_at).toLocaleString()}</p></div>`).join("");
                 historyDiv.innerHTML = `<h2>Your Past Thumbnails</h2>${items}`;
            }
        } catch (err) {
            historyDiv.innerHTML = `<p style="color:red;">❌ Error: ${err.message}</p>`; historyButton.innerText = "Show My History";
            if (err.message.includes("Authentication")) await logout();
        } finally { historyButton.disabled = false; }
    }

    // --- Download Image Utility ---
    function downloadImage(url, baseFilename = 'thumbnail') {
        const safeFilename = baseFilename.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'thumbnail';
        const filename = `${safeFilename}_${Date.now()}.jpg`;
        fetch(url)
         .then(response => { if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); return response.blob(); })
         .then(blob => {
             const blobUrl = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = blobUrl; link.download = filename;
             document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(blobUrl);
         })
         .catch(err => {
             console.error("Download failed:", err); let feedbackTarget = resultDiv;
             const historyCards = historyDiv.querySelectorAll('.card'); historyCards.forEach(card => { if (card.querySelector(`img[src="${url}"]`)) feedbackTarget = card.querySelector('img').parentNode; });
             if (!feedbackTarget.querySelector('.download-error-message')) {
                 const errorP = document.createElement('p'); errorP.className = 'download-error-message'; errorP.style.color = 'orange'; errorP.style.fontSize = '0.9em';
                 errorP.innerText = `Download failed. Right-click image > 'Save Image As...'. Error: ${err.message}`;
                 const downloadButton = feedbackTarget.querySelector('button'); if (downloadButton) downloadButton.parentNode.insertBefore(errorP, downloadButton.nextSibling); else feedbackTarget.appendChild(errorP);
             }
         });
    }

    // --- Scroll Utility ---
    function scrollToElement(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Optional highlight effect
            if (elementId === 'auth' || elementId === 'purchase-section') {
                element.style.transition = 'background-color 0.5s ease-in-out';
                element.style.backgroundColor = 'rgba(167, 139, 250, 0.1)';
                setTimeout(() => { element.style.backgroundColor = 'transparent'; }, 1500);
            }
        }
    }


    // --- Initialization and Auth State Change Listener ---
    document.addEventListener('DOMContentLoaded', () => {
        // Setup tab listeners
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => button.addEventListener('click', () => handleTabSwitch(button)));

        // Check for Stripe Redirect Status
        const urlParams = new URLSearchParams(window.location.search);
        const paymentStatus = urlParams.get('payment');
        const statusTargetElement = purchaseStatusP || authStatusP; // Use purchase P if exists

        if (paymentStatus === 'success') {
            if (statusTargetElement) { statusTargetElement.innerText = "Payment successful! Credits updating..."; statusTargetElement.style.color = 'lightgreen'; }
            setTimeout(() => { if (currentSession) fetchUserCredits(); }, 1000); // Refresh sooner
            setTimeout(() => { if (statusTargetElement && statusTargetElement.innerText.includes("Payment successful")) { statusTargetElement.innerText = ''; statusTargetElement.style.color = '#bbb'; } }, 5000); // Reset later
            if (window.history.replaceState) window.history.replaceState(null, '', window.location.pathname);
        } else if (paymentStatus === 'cancel') {
            if (statusTargetElement) { statusTargetElement.innerText = "Purchase cancelled."; statusTargetElement.style.color = 'orange'; }
            setTimeout(() => { if (statusTargetElement && statusTargetElement.innerText.includes("Purchase cancelled")) { statusTargetElement.innerText = ''; statusTargetElement.style.color = '#bbb'; } }, 5000);
            if (window.history.replaceState) window.history.replaceState(null, '', window.location.pathname);
        }
    });

    // Listen for auth state changes
    supabaseClient.auth.onAuthStateChange((event, session) => {
        console.log('--- Auth State Change Event Received ---:', event, session); // Log every event
        const sessionJustChanged = currentSession?.access_token !== session?.access_token;
        currentSession = session; // Update global session *first*

        // Determine if this specific event should trigger a UI update
        // Update on initial load, sign in, sign out, or if the session object actually changed
        const shouldUpdateUI = event === 'INITIAL_SESSION' || event === 'SIGNED_IN' || event === 'SIGNED_OUT' || sessionJustChanged;

        console.log(` ---> Session changed? ${sessionJustChanged}`);
        console.log(` ---> Event type: ${event}`);
        console.log(` ---> Should update UI based on event/change? ${shouldUpdateUI}`);

        if (shouldUpdateUI) {
             console.log(` ---> Calling updateContentView() due to event: ${event} or session change.`);
             updateContentView(); // Update visibility
             if (session) {
                 console.log(` ---> Session exists, calling fetchUserCredits()`);
                 fetchUserCredits(); // Fetch credits if logged in
             } else {
                 console.log(` ---> Session is null (logged out), calling updateCreditState(null)`);
                 updateCreditState(null); // Clear credits if logged out
             }
        } else if (event === "TOKEN_REFRESHED") {
             console.log(` ---> Token refreshed, calling fetchUserCredits()`);
             if (session) fetchUserCredits(); // Re-fetch credits on refresh
        } else {
             console.log(` ---> Event ${event} did not trigger UI update.`);
        }
    });

 </script>
</body>
</html>
