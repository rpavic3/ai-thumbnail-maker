<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AI Thumbnail Maker</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
      /* Keep existing styles */
      /* ... */

      /* Style for credit display */
      .credits-display {
        position: absolute;
        top: 2.2rem; /* Adjust vertical position */
        left: 1.5rem; /* Adjust horizontal position */
        font-size: 0.9rem;
        color: var(--accent);
        font-weight: 600;
        background-color: rgba(0,0,0, 0.2); /* Optional subtle background */
        padding: 0.3rem 0.6rem;
        border-radius: 8px;
      }
       #logout-button {
        /* Adjust logout button position if it clashes */
         top: 1.5rem;
         right: 1.5rem;
         /* ... rest of logout styles */
       }

    </style>
</head>
<body style="margin-top: 0;">
  <div class="tab-bar" style="margin-top: 2rem;">
    <button id="tab-prompt-gen" class="tab-button active">Prompt Image Gen</button>
    <button id="tab-png-dump" class="tab-button secondary-tab">PNG Dump</button>
  </div>

  <div class="container">
    <h1>✨ AI Thumbnail Maker</h1>

    <div id="auth" style="display: none;">
      <h2>Login or Sign up</h2>
      <label for="auth-email">Email</label>
      <input type="email" id="auth-email" placeholder="you@example.com" required />

      <label for="auth-password">Password</label>
      <input type="password" id="auth-password" placeholder="••••••••" required />

      <button onclick="login()">Log In</button>
      <button class="secondary-button" onclick="signup()">Sign Up</button>
      <p id="auth-status"></p>
    </div>

    <div id="main-app-content" style="display: none; width: 100%;">
        <button id="logout-button" onclick="logout()">Log Out</button>

        <div id="credits-container" class="credits-display" style="display: none;">
            Credits: <span id="credits-display">--</span>
        </div>

        <div id="prompt-gen-tab-content" style="display: none; width: 100%;">
            <form id="thumbnailForm">
                <label for="title">Video Title</label>
                <input type="text" id="title" placeholder="e.g. How I Got 1M Views From Shorts" required />

                <label for="niche">Channel Niche</label>
                <input type="text" id="niche" placeholder="e.g. Education, Gaming, Vlogs" required />

                <div style="margin-top: 1.5rem;"><button type="submit" id="generate-prompt-button">Generate Prompt</button></div>
            </form>

            <div id="result" style="margin-top: 1.5rem;"></div>

            <div id="prompt-preview" style="display: none; margin-top: 1.5rem;">
                <label for="custom-prompt">Edit Prompt (Optional)</label>
                <textarea id="custom-prompt" rows="4"></textarea>
                <button onclick="confirmPrompt()" id="confirm-prompt-button" style="margin-top: 0.5rem;">Generate Thumbnail (Cost: 1 Credit)</button>
                <p id="credit-warning" style="color: orange; font-size: 0.9em; margin-top: 0.5em; display: none;">You have 0 credits remaining.</p>
            </div>

            <button id="history-button" onclick="fetchHistory()" class="secondary-button" style="margin-top: 2rem;">Show My History</button>
            <div id="history" style="display: none; margin-top: 1rem;"></div>
        </div>
        </div>

    <div id="png-dump-content" style="display: none; width: 100%; text-align: center;">
        <h2>PNG Dump</h2>
        <p>This section is coming soon!</p>
        <p style="color: #888;">(Content for the PNG Dump tab will go here)</p>
    </div>
  </div>

 <script>
    // Supabase init (keep as is)
    const SUPABASE_URL = "https://mjwjxxfnqbaroxwjewms.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qd2p4eGZucWJhcm94d2pld21zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQzNDg1NDQsImV4cCI6MjA1OTkyNDU0NH0.dYc-6m6gjpWlCD-qXYP5q_biO0Ai_CdpZMsPcPfD6Vk"; // Use ANON key for frontend
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- Global state ---
    let currentSession = null;
    let currentUserCredits = null; // To store the fetched credits

    // --- Backend API URL ---
    const BACKEND_URL = "https://ai-thumbnail-maker.onrender.com"; // Your Render backend URL

    // --- DOM Element References ---
    const form = document.getElementById('thumbnailForm');
    const resultDiv = document.getElementById('result');
    const authDiv = document.getElementById('auth');
    const authStatusP = document.getElementById('auth-status');
    const mainAppContentDiv = document.getElementById('main-app-content');
    const promptGenContentDiv = document.getElementById('prompt-gen-tab-content');
    const pngDumpContentDiv = document.getElementById('png-dump-content');
    const logoutButton = document.getElementById('logout-button');
    const historyButton = document.getElementById('history-button');
    const historyDiv = document.getElementById('history');
    const promptPreviewDiv = document.getElementById('prompt-preview');
    const creditsContainer = document.getElementById('credits-container'); // Credit display container
    const creditsDisplaySpan = document.getElementById('credits-display'); // The actual number span
    const generatePromptButton = document.getElementById('generate-prompt-button');
    const confirmPromptButton = document.getElementById('confirm-prompt-button');
    const creditWarningP = document.getElementById('credit-warning'); // Warning message

    // --- Utility to update Credit UI and Button States ---
    function updateCreditState(credits) {
        currentUserCredits = credits; // Update global variable
        if (credits !== null && credits >= 0) {
            creditsDisplaySpan.innerText = credits;
            creditsContainer.style.display = 'block'; // Show credit display

            // Enable/disable buttons based on credits
            const hasEnoughCredits = credits > 0;
            // generatePromptButton.disabled = !hasEnoughCredits; // Decide if prompt gen costs credits too
            confirmPromptButton.disabled = !hasEnoughCredits;
            creditWarningP.style.display = hasEnoughCredits ? 'none' : 'block'; // Show/hide warning
            if (!hasEnoughCredits) {
                confirmPromptButton.innerText = "Generate Thumbnail (0 Credits Left)";
            } else {
                confirmPromptButton.innerText = "Generate Thumbnail (Cost: 1 Credit)";
            }

        } else {
            // Hide credits if null or negative (error state)
            creditsContainer.style.display = 'none';
            creditsDisplaySpan.innerText = '--';
            // Disable generation buttons if credits unknown or error
            // generatePromptButton.disabled = true;
            confirmPromptButton.disabled = true;
            creditWarningP.style.display = 'none';
            confirmPromptButton.innerText = "Generate Thumbnail (Checking Credits...)";

        }
    }

    // --- NEW Function to Fetch User Credits ---
    async function fetchUserCredits() {
        if (!currentSession) {
            console.log("Not logged in, cannot fetch credits.");
            updateCreditState(null); // Reset credit state
            return;
        }

        console.log("Fetching user credits...");
        try {
            const token = currentSession.access_token;
            const res = await fetch(`${BACKEND_URL}/get_profile`, {
                method: "GET",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (res.status === 401) { // Handle expired/invalid token explicitly
                console.warn("Token invalid/expired fetching credits. Logging out.");
                await logout(); // Force logout
                return; // Stop further processing
            }
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({ error: `Server error: ${res.status}` }));
                throw new Error(errorData.error || `Failed to fetch credits: ${res.status}`);
            }

            const data = await res.json();
            console.log("Credits fetched:", data.credits);
            updateCreditState(data.credits); // Update UI and state

        } catch (err) {
            console.error("Error fetching credits:", err);
            authStatusP.innerText = `Error loading credits: ${err.message}`; // Show error
            updateCreditState(null); // Reset credits on error
            if (err.message.includes("token")) { // If backend indicates token issue
                 await logout(); // Force logout
            }
        }
    }


    // --- Auth Functions (Modified) ---
    async function login() {
        authStatusP.innerText = "Logging in...";
        const email = document.getElementById("auth-email").value;
        const password = document.getElementById("auth-password").value;

        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

        if (error) {
            authStatusP.innerText = "Login failed: " + error.message;
            updateCreditState(null); // Reset credits on failed login
        } else {
            // currentSession = data.session; // Handled by onAuthStateChange
            // updateContentView(); // Handled by onAuthStateChange
            // fetchUserCredits(); // Handled by onAuthStateChange listener now
            authStatusP.innerText = ""; // Clear status immediately
        }
    }

    async function signup() {
        // Keep signup logic as is - profile/credits handled by Supabase trigger
        authStatusP.innerText = "Signing up...";
        const email = document.getElementById("auth-email").value;
        const password = document.getElementById("auth-password").value;

        const { data, error } = await supabaseClient.auth.signUp({ email, password });

        if (error) {
            authStatusP.innerText = "Signup failed: " + error.message;
        } else {
            authStatusP.innerText = "Signup successful! Check your email for verification.";
        }
    }

    async function logout() {
        // authStatusP.innerText = "Logging out..."; // Often not needed as view changes quickly
        const { error } = await supabaseClient.auth.signOut();
        // currentSession = null; // Handled by onAuthStateChange
        // updateContentView(); // Handled by onAuthStateChange
        // updateCreditState(null); // Handled by onAuthStateChange listener now

        if (error) {
            console.error("Logout failed:", error.message);
            // Show error in authStatusP if it becomes visible after logout
             if (document.getElementById('tab-prompt-gen').classList.contains('active')) {
                authStatusP.innerText = "Logout failed. Please try again.";
             }
        }
    }

    // --- Core View Update Logic (Modified) ---
    function updateContentView() {
        const isLoggedIn = !!currentSession;
        const activeTabButton = document.querySelector('.tab-button.active');
        const activeTabId = activeTabButton ? activeTabButton.id : 'tab-prompt-gen';

        // Hide everything first
        authDiv.style.display = 'none';
        mainAppContentDiv.style.display = 'none';
        promptGenContentDiv.style.display = 'none';
        pngDumpContentDiv.style.display = 'none';
        creditsContainer.style.display = 'none'; // Hide credits initially

        // Reset states
        resultDiv.innerHTML = "";
        historyDiv.style.display = "none";
        promptPreviewDiv.style.display = "none";
        if (historyButton) historyButton.innerText = "Show My History";


        if (isLoggedIn) {
            // LOGGED IN STATE
            mainAppContentDiv.style.display = 'block'; // Show wrapper (logout btn, credits)

            if (activeTabId === 'tab-prompt-gen') {
                promptGenContentDiv.style.display = 'block';
                // Credits will be shown by fetchUserCredits if successful
            } else if (activeTabId === 'tab-png-dump') {
                 // We only show the wrapper (for logout/credits), and the PNG dump content separately
                 pngDumpContentDiv.style.display = 'block'; // Show PNG content
                 // Keep promptGenContentDiv hidden
            }
            authStatusP.innerText = ""; // Clear any previous auth messages

            // Credits are fetched via onAuthStateChange or manually if needed
             if (currentUserCredits === null) { // Fetch if not already loaded
                fetchUserCredits();
             } else {
                updateCreditState(currentUserCredits); // Ensure UI reflects current known state
             }

        } else {
            // LOGGED OUT STATE
            currentUserCredits = null; // Clear credit state
            updateCreditState(null); // Ensure UI is reset

            if (activeTabId === 'tab-prompt-gen') {
                authDiv.style.display = 'block';
                authStatusP.innerText = "Please log in to generate thumbnails.";
            } else if (activeTabId === 'tab-png-dump') {
                pngDumpContentDiv.style.display = 'block';
                authStatusP.innerText = "";
            }
        }
    }

    // --- Tab Switching (keep as is) ---
    function handleTabSwitch(button) {
          const tabButtons = document.querySelectorAll('.tab-button');
          tabButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          updateContentView(); // This now handles showing the right content + credits
    }


    // --- Form Submission and API Call Logic (Modified) ---

    // Generate Prompt (Doesn't cost credits in this setup, but checks login)
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentSession) {
             resultDiv.innerHTML = `<p style="color:orange;">Please log in to generate prompts.</p>`;
             return;
        }
        // Optional: Check credits even for prompt generation if desired
        // if (currentUserCredits !== null && currentUserCredits <= 0) {
        //     resultDiv.innerHTML = `<p style="color:orange;">You need credits to generate prompts.</p>`;
        //     return;
        // }

        resultDiv.innerHTML = "<p>🧠 Generating prompt...</p>";
        promptPreviewDiv.style.display = "none"; // Hide confirm section

        const title = document.getElementById('title').value;
        const niche = document.getElementById('niche').value;

        try {
             // Use current session token if needed by backend for this endpoint
            // const token = currentSession.access_token;
            const res = await fetch(`${BACKEND_URL}/generate_prompt`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    // "Authorization": `Bearer ${token}` // Add if you secured /generate_prompt
                },
                body: JSON.stringify({ title, niche })
             });

            if (!res.ok) {
                const errorData = await res.json().catch(() => ({ error: `Server error: ${res.status}` }));
                throw new Error(errorData.error || `Server error: ${res.status}`);
            }
            const data = await res.json();

            if (data.prompt) {
                resultDiv.innerHTML = `<p><strong>✅ Prompt Generated!</strong> Review and confirm below.</p>`;
                document.getElementById("custom-prompt").value = data.prompt;
                promptPreviewDiv.style.display = "block";
                // Re-check credit state to ensure button enabled/disabled correctly
                updateCreditState(currentUserCredits);
            } else {
                throw new Error(data.error || 'Unknown error generating prompt');
            }
        } catch (err) {
            console.error("Prompt generation error:", err);
            resultDiv.innerHTML = `<p style="color:red;">❌ Error generating prompt: ${err.message}</p>`;
            // If the error was auth-related (e.g., if you added auth check)
             if (err.message.includes("token") || err.message.includes("Unauthorized")) {
                 await logout(); // Force logout if token issue detected
             }
        }
    });

    // Generate Image (Confirm Prompt - Costs 1 credit)
    async function confirmPrompt() {
        const prompt = document.getElementById("custom-prompt").value;
        if (!currentSession) {
             resultDiv.innerHTML = `<p style="color:orange;">Please log in to generate images.</p>`;
             return;
        }

        // *** Frontend Credit Check ***
        if (currentUserCredits !== null && currentUserCredits <= 0) {
             resultDiv.innerHTML = `<p style="color:orange;">Insufficient credits to generate image.</p>`;
             updateCreditState(0); // Ensure UI reflects 0 credits
             return;
        }

        resultDiv.innerHTML = "<p>🎨 Generating image... please wait (this costs 1 credit).</p>";
        promptPreviewDiv.style.display = "none"; // Hide confirm section during generation
        confirmPromptButton.disabled = true; // Disable button during processing
        confirmPromptButton.innerText = "Generating...";

        const title = document.getElementById("title").value;
        const niche = document.getElementById("niche").value;

        try {
            const token = currentSession.access_token;
            const res = await fetch(`${BACKEND_URL}/generate`, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                body: JSON.stringify({ title, niche, prompt })
            });

            const responseBody = await res.text(); // Read body once

            if (!res.ok) {
                let errorData;
                try {
                    errorData = JSON.parse(responseBody);
                } catch (parseError) {
                    errorData = { error: `Server error: ${res.status} ${res.statusText} - ${responseBody}` };
                }
                 // Check for specific 403 Insufficient Credits error from backend
                if (res.status === 403 && errorData.error?.includes("Insufficient credits")) {
                     throw new Error("Insufficient credits."); // Throw specific error
                } else if (res.status === 401) {
                     throw new Error("Authentication error. Please log in again.");
                }
                throw new Error(errorData.error || `Server error: ${res.status}`);
            }

            const data = JSON.parse(responseBody); // Parse success response

            if (data.image_url) {
                resultDiv.innerHTML = `
                 <h2>Generated Thumbnail:</h2>
                 <img src="${data.image_url}" alt="Generated Thumbnail" style="width: 100%; max-width: 100%; border-radius: 12px; box-shadow: 0 0 12px rgba(0,0,0,0.2); margin-top: 1rem;" />
                 <button onclick="downloadImage('${data.image_url}', '${title || 'thumbnail'}')" style="margin-top: 1rem; margin-bottom: 1rem;">⬇ Download</button>
                 <div class="prompt-text"><strong>Final Prompt Used:</strong><br>${data.prompt || prompt}</div>
                 `;
                // *** Update credits on successful generation ***
                if (data.new_credits !== undefined) {
                     updateCreditState(data.new_credits);
                     console.log(`✅ Image generated. Credits remaining: ${data.new_credits}`);
                } else {
                     console.warn("Backend did not return new credit count. Fetching manually.");
                     fetchUserCredits(); // Fallback to fetching credits again
                }
            } else {
                throw new Error(data.error || 'Unknown error generating image');
            }
        } catch (err) {
            console.error("Image generation error:", err);
            resultDiv.innerHTML = `<p style="color:red;">❌ Image Generation Failed: ${err.message}</p>`;
            promptPreviewDiv.style.display = "block"; // Show prompt edit again on failure

            // Handle specific errors
            if (err.message.includes("Insufficient credits")) {
                 updateCreditState(0); // Ensure UI shows 0 credits
                 resultDiv.innerHTML += `<p style="color:orange;">You have run out of credits.</p>`;
            } else if (err.message.includes("Authentication")) {
                await logout(); // Force logout if auth error
            } else {
                // For other errors, re-enable the button but reflect current credit state
                updateCreditState(currentUserCredits);
            }
        }
    }

    // --- History Fetch (Keep as is, but add auth error handling) ---
    async function fetchHistory() {
         if (!currentSession) {
             historyDiv.innerHTML = `<p style="color:orange;">Please log in to view history.</p>`;
             historyDiv.style.display = "block";
             return;
         }
        // Toggle display logic
        if (historyDiv.style.display === "block") {
             historyDiv.style.display = "none";
             historyButton.innerText = "Show My History";
             return;
        }

        historyDiv.style.display = "block";
        historyDiv.innerHTML = "<p>📦 Loading your thumbnail history...</p>";
        historyButton.innerText = "Hide History";

        try {
            const token = currentSession.access_token;
            const res = await fetch(`${BACKEND_URL}/history`, {
                method: "GET",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (res.status === 401) {
                throw new Error("Authentication error. Please log in again.");
            }
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({ error: `Server error: ${res.status}` }));
                throw new Error(errorData.error || `Server error fetching history: ${res.status}`);
            }
            const data = await res.json();

            if (data.length === 0) {
                historyDiv.innerHTML = "<h2>Your Past Thumbnails</h2><p>🕸️ No thumbnails found yet.</p>";
                return;
            }

            const items = data.map(item => `
                 <div class="card" style="margin-bottom: 1.5rem;">
                 <img src="${item.image_url}" alt="Generated thumbnail for ${item.title || 'untitled'}" style="max-width:100%; border-radius: 10px; display: block; margin-bottom: 1rem;" loading="lazy"/>
                 <button onclick="downloadImage('${item.image_url}', '${item.title || 'thumbnail'}')" class="secondary-button" style="padding: 0.5rem 1rem; font-size: 0.9rem; margin-bottom: 1rem;">⬇ Download</button>
                 <p><strong>Title:</strong> ${item.title || 'N/A'}</p>
                 <p><strong>Niche:</strong> ${item.niche || 'N/A'}</p>
                 <p style="font-size: 0.85em; color: #bbb;"><strong>Prompt:</strong> ${item.prompt}</p>
                 </div>
             `).join("");
            historyDiv.innerHTML = `<h2>Your Past Thumbnails</h2>${items}`;

        } catch (err) {
            console.error("History fetch error:", err);
            historyDiv.innerHTML = `<p style="color:red;">❌ Error fetching history: ${err.message}</p>`;
            historyButton.innerText = "Show My History"; // Reset button text on error
            if (err.message.includes("Authentication")) {
                 await logout(); // Force logout if auth error
            }
        }
    }

    // --- Download Image (Keep as is) ---
    function downloadImage(url, baseFilename = 'thumbnail') {
        const safeFilename = baseFilename.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'thumbnail';
        const filename = `${safeFilename}_${Date.now()}.jpg`; // Assuming jpg, adjust if needed

        fetch(url)
         .then(response => {
             if (!response.ok) throw new Error(`HTTP error fetching image! status: ${response.status}`);
             return response.blob();
         })
         .then(blob => {
             // Check blob type, maybe warn if not image/jpeg or image/png?
             // console.log("Blob type:", blob.type);
             const blobUrl = URL.createObjectURL(blob);
             const link = document.createElement("a");
             link.href = blobUrl;
             link.download = filename;
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
             URL.revokeObjectURL(blobUrl);
         })
         .catch(err => {
             console.error("Download failed:", err);
             // Try to provide user feedback directly near the image/button
             let feedbackTarget = resultDiv; // Default target
             // Try finding the specific card if in history
             const historyCards = historyDiv.querySelectorAll('.card');
             historyCards.forEach(card => {
                if (card.querySelector(`img[src="${url}"]`)) {
                    feedbackTarget = card;
                }
             });

             const errorP = document.createElement('p');
             errorP.style.color = 'orange';
             errorP.style.fontSize = '0.9em';
             errorP.innerText = `Could not download automatically. Please right-click the image and select 'Save Image As...'. Error: ${err.message}`;
             feedbackTarget.appendChild(errorP);

             // Fallback alert if feedback placement fails
             // alert("Failed to download image automatically. Please try right-clicking the image > 'Save Image As...'. Error: " + err.message);
         });
    }


    // --- Initialization and Auth State Change Listener (Modified) ---
    document.addEventListener('DOMContentLoaded', () => {
        // Setup tab listeners
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                handleTabSwitch(button);
            });
        });

         // Initial check for session is handled by onAuthStateChange firing on load
         // updateContentView(); // Let onAuthStateChange handle initial view setup
    });

    // Listen for auth state changes (login, logout, token refresh, initial load)
    supabaseClient.auth.onAuthStateChange((event, session) => {
        console.log('Auth State Change Event:', event, session);
        const sessionChanged = currentSession?.access_token !== session?.access_token;
        currentSession = session; // Update global session

        if (sessionChanged || event === 'INITIAL_SESSION') {
            updateContentView(); // Update UI based on new login state and active tab
            // If logged in, fetch/refresh credits
            if (session) {
                fetchUserCredits();
            } else {
                updateCreditState(null); // Clear credits when logged out
            }
        } else if (event === "TOKEN_REFRESHED") {
            // Token refreshed, maybe refetch credits just in case? Optional.
            // console.log("Token refreshed, maybe refetch credits?");
             if (session) fetchUserCredits();
        } else if (event === "SIGNED_OUT") {
             updateCreditState(null);
             updateContentView(); // Ensure view is updated after logout confirmation
        }
    });

 </script>
</body>
</html>