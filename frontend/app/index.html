<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AI Thumbnail Maker for YouTube Creators | AI Thumbnail Copilot</title>

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="description" content="Generate viral YouTube thumbnails using AI with AI Thumbnail Copilot. Instantly create engaging thumbnails from your title and niche. No design skills needed." />
    <meta name="author" content="AI Thumbnail Copilot" />
    <meta name="robots" content="index, follow" />
    <meta property="og:title" content="AI Thumbnail Maker for YouTube Creators | AI Thumbnail Copilot" />
    <meta property="og:description" content="Instantly create stunning YouTube thumbnails with AI. Enter your title/niche, get ideas, generate!" />
    <meta property="og:url" content="https://ai-thumbnail-copilot.vercel.app/" />
    <meta property="og:site_name" content="AI Thumbnail Copilot" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://ai-thumbnail-copilot.vercel.app/LOGO.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="AI Thumbnail Maker for YouTube Creators | AI Thumbnail Copilot" />
    <meta name="twitter:description" content="Instantly create stunning YouTube thumbnails with AI. Enter your title/niche, get ideas, generate!" />
    <meta name="twitter:image" content="https://ai-thumbnail-copilot.vercel.app/LOGO.png" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>

    <style>
     /* --- CSS Styles (Unchanged except for new .option-button styles) --- */
     :root {
         --bg: #0e0d11;
         --surface: #1c1a23;
         --text: #f5f5f7;
         --text-muted: #a0a0a0;
         --accent: #a78bfa; /* Primary accent (Violet) */
         --accent-hover: #c4b5fd; /* Lighter violet */
         --input-bg: #2a2733;
         --logout: #fca5a5; /* Light red for logout */
         --logout-hover: #f87171; /* Darker red */
         --buy-button: #34d399; /* Green for buy button */
         --buy-button-hover: #6ee7b7; /* Lighter green */
         --radius: 16px;
         --tab-inactive-bg: #2e2e38;
         --tab-inactive-text: #888;
         --tab-inactive-hover-bg: #3a3843;
         --tab-inactive-hover-text: #ccc;
         --card-bg: #222028;
         --border-color: #3a3843;
         --success-color: #34d399; /* Green */
         --warning-color: #fbbf24; /* Amber */
         --error-color: #f87171; /* Red */
         /* --- New variables for option buttons --- */
         --option-bg: #4a4a5a; /* Light gray */
         --option-bg-hover: #5a5a6a;
         --option-bg-active: #6a6a7a; /* Darker gray */
         --option-text: #e0e0e0;
     }

     * {
         box-sizing: border-box;
         margin: 0;
         padding: 0;
     }

     html {
         scroll-behavior: smooth;
     }

     body {
         background: var(--bg);
         font-family: 'Outfit', sans-serif;
         color: var(--text);
         display: flex;
         flex-direction: column;
         align-items: center;
         min-height: 100vh;
         padding: 1rem; /* Add padding around the body */
     }

     /* --- Main Container & Tabs --- */
     .tab-bar {
         display: flex;
         width: 100%;
         max-width: 820px;
         border-top-left-radius: var(--radius);
         border-top-right-radius: var(--radius);
         overflow: hidden;
         box-shadow: 0 2px 8px rgba(0,0,0,0.2);
         margin-top: 1rem; /* Reduced top margin */
     }

     .tab-button {
         flex: 1;
         padding: 1rem;
         font-weight: 600;
         font-size: 1rem;
         border: none;
         border-bottom: 3px solid transparent; /* Bottom border for active state */
         cursor: pointer;
         transition: background-color 0.2s, color 0.2s, border-color 0.2s;
         background: var(--tab-inactive-bg);
         color: var(--tab-inactive-text);
         text-align: center;
     }

     .tab-button.active {
         background: var(--surface); /* Match container background */
         color: var(--accent);
         border-bottom: 3px solid var(--accent);
         z-index: 1;
     }

     .tab-button:not(.active):hover {
          background: var(--tab-inactive-hover-bg);
          color: var(--tab-inactive-hover-text);
     }

     /* Style for disabled/coming soon tabs */
     .tab-button.secondary-tab {
          position: relative;
          color: #666; /* Darker grey */
          cursor: not-allowed;
          background: #222; /* Darker background */
     }
     .tab-button.secondary-tab::after {
          content: "Coming Soon";
          position: absolute;
          bottom: 5px;
          left: 50%;
          transform: translateX(-50%);
          font-size: 0.7rem;
          color: #555;
     }
     .tab-button.secondary-tab:hover {
          background: #222; /* No hover effect */
          color: #666;
     }


     .container {
         width: 100%;
         max-width: 820px;
         background: var(--surface);
         border-radius: var(--radius);
         padding: 2rem 1.5rem; /* Adjusted padding */
         box-shadow: 0 10px 30px rgba(0,0,0,0.3);
         display: flex;
         flex-direction: column;
         gap: 1.5rem;
         position: relative;
         margin-top: 0; /* Remove margin connecting to tabs */
         border: 1px solid var(--border-color); /* Optional border */
         border-top-left-radius: 0;  /* Connect to tabs */
         border-top-right-radius: 0; /* Connect to tabs */
     }

     /* --- Headings --- */
     h1 {
         font-size: clamp(1.8rem, 5vw, 2.6rem); /* Responsive font size */
         color: var(--accent);
         text-align: center;
         margin-bottom: 1rem;
         padding-top: 1rem; /* Reduced padding */
     }

     h2 {
         font-size: clamp(1.3rem, 4vw, 1.6rem);
         color: var(--text);
         margin-bottom: 1rem;
         border-bottom: 1px solid var(--border-color);
         padding-bottom: 0.5rem;
     }

     /* --- Forms & Inputs --- */
     label {
         font-weight: 600;
         margin-bottom: 0.5rem;
         display: block;
         font-size: 0.95rem;
         color: var(--text-muted);
     }

     input[type="email"],
     input[type="password"],
     input[type="text"],
     textarea {
         width: 100%;
         padding: 0.9rem 1rem;
         font-size: 1rem;
         background: var(--input-bg);
         border: 1px solid var(--border-color);
         border-radius: calc(var(--radius) / 2); /* Slightly smaller radius */
         color: var(--text);
         transition: border-color 0.2s, box-shadow 0.2s;
         margin-bottom: 1rem;
         font-family: inherit; /* Ensure consistent font */
     }

     input:focus, textarea:focus {
         outline: none;
         border-color: var(--accent);
         box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.3); /* Focus ring */
     }

     textarea {
         resize: vertical; /* Allow vertical resize */
         min-height: 80px;
     }

     /* --- Buttons --- */
     button {
         background: var(--accent);
         color: #0e0d11; /* Dark text on accent */
         padding: 0.8rem 1.2rem; /* Adjusted padding */
         border: none;
         border-radius: calc(var(--radius) / 2);
         font-size: 1rem;
         font-weight: 600;
         cursor: pointer;
         transition: background-color 0.2s, opacity 0.2s, transform 0.1s;
         display: inline-flex; /* Align icon and text */
         align-items: center;
         justify-content: center;
         gap: 0.5rem; /* Space between icon and text if needed */
     }

     button:hover {
         background: var(--accent-hover);
         transform: translateY(-1px); /* Subtle lift */
     }

     button:disabled {
         opacity: 0.6;
         cursor: not-allowed;
         background: var(--accent); /* Keep base color */
         transform: none; /* No lift when disabled */
     }
     button:disabled:hover {
          background: var(--accent); /* Prevent hover color change */
     }

     /* Secondary Button Style */
     .secondary-button {
         background: transparent;
         color: var(--accent);
         border: 1px solid var(--accent);
     }
     .secondary-button:hover {
         background: rgba(167, 139, 250, 0.1); /* Subtle background on hover */
         color: var(--accent-hover);
         border-color: var(--accent-hover);
     }
     .secondary-button:disabled {
          opacity: 0.5;
          cursor: not-allowed;
          background: transparent;
          color: var(--accent);
          border-color: var(--accent);
      }
     .secondary-button:disabled:hover {
          background: transparent;
          color: var(--accent);
          border-color: var(--accent);
      }

     /* Buy Credits Button Style (Base) */
     .buy-credits-button {
          background: var(--buy-button);
          color: var(--bg); /* Dark text on green */
     }
     .buy-credits-button:hover {
         background: var(--buy-button-hover);
     }

     /* Specific style for header buy button */
     .header-buy-button {
         padding: 0.4rem 0.8rem; /* Smaller padding */
         font-size: 0.85rem; /* Smaller font */
         margin-left: 0.5rem; /* Add some space from credits */
     }


     /* Logout Button Style */
     #logout-button {
         background: var(--logout);
         color: var(--bg); /* Dark text on red */
         padding: 0.5rem 0.8rem;
         font-size: 0.85rem;
     }
     #logout-button:hover {
         background: var(--logout-hover);
     }

     /* --- User Info & Status --- */
     /* Status message base style (used by auth and purchase) */
     #auth-status, #purchase-status {
         font-size: 0.9rem;
         color: var(--text-muted);
         min-height: 1.2em; /* Reserve space */
         text-align: center;
         margin-top: 0.5rem;
         width: 100%; /* Ensure it takes width in flex column */
     }
     #auth-status.error, #purchase-status.error { color: var(--error-color); }
     #auth-status.success, #purchase-status.success { color: var(--success-color); }
     #auth-status.warning, #purchase-status.warning { color: var(--warning-color); }

     /* Style for purchase status in header */
     .header-purchase-status {
         font-size: 0.8rem; /* Smaller font */
         margin-top: 0.3rem; /* Space below button */
         text-align: center; /* Center text */
         min-height: 1em; /* Reserve space */
         width: 100%; /* Take width within its flex item */
         margin-left: 0;
         margin-right: 0;
     }


     /* Adjusted user info container */
     .user-info-container {
         display: flex;
         flex-wrap: wrap; /* Allow wrapping on small screens */
         justify-content: space-between; /* Space out items */
         align-items: center; /* Vertically center items */
         gap: 1rem; /* Space between items */
         padding: 0.75rem 0; /* Adjusted padding */
         border-bottom: 1px solid var(--border-color);
         margin-bottom: 1.5rem;
     }

     .credits-display, .user-info-display {
         font-size: 0.9rem;
         color: var(--text-muted);
         background-color: rgba(0,0,0, 0.2);
         padding: 0.3rem 0.7rem;
         border-radius: calc(var(--radius) / 3);
         white-space: nowrap; /* Prevent wrapping */
         display: inline-flex; /* Use flex to align text */
         align-items: center;
     }
     .credits-display strong { color: var(--accent); font-weight: 700; }
     .user-info-display span { color: var(--text); font-weight: 600; }

     /* Wrapper for purchase controls in header */
     .purchase-controls {
         display: flex; /* Use flex for button and status */
         flex-direction: column; /* Stack button and status */
         align-items: center; /* Center items horizontally */
     }


     /* --- Results & History --- */
     #result h2 { /* Style for the heading above the grid */
          width: 100%;
          text-align: center;
          margin-bottom: 1.5rem;
          color: var(--accent);
          border-bottom: none; /* Remove border for this specific h2 */
          padding-bottom: 0;
     }
     #result {
         margin-top: 1.5rem;
         padding-top: 1.5rem;
         border-top: 1px solid var(--border-color);
     }

     .thumbnail-results-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(min(300px, 100%), 1fr));
          gap: 1.5rem;
          margin-top: 1rem;
          width: 100%;
     }

     .thumbnail-item {
          display: flex;
          flex-direction: column;
          align-items: center;
          background-color: var(--card-bg); /* Use card background */
          padding: 1rem;
          border-radius: var(--radius);
          border: 1px solid var(--border-color);
          box-shadow: 0 4px 10px rgba(0,0,0,0.2);
     }

     .thumbnail-item img {
          max-width: 100%;
          height: auto;
          aspect-ratio: 16 / 9; /* Maintain aspect ratio */
          object-fit: cover; /* Cover the area */
          border-radius: calc(var(--radius) / 2);
          margin-bottom: 1rem;
          background-color: #333; /* Placeholder bg */
          cursor: pointer; /* Indicate clickable for modal */
     }

     .thumbnail-item button {
          width: 100%; /* Make button full width */
          margin-top: auto; /* Push button to bottom if needed */
          padding: 0.6rem 1rem; /* Smaller padding */
          font-size: 0.9rem;
     }

     /* Prompt text display */
     .prompt-text {
         background: var(--input-bg);
         padding: 1rem;
         border-radius: calc(var(--radius) / 2);
         margin-top: 1.5rem; /* Space above */
         font-size: 0.9rem;
         line-height: 1.5;
         color: var(--text-muted);
         border: 1px solid var(--border-color);
         width: 100%; /* Take full width */
     }
     .prompt-text strong { color: var(--text); }


     /* History Card Styling */
     #history h2 {
          text-align: center;
          color: var(--accent);
          margin-bottom: 1.5rem;
     }
     #history .card {
         background: var(--card-bg);
         padding: 1rem; /* Slightly less padding */
         border-radius: var(--radius);
         margin-bottom: 1.5rem;
         border: 1px solid var(--border-color);
         box-shadow: 0 4px 10px rgba(0,0,0,0.2);
     }
     #history .card img {
          max-width: 100%;
          height: auto;
          aspect-ratio: 16 / 9;
          object-fit: cover;
          border-radius: calc(var(--radius) / 2);
          display: block;
          margin-bottom: 1rem;
          background-color: #333; /* Placeholder bg */
          cursor: pointer; /* Add cursor for modal */
     }
     #history .card p {
         margin: 0.4rem 0;
         font-size: 0.9rem;
         color: var(--text-muted);
         word-wrap: break-word; /* Allow long prompts/titles to wrap */
     }
     #history .card p strong {
          color: var(--text);
          font-weight: 600;
     }
     #history .card p:last-child { /* Style for timestamp */
          font-size: 0.75em;
          color: #888;
          margin-top: 0.8rem;
     }
     #history .card button { /* Style download button in history */
          padding: 0.5rem 1rem;
          font-size: 0.9rem;
          margin-bottom: 1rem;
          width: auto; /* Don't force full width */
     }
      /* Loading/Empty History Message */
      #history p:only-child {
           color: var(--text-muted);
           text-align: center;
           padding: 2rem 0;
           font-style: italic;
       }
      /* End of History Message */
      .no-more-history {
           text-align:center;
           color: var(--text-muted);
           margin-top:1rem;
           font-style: italic;
           font-size: 0.9em;
       }


     /* --- Other Sections (How-it-works) --- */
     #how-it-works-section {
         text-align: center;
         border-top: 1px solid var(--border-color);
         margin-top: 2rem; /* Restore margin */
         padding-top: 1.5rem; /* Restore padding */
         width: 100%;
     }
     #how-it-works-section h2 { color: var(--accent); border-bottom: none; margin-bottom: 2rem; }
     .steps-container { display: block; text-align: left; }
     .step-card {
         width: 100%;
         margin-bottom: 1.5rem;
         background: var(--input-bg);
         padding: 1.5rem;
         border-radius: var(--radius);
         border: 1px solid var(--border-color);
         box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
         display: flex;
         flex-direction: column;
     }
     .step-card .step-number { font-size: 1.5rem; font-weight: 700; color: var(--accent); margin-bottom: 0.5rem; }
     .step-card h3 { margin: 0 0 1rem 0; font-size: 1.2rem; font-weight: 600; color: var(--text); }
     .step-card img { max-width: 100%; height: auto; border-radius: calc(var(--radius) / 2); margin-bottom: 1rem; border: 1px solid var(--border-color); }
     .step-card p { font-size: 1rem; color: var(--text-muted); line-height: 1.6; margin-bottom: 0; }
     #how-it-works-section button { margin-top: 1.5rem; background: var(--accent-hover); color: var(--bg); }

     /* --- Utility & Feedback Styles --- */
     #credit-warning {
          color: var(--warning-color);
          font-size: 0.9em;
          margin-top: 0.8em;
          padding: 0.5rem;
          background-color: rgba(251, 191, 36, 0.1);
          border: 1px solid var(--warning-color);
          border-radius: calc(var(--radius) / 3);
          text-align: center;
     }
     #credit-warning a {
          color: var(--accent);
          text-decoration: underline;
          font-weight: bold;
          margin-left: 0.5em;
      }
     #credit-warning a:hover { color: var(--accent-hover); }

     .download-error-message {
          color: var(--warning-color);
          font-size: 0.85em;
          margin-top: 0.5rem;
     }

     /* --- Added for AI Badge & How-it-works Intro --- */
     .ai-badge { /* Renamed from openai-badge */
         font-size: 0.8rem;
         color: var(--text-muted);
         text-align: center;
         margin-top: 0.5rem; /* Adjust as needed */
         margin-bottom: 2rem; /* Space before How it Works */
     }
     .how-it-works-intro {
         font-size: 0.95rem;
         color: var(--text-muted);
         margin-bottom: 1.5rem; /* Space before the steps */
         text-align: center;
         max-width: 600px; /* Optional: constrain width */
         margin-left: auto; /* Center if max-width is set */
         margin-right: auto; /* Center if max-width is set */
     }

     /* --- NEW Styles for Prompt Option Buttons --- */
     #prompt-options-container {
         margin-top: 1rem; /* Space below niche input */
         margin-bottom: 1.5rem; /* Space above suggest button */
         display: flex;
         flex-wrap: wrap; /* Allow buttons to wrap */
         gap: 0.5rem; /* Space between buttons */
         align-items: center; /* Align items vertically */
     }
     #prompt-options-container label {
         margin-bottom: 0; /* Remove bottom margin for the label */
         margin-right: 0.5rem; /* Space after label */
         font-size: 0.95rem; /* Match other labels */
         color: var(--text-muted);
         font-weight: 600;
     }
     .option-button {
         padding: 0.4rem 0.8rem; /* Smaller padding */
         font-size: 0.85rem; /* Smaller font */
         background-color: var(--option-bg); /* Light gray */
         color: var(--option-text);
         border: 1px solid transparent; /* Add border for structure */
         border-radius: calc(var(--radius) / 2.5); /* Slightly smaller radius */
         cursor: pointer;
         transition: background-color 0.2s, border-color 0.2s, transform 0.1s;
         /* Override general button styles if needed */
         font-weight: normal;
         display: inline-flex; /* Keep inline-flex */
         align-items: center;
         justify-content: center;
         gap: 0; /* Remove gap */
     }
     .option-button:hover {
         background-color: var(--option-bg-hover);
         border-color: var(--border-color);
         transform: none; /* No lift on hover */
     }
     .option-button.active {
         background-color: var(--option-bg-active); /* Darker gray */
         border-color: var(--accent); /* Highlight border when active */
         color: var(--text);
         font-weight: 600; /* Make active text bolder */
         box-shadow: inset 0 1px 2px rgba(0,0,0,0.2); /* Subtle inner shadow */
     }
     /* --- End of New Styles --- */


     /* --- Responsive Adjustments --- */
     @media (max-width: 600px) {
          body { padding: 0.5rem; }
          .container { padding: 1.5rem 1rem; }
          h1 { padding-top: 1rem; }
          .tab-button { font-size: 0.9rem; padding: 0.8rem 0.5rem; }
          .tab-button.secondary-tab::after { font-size: 0.6rem; }

          /* Responsive header bar */
          .user-info-container {
               flex-direction: column; /* Stack items vertically */
               align-items: stretch; /* Stretch items full width */
               padding-bottom: 1rem; /* Add padding below */
          }
          .user-info-container > div, /* Target direct div children (includes wrapper and user-info) */
          .user-info-container > button#logout-button { /* Target logout button */
              text-align: center;
              width: 100%; /* Make items full width */
              margin-bottom: 0.5rem; /* Add space between stacked items */
          }
          .credits-display, .user-info-display {
              justify-content: center; /* Center text within display boxes */
          }
          .purchase-controls {
              width: auto;
              margin-bottom: 0;
              text-align: center; /* Keep center alignment */
          }
          #logout-button {
              order: 2; /* Move logout to the bottom */
              margin-top: 0.5rem; /* Add space above logout */
              margin-bottom: 0; /* Remove bottom margin */
              width: 100%; /* Ensure full width */
          }
          .header-buy-button {
              width: auto; /* Allow button to size naturally */
              margin-left: 0; /* Remove left margin */
          }
          /* Target the wrapper specifically for order */
          .user-info-container > div:has(#credits-container) { /* Target the wrapper */
             order: 1;
             align-items: center; /* Center content inside wrapper */
          }
          .user-info-display {
             order: 0; /* Ensure user info comes before wrapper */
          }


          button { padding: 0.8rem 1rem; font-size: 0.95rem; }

          #how-it-works-section { padding: 1.5rem 1rem; margin-top: 1rem; }
          #how-it-works-section h2 { font-size: 1.4rem; margin-bottom: 1.5rem;}
          .step-card h3 { font-size: 1.1rem; }
          .step-card p { font-size: 0.95rem; }

          /* Added for AI Badge & How-it-works Intro (Responsive) */
          .ai-badge {
              margin-bottom: 1.5rem; /* Adjust spacing */
          }
          .how-it-works-intro {
              margin-bottom: 1rem; /* Adjust spacing */
          }

          /* Responsive option buttons */
          #prompt-options-container {
              gap: 0.4rem; /* Slightly smaller gap */
          }
          .option-button {
              padding: 0.3rem 0.6rem;
              font-size: 0.8rem;
          }
     }

     /* --- simple image modal (added) --- */
     #img-modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;
          align-items:center;justify-content:center;z-index:9999}
     #img-modal img{max-width:90vw;max-height:90vh;border-radius:12px}

    </style>
</head>
<body>

 <div class="tab-bar">
     <button id="tab-prompt-gen" class="tab-button active">Image Generation</button>
     <button id="tab-png-dump" class="tab-button secondary-tab">Bulk Tools</button>
 </div>

 <div class="container">
     <h1>âœ¨ AI Thumbnail Copilot</h1>

     <div id="auth">
         <h2>Login or Sign up</h2>
         <p id="signup-encouragement" style="color: var(--accent); text-align: center; margin-bottom: 1.5rem; font-size: 1.05rem;">
              âœ¨ New here? Sign up to get <strong>10 free credits</strong> and start creating amazing thumbnails! âœ¨
         </p>
         <label for="auth-email">Email</label>
         <input type="email" id="auth-email" placeholder="you@example.com" required />
         <label for="auth-password">Password</label>
         <input type="password" id="auth-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required />
         <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
              <button onclick="login()" style="flex: 1;">Log In</button>
              <button class="secondary-button" onclick="signup()" style="flex: 1;">Sign Up</button>
         </div>
         <p id="auth-status"></p>
     </div>

     <div id="main-app-content" style="display: none; width: 100%;">

         <div class="user-info-container">
             <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.5rem;">
                 <div id="credits-container" class="credits-display" style="display: none;">
                     Credits: <strong id="credits-display">--</strong>
                 </div>
                 <div class="purchase-controls" style="display: none;">
                     <button class="buy-credits-button header-buy-button" data-price-id="price_1RIwfTFj9LYfI1R0gVPq3kRS"> Buy 50 Credits (â‚¬9.99) </button>
                     <p id="purchase-status" class="header-purchase-status"></p>
                 </div>
             </div>
             <div id="user-info-display" class="user-info-display" style="display: none;">
                 User: <span id="user-email-display"></span>
             </div>
             <button id="logout-button" onclick="logout()">Log Out</button>
         </div>

         <div id="prompt-gen-tab-content" style="display: none; width: 100%;">
             <form id="thumbnailForm">
                 <label for="title">Video Title</label>
                 <input type="text" id="title" placeholder="e.g. How I Got 1M Views From Shorts" required />
                 <label for="niche">Channel Niche / Video Topic</label>
                 <input type="text" id="niche" placeholder="e.g. Tech Reviews, Travel Vlogs, Cooking Tutorials" required />

                 <div id="prompt-options-container">
                    <label>Special requests:</label>
                    <button type="button" class="option-button">no text</button>
                    <button type="button" class="option-button">no humans</button>
                    <button type="button" class="option-button">cartoon style</button>
                    <button type="button" class="option-button">photorealistic</button>
                    <button type="button" class="option-button">pixel art</button>
                    <button type="button" class="option-button">3d render</button>
                    <button type="button" class="option-button">oil painting</button>
                    <button type="button" class="option-button">watercolor</button>
                    <button type="button" class="option-button">retro</button>
                    <button type="button" class="option-button">bright and cheerful</button>
                    <button type="button" class="option-button">dark and mysterious</button>
                 </div>
                 <div style="margin-top: 1rem; text-align: center;"> <button type="submit" id="generate-prompt-button">Suggest Prompt Idea</button>
                 </div>
             </form>

             <div id="prompt-preview" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                 <label for="custom-prompt">Edit AI Prompt Suggestion (or enter your own)</label>
                 <textarea id="custom-prompt" rows="4" placeholder="Describe the thumbnail you want the AI to create..."></textarea>
                 <button onclick="confirmPrompt()" id="confirm-prompt-button" style="margin-top: 0.5rem; width: 100%;">Generate 2 Thumbnails (Cost: 2 Credits)</button>
                 <p id="credit-warning" style="display: none;"></p>
             </div>

             <div id="result">
                 </div>

             <div style="margin-top: 2rem; text-align: center;">
                 <button id="history-button" onclick="fetchHistory()" class="secondary-button">Show My History</button>
             </div>

             <div id="history" style="display: none; margin-top: 1rem;">
                 </div>
             <div id="history-load-more-container" style="text-align: center; margin-top: 1rem; display: none;">
                 <button id="history-load-more-button" class="secondary-button">Load More History</button>
             </div>

         </div> <div id="png-dump-content" style="display: none; width: 100%; text-align: center; padding: 2rem 0;">
             <h2>Bulk Tools</h2>
             <p style="color: var(--text-muted);">This section is coming soon!</p>
             </div>

     </div> <p class="ai-badge">ðŸš€ Powered by advanced AI image generation</p>

     <div id="how-it-works-section">
         <h2>Create Thumbnails in 3 Easy Steps</h2>
         <p class="how-it-works-intro">
             Our AI utilizes state-of-the-art models, renowned for delivering stunningly creative and high-quality visual results.
         </p>
         <div class="steps-container">
             <div class="step-card">
                 <span class="step-number">1.</span>
                 <h3>Enter Video Details</h3>
                 <img src="images/step1-input.png" alt="Screenshot of entering video title and niche" onerror="this.style.display='none'">
                 <p>Provide your video title and niche/topic. Optionally, select special requests like style or content exclusions.</p> </div>
             <div class="step-card">
                 <span class="step-number">2.</span>
                 <h3>Get Prompt Ideas</h3>
                  <img src="images/step2-prompt.png" alt="Screenshot showing AI generated prompt" onerror="this.style.display='none'">
                 <p>Click "Suggest Prompt Idea". Our AI suggests a visual prompt based on your input and requests. You can edit it or write your own from scratch.</p> </div>
             <div class="step-card">
                 <span class="step-number">3.</span>
                 <h3>Generate Thumbnails</h3>
                  <img src="images/step3-thumbnail.png" alt="Screenshot of a generated thumbnail" onerror="this.style.display='none'">
                 <p>Click "Generate Thumbnails". The AI creates two unique, eye-catching options based on your final prompt!</p>
             </div>
         </div>
         <button onclick="scrollToElement('auth')">
              Sign Up Now & Get 10 Free Credits!
         </button>
     </div>

 </div> <div id="img-modal" onclick="this.style.display='none'">
     <img src="" alt="preview"/>
 </div>


 <script>
     // --- Configuration (Ensure these match your setup) ---
     const SUPABASE_URL = "https://mjwjxxfnqbaroxwjewms.supabase.co"; // Your Supabase URL
     const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qd2p4eGZucWJhcm94d2pld21zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQzNDg1NDQsImV4cCI6MjA1OTkyNDU0NH0.dYc-6m6gjpWlCD-qXYP5q_biO0Ai_CdpZMsPcPfD6Vk"; // Your Supabase Anon Key
     const BACKEND_URL = "https://ai-thumbnail-maker.onrender.com"; // Your Flask backend URL
     const STRIPE_PUBLISHABLE_KEY = "pk_live_51RGO3VFj9LYfI1R0cQJetymluTuFJypOZ50kEaYzTNuyldVzHAp44DzqZWasbk5mBd2Rw0x5dXW4zAJxnPsP7SKK00aGiig0wu"; // Your Stripe Publishable Key

     // --- Constants ---
     const NUM_IMAGES_EXPECTED = 2;
     const CREDIT_COST_PER_IMAGE = 1;
     const TOTAL_GENERATION_COST = NUM_IMAGES_EXPECTED * CREDIT_COST_PER_IMAGE;
     const HISTORY_ITEMS_PER_PAGE = 10;

     // --- Initialization ---
     let stripe = null;
     try {
          if (!STRIPE_PUBLISHABLE_KEY || STRIPE_PUBLISHABLE_KEY === "YOUR_STRIPE_PUBLISHABLE_KEY") {
              throw new Error("Stripe Publishable Key is not configured.");
          }
          stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
     } catch (e) {
          console.error("Stripe initialization failed:", e);
          const purchaseStatusElement = document.getElementById('purchase-status');
          if (purchaseStatusElement) {
               purchaseStatusElement.innerText = "Payment system error.";
               purchaseStatusElement.className = 'error header-purchase-status'; // Add header class
          }
          const buyButtons = document.querySelectorAll('.buy-credits-button');
          buyButtons.forEach(btn => btn.disabled = true);
     }
     const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

     // --- Global state ---
     let currentSession = null;
     let currentUserCredits = null;
     let currentHistoryPage = 1;
     let totalHistoryItems = 0;
     let isLoadingHistory = false;


     // --- DOM Element References ---
     const form = document.getElementById('thumbnailForm');
     const resultDiv = document.getElementById('result');
     const authDiv = document.getElementById('auth');
     const authStatusP = document.getElementById('auth-status');
     const mainAppContentDiv = document.getElementById('main-app-content');
     const promptGenContentDiv = document.getElementById('prompt-gen-tab-content');
     const pngDumpContentDiv = document.getElementById('png-dump-content');
     const logoutButton = document.getElementById('logout-button');
     const historyButton = document.getElementById('history-button');
     const historyDiv = document.getElementById('history');
     const promptPreviewDiv = document.getElementById('prompt-preview');
     const creditsContainer = document.getElementById('credits-container');
     const creditsDisplaySpan = document.getElementById('credits-display');
     const generatePromptButton = document.getElementById('generate-prompt-button');
     const confirmPromptButton = document.getElementById('confirm-prompt-button');
     const creditWarningP = document.getElementById('credit-warning');
     const userInfoDisplayDiv = document.getElementById('user-info-display');
     const userEmailDisplaySpan = document.getElementById('user-email-display');
     const purchaseStatusP = document.getElementById('purchase-status');
     const loadMoreContainer = document.getElementById('history-load-more-container');
     const loadMoreButton = document.getElementById('history-load-more-button');
     const howItWorksSection = document.getElementById('how-it-works-section');
     const purchaseControlsDiv = document.querySelector('.purchase-controls');
     const userInfoContainer = document.querySelector('.user-info-container'); // Reference user info header
     // --- NEW: Reference for options container ---
     const optionsContainer = document.getElementById('prompt-options-container');


     // --- Helper: Display Status Messages ---
     function showStatus(element, message, type = 'info', duration = 0) {
          if (!element) return;
          const isPurchaseStatus = element.id === 'purchase-status';
          element.innerText = message;
          element.className = type + (isPurchaseStatus ? ' header-purchase-status' : '');
          if (duration > 0) {
              setTimeout(() => {
                  if (element.innerText === message) {
                      element.innerText = '';
                      element.className = (isPurchaseStatus ? 'header-purchase-status' : '');
                  }
              }, duration);
          }
     }

     // --- Purchase Button Event Listener (Attached to user info container) ---
     if (userInfoContainer) {
          userInfoContainer.addEventListener('click', async (event) => {
              const button = event.target.closest('.buy-credits-button.header-buy-button');
              if (button && stripe) {
                  event.preventDefault();
                  if (!currentSession) {
                      showStatus(purchaseStatusP, "Please log in to purchase credits.", 'warning', 3000);
                      return;
                  }
                  const priceId = button.dataset.priceId;
                  if (!priceId || priceId === "YOUR_STRIPE_PRICE_ID_HERE") {
                       console.error("Buy button missing or has placeholder data-price-id attribute.");
                       showStatus(purchaseStatusP, "Error: Purchase option not configured.", 'error', 5000);
                       return;
                  }

                  const originalButtonText = button.innerText;
                  showStatus(purchaseStatusP, "Processing...", 'info');
                  button.disabled = true;
                  button.innerText = "Redirecting...";

                  try {
                      const token = currentSession.access_token;
                      const res = await fetch(`${BACKEND_URL}/create-checkout-session`, {
                          method: "POST",
                          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                          body: JSON.stringify({ priceId: priceId })
                      });

                      const responseBody = await res.text();
                      let data;
                      try { data = JSON.parse(responseBody); }
                      catch(e) { throw new Error(`Server returned invalid response (Status: ${res.status})`); }

                      if (!res.ok) { throw new Error(data.error || `Failed to start purchase (Status: ${res.status})`); }

                      if (data.url) {
                          window.location.href = data.url; // Redirect to Stripe
                      } else {
                          throw new Error("Could not get checkout URL from server.");
                      }
                  } catch (err) {
                      console.error("Purchase initiation failed:", err);
                      showStatus(purchaseStatusP, `Error: ${err.message}`, 'error', 5000);
                      button.disabled = false;
                      button.innerText = originalButtonText;
                      if (err.message.includes("Authent")) {
                           showStatus(authStatusP, "Authentication error. Please log in again.", 'error');
                           await logout();
                      }
                  }
              }
          });
     } else {
          console.warn("User info container not found in DOM for purchase listener.");
     }


     // --- Utility to update Credit UI and Button States ---
     function updateCreditState(credits) {
          currentUserCredits = credits;

          const creditsWrapper = creditsContainer ? creditsContainer.parentElement : null;

          if (credits === 'loading') {
                creditsDisplaySpan.innerText = '...';
                if (creditsContainer) creditsContainer.style.display = 'inline-flex';
                if (creditsWrapper && creditsWrapper !== userInfoContainer) creditsWrapper.style.display = 'flex';
            } else if (credits !== null && typeof credits === 'number' && credits >= 0) {
                creditsDisplaySpan.innerText = credits;
                if (creditsContainer) creditsContainer.style.display = 'inline-flex';
                if (creditsWrapper && creditsWrapper !== userInfoContainer) creditsWrapper.style.display = 'flex';
            } else {
                if (creditsContainer) creditsContainer.style.display = 'none';
                 if (creditsWrapper && creditsWrapper !== userInfoContainer) creditsWrapper.style.display = 'none';
                creditsDisplaySpan.innerText = '--';
            }

          const generateButtonEnabled = (credits !== null && typeof credits === 'number' && credits >= TOTAL_GENERATION_COST);
          confirmPromptButton.disabled = !generateButtonEnabled;
          confirmPromptButton.innerText = `Generate ${NUM_IMAGES_EXPECTED} Thumbnails (Cost: ${TOTAL_GENERATION_COST} Credits)`;

          if (credits !== null && typeof credits === 'number' && credits < TOTAL_GENERATION_COST) {
              const creditsTargetElement = creditsContainer.closest('.user-info-container > div') || creditsContainer;
              creditWarningP.innerHTML = `You need ${TOTAL_GENERATION_COST} credits (have ${credits}). <a href="#" onclick="event.preventDefault(); scrollToElement(creditsTargetElement.id || 'credits-container');">Buy More Credits?</a>`;
              creditWarningP.style.display = 'block';
          } else {
              creditWarningP.style.display = 'none';
              creditWarningP.innerHTML = '';
          }

           if (credits === null && !currentSession) {
                confirmPromptButton.innerText = `Generate ${NUM_IMAGES_EXPECTED} Thumbnails (Login Required)`;
                confirmPromptButton.disabled = true;
           } else if (credits === null && currentSession) {
                confirmPromptButton.innerText = `Generate ${NUM_IMAGES_EXPECTED} Thumbnails (Credit Error)`;
                confirmPromptButton.disabled = true;
           }
     }

     // --- Function to Fetch User Credits ---
     async function fetchUserCredits() {
          if (!currentSession) { updateCreditState(null); return; }
          console.log("Fetching user credits...");
          updateCreditState('loading');

          try {
              const token = currentSession.access_token;
              const res = await fetch(`${BACKEND_URL}/get_profile`, {
                  method: "GET", headers: { "Authorization": `Bearer ${token}` }
              });

              const responseBody = await res.text();
              let data;
              try { data = JSON.parse(responseBody); }
              catch(e) { throw new Error(`Server returned invalid response (Status: ${res.status})`); }

              if (!res.ok) {
                  if (res.status === 401) { console.warn("fetchUserCredits received 401, letting auth listener handle logout."); return; }
                  throw new Error(data.error || `Failed to fetch credits (Status: ${res.status})`);
              }
              updateCreditState(data.credits);
          } catch (err) {
              console.error("Error fetching credits:", err);
              if(currentSession) { showStatus(authStatusP, `Error loading credits: ${err.message}`, 'error'); }
              updateCreditState(null);
          }
     }


     // --- Auth Functions (Login, Signup, Logout) ---
     async function login() {
          showStatus(authStatusP, "Logging in...", 'info');
          const email = document.getElementById("auth-email").value;
          const password = document.getElementById("auth-password").value;
          try {
              const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
              if (error) { showStatus(authStatusP, `Login failed: ${error.message}`, 'error'); updateCreditState(null); }
              else { showStatus(authStatusP, ""); }
          } catch (e) { showStatus(authStatusP, `Login error: ${e.message}`, 'error'); updateCreditState(null); }
     }
     async function signup() {
          showStatus(authStatusP, "Signing up...", 'info');
          const email = document.getElementById("auth-email").value;
          const password = document.getElementById("auth-password").value;
           try {
              const { data, error } = await supabaseClient.auth.signUp({ email, password });
              if (error) {
                  console.error("Signup Error Object:", error);
                  if (error.message && error.message.toLowerCase().includes("user already registered")) { showStatus(authStatusP, "This email is already registered. Please log in.", 'warning'); }
                  else { showStatus(authStatusP, `Signup failed: ${error.message}`, 'error'); }
              } else if (data && data.user) {
                   console.log("Signup Data Object:", data);
                   if (data.user.identities && data.user.identities.length === 0) { showStatus(authStatusP, "Signup attempt processed. If this is your first time, check your email for verification. If you already have an account, please log in.", 'warning', 15000); }
                   else if (!data.session) { showStatus(authStatusP, "Signup successful! Please check your email for a verification link.", 'success', 10000); }
                   else if (data.session) { showStatus(authStatusP, "Signup successful! You can now log in.", 'success', 5000); }
                   else { showStatus(authStatusP, "Signup processed.", 'info', 5000); }
              } else {
                   console.warn("Signup returned no error and no user data:", data);
                   showStatus(authStatusP, "Signup status unclear. Please try logging in.", 'warning');
              }
          } catch (e) { showStatus(authStatusP, `Signup error: ${e.message}`, 'error'); }
     }
     async function logout() {
          console.log("--- Logout function called ---");
          showStatus(authStatusP, "Logging out...", 'info');
          try {
              const { error } = await supabaseClient.auth.signOut();
              if (error) {
                  console.error("--- Supabase signOut error:", error.message);
                   currentSession = null; updateContentView(); updateCreditState(null);
                   showStatus(authStatusP, "Logout may have failed, please refresh if needed.", 'warning');
              } else {
                  console.log("--- Supabase signOut successful (callback pending) ---");
                   if (currentSession !== null) {
                       console.warn("--- Forcing UI update after successful signOut call ---")
                       currentSession = null; updateContentView(); updateCreditState(null);
                   }
                   showStatus(authStatusP, "Logged out successfully.", 'success', 2000);
              }
          } catch (e) {
               console.error("--- Error during logout function execution:", e);
               currentSession = null; updateContentView(); updateCreditState(null);
               showStatus(authStatusP, "Error during logout, please refresh.", 'error');
          }
     }

     // --- Core View Update Logic ---
     function updateContentView() {
          const isLoggedIn = !!currentSession;
          const activeTabButton = document.querySelector('.tab-button.active');
          const activeTabId = activeTabButton ? activeTabButton.id : 'tab-prompt-gen';

          console.log(`Updating view. Logged in: ${isLoggedIn}, Active Tab: ${activeTabId}`);

          authDiv.style.display = isLoggedIn ? 'none' : 'block';
          mainAppContentDiv.style.display = isLoggedIn ? 'block' : 'none';

           const showHowItWorks = !isLoggedIn && activeTabId === 'tab-prompt-gen';
           if(howItWorksSection) howItWorksSection.style.display = showHowItWorks ? 'block' : 'none';
           const badge = document.querySelector('.ai-badge'); // Use updated class name
           if (badge) badge.style.display = 'block';

          showStatus(authStatusP, '');
          showStatus(purchaseStatusP, '');

          if (isLoggedIn) {
              // Logged In View
              authDiv.style.display = 'none';
              promptGenContentDiv.style.display = activeTabId === 'tab-prompt-gen' ? 'block' : 'none';
              pngDumpContentDiv.style.display = activeTabId === 'tab-png-dump' ? 'block' : 'none';

              if (purchaseControlsDiv) {
                   purchaseControlsDiv.style.display = 'flex';
                  const wrapper = purchaseControlsDiv.parentElement;
                  if(wrapper && wrapper !== userInfoContainer){ wrapper.style.display = 'flex'; }
              }

              if (currentSession.user?.email) {
                  userEmailDisplaySpan.innerText = currentSession.user.email;
                  userInfoDisplayDiv.style.display = 'inline-flex';
              } else { userInfoDisplayDiv.style.display = 'none'; }
              updateCreditState(currentUserCredits === null ? 'loading' : currentUserCredits);

              if (activeTabId === 'tab-prompt-gen' && historyDiv.style.display === "block") {
                   historyButton.innerText = "Hide History";
                   const currentlyLoadedCount = historyDiv.querySelectorAll('.card').length;
                   if (loadMoreContainer && currentlyLoadedCount > 0 && currentlyLoadedCount < totalHistoryItems) { loadMoreContainer.style.display = 'block'; }
              } else {
                   historyButton.innerText = "Show My History";
                   if (historyDiv.style.display === "block") {
                        historyDiv.style.display = "none";
                        if (loadMoreContainer) loadMoreContainer.style.display = 'none';
                   }
              }

          } else {
              // Logged Out View
              currentUserCredits = null; updateCreditState(null);
              userInfoDisplayDiv.style.display = 'none';
              if (purchaseControlsDiv) {
                   purchaseControlsDiv.style.display = 'none';
                   const wrapper = purchaseControlsDiv.parentElement;
                   if(wrapper && wrapper !== userInfoContainer){ wrapper.style.display = 'none'; }
              }

              if (activeTabId === 'tab-prompt-gen') {
                  authDiv.style.display = 'block';
                  document.getElementById("signup-encouragement").style.display = "block";
                   pngDumpContentDiv.style.display = 'none';
              } else {
                   authDiv.style.display = 'block';
                   pngDumpContentDiv.style.display = activeTabId === 'tab-png-dump' ? 'block' : 'none';
              }

              historyDiv.style.display = "none"; historyButton.innerText = "Show My History";
              currentHistoryPage = 1; totalHistoryItems = 0; historyDiv.innerHTML = "";
              isLoadingHistory = false; if(loadMoreContainer) loadMoreContainer.style.display = 'none';
              resultDiv.innerHTML = ""; promptPreviewDiv.style.display = "none";
          }
     }

     // --- Tab Switching ---
     function handleTabSwitch(button) {
           if (button.classList.contains('secondary-tab')) return;
           const tabButtons = document.querySelectorAll('.tab-button');
           tabButtons.forEach(btn => btn.classList.remove('active'));
           button.classList.add('active');
           updateContentView();
     }

     // --- NEW: Event Listener for Option Buttons ---
     if (optionsContainer) {
         optionsContainer.addEventListener('click', (event) => {
             // Check if the clicked element is an option button
             if (event.target.classList.contains('option-button')) {
                 // Toggle the 'active' class on the clicked button
                 event.target.classList.toggle('active');
             }
         });
     } else {
         console.warn("Prompt options container not found.");
     }


     // --- API Call Logic ---
     // Generate Prompt Suggestion (Step 1 - MODIFIED to send options)
     form.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!currentSession) { showStatus(authStatusP, "Please log in to get prompt suggestions.", 'warning', 3000); return; }
          resultDiv.innerHTML = "<p style='text-align:center;'>ðŸ§  Generating prompt idea...</p>";
          promptPreviewDiv.style.display = "none";
          generatePromptButton.disabled = true; generatePromptButton.innerText = "Generating...";
          const title = document.getElementById('title').value;
          const niche = document.getElementById('niche').value;

          // --- NEW: Get selected options ---
          const selectedOptionElements = optionsContainer ? optionsContainer.querySelectorAll('.option-button.active') : [];
          const selectedOptions = Array.from(selectedOptionElements).map(button => button.textContent.trim());
          console.log("Selected options:", selectedOptions); // Log selected options
          // --- End of New Options Logic ---

          try {
              // --- Send options in the request body ---
              const res = await fetch(`${BACKEND_URL}/generate_prompt`, {
                  method: "POST", headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ title, niche, options: selectedOptions }) // Add options here
              });
              // --- End of Fetch Modification ---

              const responseBody = await res.text(); let data;
              try { data = JSON.parse(responseBody); } catch(e) { throw new Error(`Server returned invalid response (Status: ${res.status})`); }
              if (!res.ok) { throw new Error(data.error || `Server error: ${res.status}`); }
              if (data.prompt) {
                  resultDiv.innerHTML = `<p style="color: var(--success-color); text-align: center;">âœ… Prompt suggestion generated!</p>`;
                  document.getElementById("custom-prompt").value = data.prompt;
                  promptPreviewDiv.style.display = "block";
                  updateCreditState(currentUserCredits); scrollToElement('prompt-preview');
              } else { throw new Error(data.error || 'AI did not return a prompt.'); }
          } catch (err) {
              console.error("Prompt Generation Error:", err);
              resultDiv.innerHTML = `<p style="color: var(--error-color); text-align: center;">âŒ Error Generating Prompt: ${err.message}</p>`;
          } finally { generatePromptButton.disabled = false; generatePromptButton.innerText = "Suggest Prompt Idea"; }
     });

     // --- Image Preview Modal Helper ---
     function showModal(src){
          const modal=document.getElementById('img-modal');
          if (!modal || !modal.querySelector('img')) return; // Add safety check
          modal.querySelector('img').src=src;
          modal.style.display='flex';
     }


     // Generate Thumbnails (Step 2 - Confirm Prompt - Unchanged)
     async function confirmPrompt() {
          const prompt = document.getElementById("custom-prompt").value;
          if (!prompt.trim()) { showStatus(creditWarningP, "Please enter a prompt describing the thumbnail.", 'warning', 3000); scrollToElement('custom-prompt'); return; }
          if (!currentSession) { showStatus(authStatusP, "Please log in to generate thumbnails.", 'warning', 3000); scrollToElement('auth'); return; }
           const creditsTargetElement = creditsContainer.closest('.user-info-container > div') || creditsContainer;
           if (currentUserCredits === null || currentUserCredits < TOTAL_GENERATION_COST) { scrollToElement(creditsTargetElement.id || 'credits-container'); return; }

          resultDiv.innerHTML = `<p style="text-align: center;">ðŸŽ¨ Generating ${NUM_IMAGES_EXPECTED} thumbnails... (Cost: ${TOTAL_GENERATION_COST} credits). It can take up to a minute. Please wait.</p>`;
          promptPreviewDiv.style.display = "none";
          confirmPromptButton.disabled = true; confirmPromptButton.innerText = "Generating...";
          const title = document.getElementById("title").value;
          const niche = document.getElementById("niche").value;
          try {
              const token = currentSession.access_token;
              const res = await fetch(`${BACKEND_URL}/generate`, {
                  method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                  body: JSON.stringify({ title, niche, prompt }) // Sends the final prompt from textarea
              });
              const responseBody = await res.text(); let data;
              try { data = JSON.parse(responseBody); } catch (e) { throw new Error(`Server returned non-JSON response (Status: ${res.status})`); }
              if (!res.ok) {
                  if (res.status === 401) throw new Error("Authentication error.");
                  if (res.status === 403 && data.error?.includes("Insufficient credits")) throw new Error(data.error);
                  if (res.status === 0) { throw new Error("NetworkError when attempting to fetch resource."); }
                  throw new Error(data.error || `Server error: ${res.status}`);
              }
              if (data.image_urls && Array.isArray(data.image_urls) && data.image_urls.length > 0) {
                  resultDiv.innerHTML = `<h2>Generated Thumbnails:</h2>`;
                  const gridDiv = document.createElement('div'); gridDiv.className = 'thumbnail-results-grid';
                  let displayedImages = 0;
                  data.image_urls.forEach((imageUrl, index) => {
                      // Check if imageUrl is a valid Data URI
                      if (imageUrl && imageUrl.startsWith('data:image')) {
                           displayedImages++;
                           const itemDiv = document.createElement('div'); itemDiv.className = 'thumbnail-item';
                           const img = document.createElement('img'); img.src = imageUrl; img.alt = `Generated Thumbnail Option ${index + 1}`;
                           img.onclick = () => showModal(imageUrl); // Add modal click handler
                           img.onerror = () => { img.alt = 'Error loading image'; }
                           const button = document.createElement('button');
                           const downloadFilename = `${title || 'thumbnail'}_${index + 1}`;
                           button.innerText = `â¬‡ Download Option ${index + 1}`;
                           button.onclick = () => downloadImage(imageUrl, downloadFilename);
                           itemDiv.appendChild(img); itemDiv.appendChild(button);
                           gridDiv.appendChild(itemDiv);
                      } else {
                           console.warn(`Received invalid image URL at index ${index}:`, imageUrl);
                           const itemDiv = document.createElement('div'); itemDiv.className = 'thumbnail-item';
                           itemDiv.innerHTML = `<p style="color:var(--warning-color); text-align: center; padding: 2rem 0;">âš ï¸ Image ${index + 1} failed.</p>`;
                           gridDiv.appendChild(itemDiv);
                      }
                  });
                  resultDiv.appendChild(gridDiv);
                  // Display the original prompt used for generation in the UI
                  resultDiv.insertAdjacentHTML('beforeend', `<div class="prompt-text"><strong>Prompt Used:</strong><br>${data.prompt || prompt}</div>`);
                  scrollToElement('result');
                  if (data.new_credits !== undefined) { updateCreditState(data.new_credits); }
                  else { fetchUserCredits(); }
                  promptPreviewDiv.style.display = "block";
                  if (displayedImages < NUM_IMAGES_EXPECTED) { showStatus(resultDiv, `Generated ${displayedImages}/${NUM_IMAGES_EXPECTED} images successfully.`, 'warning', 5000); }
              } else { throw new Error('Received invalid image data from server.'); }
          } catch (err) {
              console.error("Image Generation Error:", err);
              resultDiv.innerHTML = `<p style="color:var(--error-color); text-align: center;">âŒ Generation Failed: ${err.message}</p>`;
              promptPreviewDiv.style.display = "block";
              if (err.message.includes("Insufficient credits")) { await fetchUserCredits(); scrollToElement(creditsTargetElement.id || 'credits-container'); }
              else if (err.message.includes("Authent")) { await logout(); }
              else { updateCreditState(currentUserCredits); }
          } finally { confirmPromptButton.disabled = false; updateCreditState(currentUserCredits); }
     }


     // --- History Fetch ---
     async function fetchHistory(loadMore = false) {
          if (isLoadingHistory && loadMore) return;
          if (!currentSession) { showStatus(authStatusP, "Log in to view history.", 'warning', 3000); historyDiv.style.display = "none"; if (loadMoreContainer) loadMoreContainer.style.display = 'none'; return; }
          if (!loadMore) {
              if (historyDiv.style.display === "block") { historyDiv.style.display = "none"; historyButton.innerText = "Show My History"; if (loadMoreContainer) loadMoreContainer.style.display = 'none'; return; }
              else { currentHistoryPage = 1; totalHistoryItems = 0; historyDiv.innerHTML = "<p>ðŸ“¦ Loading history...</p>"; historyDiv.style.display = "block"; historyButton.innerText = "Fetching..."; if (loadMoreContainer) loadMoreContainer.style.display = 'none'; }
          } else { if (loadMoreButton) { loadMoreButton.disabled = true; loadMoreButton.innerText = "Loading..."; } }
          isLoadingHistory = true; historyButton.disabled = true;
          try {
              const token = currentSession.access_token;
              const fetchUrl = `${BACKEND_URL}/history?page=${currentHistoryPage}&limit=${HISTORY_ITEMS_PER_PAGE}`;
              const res = await fetch(fetchUrl, { method: "GET", headers: { "Authorization": `Bearer ${token}` } });
              const responseBody = await res.text(); let data;
              try { data = JSON.parse(responseBody); } catch(e) { throw new Error(`Server returned invalid history response (Status: ${res.status})`); }
              if (res.status === 401) throw new Error("Authentication error.");
              if (!res.ok) { throw new Error(data.error || `Server error fetching history: ${res.status}`); }
              const items = data.items || []; totalHistoryItems = data.total || 0;
              if (currentHistoryPage === 1) {
                  historyDiv.innerHTML = "";
                  if (items.length === 0 && totalHistoryItems === 0) { historyDiv.innerHTML = "<h2>History</h2><p>ðŸ•¸ï¸ No thumbnails generated yet.</p>"; }
                  else if (items.length > 0 || totalHistoryItems > 0) { historyDiv.innerHTML = `<h2>History (${totalHistoryItems} total)</h2>`; }
              }
              const itemsHtml = items.map(item => {
                  const displayImageUrl = item.preview_image_url || item.image_url || '';
                  const fullImageUrl = item.image_url; // Full res for modal and download
                  const showDownload = fullImageUrl && fullImageUrl.startsWith('data:image');
                  const generatedDate = item.created_at ? new Date(item.created_at).toLocaleString() : 'N/A';
                  const maxPromptLength = 100;
                  const displayPrompt = (item.prompt && item.prompt.length > maxPromptLength) ? item.prompt.substring(0, maxPromptLength) + '...' : (item.prompt || 'N/A');
                  // Add onclick to history image for modal
                  return `
                  <div class="card">
                       ${displayImageUrl ? `<img src="${displayImageUrl}" alt="Thumbnail for ${item.title || 'untitled'}" loading="lazy" onclick="showModal('${fullImageUrl || displayImageUrl}')"/>` : '<p style="text-align:center; color:var(--warning-color); padding: 1rem 0;">âš ï¸ Image data unavailable</p>'}
                       ${showDownload ? `<button onclick="downloadImage('${fullImageUrl}', '${item.title || 'thumbnail'}')" class="secondary-button">â¬‡ Download</button>` : ''}
                       <p><strong>Title:</strong> ${item.title || 'N/A'}</p>
                       <p><strong>Niche:</strong> ${item.niche || 'N/A'}</p>
                       <p title="${item.prompt || ''}"><strong>Prompt:</strong> ${displayPrompt}</p>
                       <p>Generated: ${generatedDate}</p>
                  </div>`;
              }).join("");
              historyDiv.insertAdjacentHTML('beforeend', itemsHtml);
              const currentlyLoadedCount = historyDiv.querySelectorAll('.card').length;
              if (loadMoreContainer) {
                  if (items.length > 0 && currentlyLoadedCount < totalHistoryItems) {
                      loadMoreContainer.style.display = 'block';
                      if (loadMoreButton) { loadMoreButton.disabled = false; loadMoreButton.innerText = "Load More History"; }
                      currentHistoryPage++;
                  } else {
                      loadMoreContainer.style.display = 'none';
                      if (currentlyLoadedCount > 0 && currentHistoryPage > 1 && currentlyLoadedCount >= totalHistoryItems) {
                           if (!historyDiv.querySelector('.no-more-history')) { historyDiv.insertAdjacentHTML('beforeend', '<p class="no-more-history">-- End of History --</p>'); }
                      }
                  }
              }
          } catch (err) {
              console.error("Error fetching history:", err);
              if (currentHistoryPage === 1) { historyDiv.innerHTML = `<p style="color:var(--error-color);">âŒ Error fetching history: ${err.message}</p>`; historyDiv.style.display = "block"; }
              else {
                   if (loadMoreButton) {
                       loadMoreButton.disabled = false; loadMoreButton.innerText = "Load More History";
                       const errorP = loadMoreContainer.querySelector('.load-more-error') || document.createElement('p');
                       errorP.className = 'load-more-error error'; errorP.style.color = 'var(--error-color)';
                       errorP.textContent = `Failed to load more: ${err.message}`;
                       if (!errorP.parentNode) loadMoreContainer.appendChild(errorP);
                       setTimeout(() => { if (errorP.parentNode) errorP.remove(); }, 4000);
                   }
              }
              if (err.message.includes("Authent")) await logout();
          } finally {
              isLoadingHistory = false; historyButton.disabled = false;
              historyButton.innerText = historyDiv.style.display === "block" ? "Hide History" : "Show My History";
               if (loadMoreButton && loadMoreContainer && loadMoreContainer.style.display === 'block') { loadMoreButton.disabled = false; loadMoreButton.innerText = "Load More History"; }
          }
     }

     // --- Event Listener for Load More Button ---
     if (loadMoreButton) { loadMoreButton.addEventListener('click', () => fetchHistory(true)); }


     // --- Download Image Utility ---
     function downloadImage(url, baseFilename = 'thumbnail') {
          const buttons = document.querySelectorAll('button'); let downloadButton = null;
          buttons.forEach(btn => { if (btn.onclick && btn.onclick.toString().includes(url.substring(0, 50))) { downloadButton = btn; } });
          const parentElement = downloadButton ? downloadButton.closest('.thumbnail-item, .card') : resultDiv;
          let errorTarget = parentElement || resultDiv;
           const existingError = errorTarget.querySelector('.download-error-message');
           if (existingError) existingError.remove();
           if (!url || !url.startsWith('data:image')) {
                console.error("Download failed: Invalid or missing Data URI.", url);
                const errorP = document.createElement('p'); errorP.className = 'download-error-message';
                errorP.innerText = `Download failed: Image data missing or invalid.`;
                if(downloadButton) downloadButton.parentNode.insertBefore(errorP, downloadButton.nextSibling);
                else errorTarget.appendChild(errorP);
                return;
           }
          const safeFilename = baseFilename.replace(/[^a-z0-9_]/gi, '_').toLowerCase() || 'thumbnail';
          const formatMatch = url.match(/^data:image\/([a-zA-Z+]+);base64,/);
          const extension = formatMatch ? formatMatch[1].replace('+', '') : 'png'; // Default to png if format unknown
          const filename = `${safeFilename}_${Date.now()}.${extension}`;
          try {
               const link = document.createElement("a"); link.href = url; link.download = filename;
               document.body.appendChild(link); link.click(); document.body.removeChild(link);
               console.log(`Download initiated for: ${filename}`);
          } catch (err) {
               console.error("Download failed via link click:", err);
               const errorP = document.createElement('p'); errorP.className = 'download-error-message';
               errorP.innerText = `Download failed (${err.message}). Try right-clicking the image > 'Save Image As...'.`;
                if(downloadButton) downloadButton.parentNode.insertBefore(errorP, downloadButton.nextSibling);
                else errorTarget.appendChild(errorP);
          }
     }


     // --- Scroll Utility ---
      function scrollToElement(elementId) {
        let element;
        if (typeof elementId === 'string') { element = document.getElementById(elementId); }
        else if (elementId instanceof Element) { element = elementId; }

        if (element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const elementIdentifier = element.id || element.className;
            // Highlight applicable elements
            if (['auth', 'credit-warning', 'custom-prompt', 'result', 'credits-container'].includes(elementIdentifier) || element.closest('.user-info-container > div')) {
                 element.style.transition = 'background-color 0.5s ease-in-out, box-shadow 0.5s ease-in-out';
                 const highlightColor = (element.id === 'result') ? 'rgba(167, 139, 250, 0.05)' : 'rgba(167, 139, 250, 0.1)';
                 element.style.backgroundColor = highlightColor;
                 element.style.boxShadow = '0 0 15px rgba(167, 139, 250, 0.3)';
                 setTimeout(() => { element.style.backgroundColor = ''; element.style.boxShadow = ''; }, 1500);
             }
         } else { console.warn(`scrollToElement: Element not found for identifier:`, elementId); }
     }


     // --- Initialization and Auth State Change Listener ---
     document.addEventListener('DOMContentLoaded', () => {
          const tabButtons = document.querySelectorAll('.tab-button');
          tabButtons.forEach(button => button.addEventListener('click', () => handleTabSwitch(button)));

          const urlParams = new URLSearchParams(window.location.search);
          const paymentStatus = urlParams.get('payment');
          const statusTargetElement = purchaseStatusP;

          if (statusTargetElement) {
               if (paymentStatus === 'success') {
                    showStatus(statusTargetElement, "âœ… Payment successful! Credits updating...", 'success');
                    setTimeout(() => { if (currentSession) fetchUserCredits(); }, 3000);
                    setTimeout(() => { if (statusTargetElement.innerText.includes("Payment successful")) showStatus(statusTargetElement, ''); }, 8000);
                    if (window.history.replaceState) window.history.replaceState(null, '', window.location.pathname);
               } else if (paymentStatus === 'cancel') {
                    showStatus(statusTargetElement, "âš ï¸ Purchase cancelled.", 'warning', 5000);
                    if (window.history.replaceState) window.history.replaceState(null, '', window.location.pathname);
               }
          }
          updateContentView();
     });

     // Auth state change listener
     supabaseClient.auth.onAuthStateChange((event, session) => {
          console.log('--- Supabase Auth Event ---:', event, session ? `User: ${session.user?.id}` : "No session");
          currentSession = session;
          const shouldUpdateUI = event === 'INITIAL_SESSION' || event === 'SIGNED_IN' || event === 'SIGNED_OUT';
          if (shouldUpdateUI) {
              console.log(` ---> Triggering full UI update (updateContentView) for event: ${event}`);
               updateContentView();
               if (session) {
                    console.log(` ---> Session exists, triggering fetchUserCredits`);
                    fetchUserCredits();
               } else {
                    console.log(` ---> Session is null, triggering updateCreditState(null)`);
                    updateCreditState(null);
               }
          } else if (session && (event === "TOKEN_REFRESHED" || event === "USER_UPDATED")) {
               console.log(` ---> Event ${event} received while logged in, triggering fetchUserCredits`);
               fetchUserCredits();
          } else {
               console.log(` ---> Event ${event} did not trigger specific action.`);
               if (event === "PASSWORD_RECOVERY") {
                    showStatus(authStatusP, "Password recovery email sent.", 'info', 5000);
               }
          }
     });

 </script>

</body>
</html>
