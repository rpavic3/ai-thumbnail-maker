<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AI Thumbnail & Asset Tools | AI Thumbnail Copilot</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="description" content="Generate viral YouTube thumbnails and extract image assets using AI with AI Thumbnail Copilot. Instantly create engaging content. No design skills needed." />
    <meta name="author" content="AI Thumbnail Copilot" />
    <meta name="robots" content="index, follow" />
    <meta property="og:title" content="AI Thumbnail & Asset Tools | AI Thumbnail Copilot" />
    <meta property="og:description" content="Instantly create stunning YouTube thumbnails or extract assets from images with AI. Enter details, get results!" />
    <meta property="og:url" content="https://thumbnailcopilot.com/" />
    <meta property="og:site_name" content="AI Thumbnail Copilot" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://thumbnailcopilot.com/LOGO.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="AI Thumbnail & Asset Tools | AI Thumbnail Copilot" />
    <meta name="twitter:description" content="Instantly create stunning YouTube thumbnails or extract assets from images with AI. Enter details, get results!" />
    <meta name="twitter:image" content="https://thumbnailcopilot.com/LOGO.png" />

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>

    <style>
        :root {
            --bg: #0e0d11;
            --surface: #1c1a23;
            --text: #f5f5f7;
            --text-muted: #a0a0a0;
            --accent: #a78bfa; /* Primary accent (Violet) */
            --accent-hover: #c4b5fd; /* Lighter violet */
            --input-bg: #2a2733;
            --logout: #fca5a5; /* Light red for logout */
            --logout-hover: #f87171; /* Darker red */
            --buy-button: #34d399; /* Green for buy button */
            --buy-button-hover: #6ee7b7; /* Lighter green */
            --radius: 16px;
            --tab-inactive-bg: #2e2e38;
            --tab-inactive-text: #888;
            --tab-inactive-hover-bg: #3a3843;
            --tab-inactive-hover-text: #ccc;
            --card-bg: #222028;
            --border-color: #3a3843;
            --success-color: #34d399; /* Green */
            --warning-color: #fbbf24; /* Amber */
            --error-color: #f87171; /* Red */
            /* --- New variables for option buttons --- */
            --option-bg: #4a4a5a; /* Light gray */
            --option-bg-hover: #5a5a6a;
            --option-bg-active: #6a6a7a; /* Darker gray */
            --option-text: #e0e0e0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background: var(--bg);
            font-family: 'Outfit', sans-serif;
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 1rem; /* Add padding around the body */
        }

        /* --- Main Container & Tabs --- */
        .tab-bar {
            display: flex;
            width: 100%;
            max-width: 820px;
            border-top-left-radius: var(--radius);
            border-top-right-radius: var(--radius);
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            margin-top: 1rem; /* Reduced top margin */
        }

        .tab-button {
            flex: 1;
            padding: 1rem;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            border-bottom: 3px solid transparent; /* Bottom border for active state */
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            background: var(--tab-inactive-bg);
            color: var(--tab-inactive-text);
            text-align: center;
        }

        .tab-button.active {
            background: var(--surface); /* Match container background */
            color: var(--accent);
            border-bottom: 3px solid var(--accent);
            z-index: 1;
        }

        .tab-button:not(.active):hover {
             background: var(--tab-inactive-hover-bg);
             color: var(--tab-inactive-hover-text);
        }

        .container {
            width: 100%;
            max-width: 820px;
            background: var(--surface);
            border-radius: var(--radius);
            padding: 2rem 1.5rem; /* Adjusted padding */
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            position: relative;
            margin-top: 0; /* Remove margin connecting to tabs */
            border: 1px solid var(--border-color); /* Optional border */
            border-top-left-radius: 0;  /* Connect to tabs */
            border-top-right-radius: 0; /* Connect to tabs */
        }

        /* --- Headings --- */
        h1 {
            font-size: clamp(1.8rem, 5vw, 2.6rem); /* Responsive font size */
            color: var(--accent);
            text-align: center;
            margin-bottom: 1rem;
            padding-top: 1rem; /* Reduced padding */
        }

        h2 {
            font-size: clamp(1.3rem, 4vw, 1.6rem);
            color: var(--text);
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        /* Center specific H2s if needed */
        #history h2,
        #asset-extraction-content h2,
        #asset-history-display h2 {
            text-align: center;
            color: var(--accent);
            margin-bottom: 1.5rem;
            border-bottom: none;
        }

        /* --- Forms & Inputs --- */
        label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
            font-size: 0.95rem;
            color: var(--text-muted);
        }

        input[type="email"],
        input[type="password"],
        input[type="text"],
        textarea,
        input[type="file"] { /* Apply basic styles to file input */
            width: 100%;
            padding: 0.9rem 1rem;
            font-size: 1rem;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: calc(var(--radius) / 2); /* Slightly smaller radius */
            color: var(--text);
            transition: border-color 0.2s, box-shadow 0.2s;
            margin-bottom: 1rem;
            font-family: inherit; /* Ensure consistent font */
        }

        /* Specific style tweaks for file input */
        input[type="file"] {
            padding: 0.6rem 1rem; /* Adjust padding */
            cursor: pointer;
            color: var(--text-muted);
        }
        input[type="file"]::file-selector-button {
            background: var(--accent);
            color: var(--bg);
            border: none;
            padding: 0.6rem 1rem;
            border-radius: calc(var(--radius) / 3);
            margin-right: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover {
            background: var(--accent-hover);
        }
        .file-input-label { /* For styling the label as a button if hiding the input */
            /* display: inline-block; padding: ... etc. */
        }
        .file-note {
             font-size: 0.85rem; color: var(--text-muted); margin-top: -0.5rem; margin-bottom: 1rem;
        }


        input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.3); 
        }

        textarea {
            resize: vertical; /* Allow vertical resize */
            min-height: 80px;
        }

        /* --- Buttons --- */
        button {
            background: var(--accent);
            color: #0e0d11; /* Dark text on accent */
            padding: 0.8rem 1.2rem; /* Adjusted padding */
            border: none;
            border-radius: calc(var(--radius) / 2);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s, transform 0.1s;
            display: inline-flex; /* Align icon and text */
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* Space between icon and text if needed */
        }

        button:hover {
            background: var(--accent-hover);
            transform: translateY(-1px); /* Subtle lift */
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: var(--accent); /* Keep base color */
            transform: none; /* No lift when disabled */
        }
        button:disabled:hover {
             background: var(--accent); /* Prevent hover color change */
        }

        /* Secondary Button Style */
        .secondary-button {
            background: transparent;
            color: var(--accent);
            border: 1px solid var(--accent);
        }
        .secondary-button:hover {
            background: rgba(167, 139, 250, 0.1); /* Subtle background on hover */
            color: var(--accent-hover);
            border-color: var(--accent-hover);
        }
        .secondary-button:disabled {
             opacity: 0.5;
             cursor: not-allowed;
             background: transparent;
             color: var(--accent);
             border-color: var(--accent);
         }
        .secondary-button:disabled:hover {
             background: transparent;
             color: var(--accent);
             border-color: var(--accent);
         }

        /* Buy Credits Button Style (Base) */
        .buy-credits-button {
             background: var(--buy-button);
             color: var(--bg); /* Dark text on green */
        }
        .buy-credits-button:hover {
            background: var(--buy-button-hover);
        }

        /* Specific style for header buy button */
        .header-buy-button {
            padding: 0.4rem 0.8rem; /* Smaller padding */
            font-size: 0.85rem; /* Smaller font */
            margin-left: 0.5rem; /* Add some space from credits */
        }


        /* Logout Button Style */
        #logout-button {
            background: var(--logout);
            color: var(--bg); /* Dark text on red */
            padding: 0.5rem 0.8rem;
            font-size: 0.85rem;
            flex-shrink: 0; /* Prevent shrinking */
        }
        #logout-button:hover {
            background: var(--logout-hover);
        }

        /* --- User Info & Status --- */
        /* Status message base style (used by auth, purchase, asset extraction) */
        #auth-status, #purchase-status, #asset-status {
            font-size: 0.9rem;
            color: var(--text-muted);
            min-height: 1.2em; /* Reserve space */
            text-align: center;
            margin-top: 0.5rem;
            width: 100%; /* Ensure it takes width in flex column */
        }
        #auth-status.error, #purchase-status.error, #asset-status.error { color: var(--error-color); }
        #auth-status.success, #purchase-status.success, #asset-status.success { color: var(--success-color); }
        #auth-status.warning, #purchase-status.warning, #asset-status.warning { color: var(--warning-color); }

        /* Style for purchase status in header */
        .header-purchase-status {
            font-size: 0.8rem; /* Smaller font */
            margin-top: 0.3rem; /* Space below button */
            text-align: center; /* Center text */
            min-height: 1em; /* Reserve space */
            width: 100%; /* Take width within its flex item */
            margin-left: 0;
            margin-right: 0;
        }


        /* Adjusted user info container */
        .user-info-container {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            justify-content: space-between; /* Space out items */
            align-items: center; /* Vertically center items */
            gap: 1rem; /* Space between items */
            padding: 0.75rem 0; /* Adjusted padding */
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        /* --- User Info Centering Rules --- */
        /* Shared styles */
        .credits-display, .user-info-display {
            font-size: 0.9rem;
            color: var(--text-muted);
            background-color: rgba(0,0,0, 0.2);
            padding: 0.3rem 0.7rem;
            border-radius: calc(var(--radius) / 3);
            white-space: nowrap; /* Prevent wrapping */
            display: inline-flex;
            align-items: center;
        }
        .credits-display strong { color: var(--accent); font-weight: 700; }
        .user-info-display span { color: var(--text); font-weight: 600; }
        .user-info-display { flex-grow: 1; justify-content: center; }
        .user-info-container > div:has(#credits-container) { flex-grow: 0; flex-shrink: 0; }

        /* Wrapper for purchase controls in header */
        .purchase-controls {
            display: flex; /* Use flex for button and status */
            flex-direction: column; /* Stack button and status */
            align-items: center; /* Center items horizontally */
        }


        /* --- Results & History (Thumbnails) --- */
        #result h2 { /* Style for the heading above the grid */
             width: 100%;
             text-align: center;
             margin-bottom: 1.5rem;
             color: var(--accent);
             border-bottom: none; /* Remove border for this specific h2 */
             padding-bottom: 0;
        }
        #result {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .thumbnail-results-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(min(300px, 100%), 1fr));
             gap: 1.5rem;
             margin-top: 1rem;
             width: 100%;
        }

        .thumbnail-item {
             display: flex;
             flex-direction: column;
             align-items: center;
             background-color: var(--card-bg); /* Use card background */
             padding: 1rem;
             border-radius: var(--radius);
             border: 1px solid var(--border-color);
             box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .thumbnail-item img {
             max-width: 100%;
             height: auto;
             aspect-ratio: 16 / 9; /* Maintain aspect ratio */
             object-fit: cover; /* Cover the area */
             border-radius: calc(var(--radius) / 2);
             margin-bottom: 1rem;
             background-color: #333; /* Placeholder bg */
             cursor: pointer; /* Indicate clickable for modal */
        }

        .thumbnail-item button {
             width: 100%; /* Make button full width */
             margin-top: auto; /* Push button to bottom if needed */
             padding: 0.6rem 1rem; /* Smaller padding */
             font-size: 0.9rem;
        }

        /* Prompt text display */
        .prompt-text {
            background: var(--input-bg);
            padding: 1rem;
            border-radius: calc(var(--radius) / 2);
            margin-top: 1.5rem; /* Space above */
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            width: 100%; /* Take full width */
        }
        .prompt-text strong { color: var(--text); }


        /* History Card Styling (Thumbnails) */
        #history .card {
            background: var(--card-bg);
            padding: 1rem; /* Slightly less padding */
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        #history .card img {
             max-width: 100%;
             height: auto;
             aspect-ratio: 16 / 9;
             object-fit: cover;
             border-radius: calc(var(--radius) / 2);
             display: block;
             margin-bottom: 1rem;
             background-color: #333; /* Placeholder bg */
             cursor: pointer; /* Add cursor for modal */
        }
        #history .card p {
            margin: 0.4rem 0;
            font-size: 0.9rem;
            color: var(--text-muted);
            word-wrap: break-word; /* Allow long prompts/titles to wrap */
        }
        #history .card p strong {
             color: var(--text);
             font-weight: 600;
        }
        #history .card p:last-child { /* Style for timestamp */
             font-size: 0.75em;
             color: #888;
             margin-top: 0.8rem;
        }
        #history .card button { /* Style download button in history */
             padding: 0.5rem 1rem;
             font-size: 0.9rem;
             margin-bottom: 1rem;
             width: auto; /* Don't force full width */
        }
         /* Loading/Empty History Message */
         #history p:only-child, #asset-history-display p:only-child {
              color: var(--text-muted);
              text-align: center;
              padding: 2rem 0;
              font-style: italic;
         }
         /* End of History Message */
         .no-more-history {
              text-align:center;
              color: var(--text-muted);
              margin-top:1rem;
              font-style: italic;
              font-size: 0.9em;
         }


        /* --- NEW: Asset Extraction UI Styles --- */
        #asset-extraction-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            width: 100%;
        }
        .asset-input-area, .asset-result-area {
            border: 1px dashed var(--border-color);
            padding: 1.5rem;
            border-radius: var(--radius);
            background: rgba(0,0,0,0.1);
        }
        #asset-preview-container, #asset-result-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1rem;
            min-height: 150px; /* Placeholder height */
            background-color: rgba(255, 255, 255, 0.05); /* Slight background */
            border-radius: calc(var(--radius) / 2);
            overflow: hidden; /* Contain the image */
        }
        #asset-preview-image, #asset-result-image {
            max-width: 80%;
            max-height: 300px;
            object-fit: contain; /* Show the whole image */
            display: none; /* Hidden until loaded */
            border-radius: calc(var(--radius) / 3);
        }
        #asset-result-container {
            min-height: 200px; /* Larger result area */
        }
        #asset-result-container img { /* Style result specifically */
            cursor: pointer; /* Indicate clickable for modal */
        }
        .asset-result-actions { /* Wrapper for download button etc. */
            text-align: center;
            margin-top: 1rem;
        }

        /* --- UPDATED: Asset History Styles --- */
        #asset-history-display {
             margin-top: 1rem;
             padding-top: 1.5rem;
             border-top: 1px solid var(--border-color);
        }
        .asset-card { /* Style for each history item card */
            background: var(--card-bg);
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Space between elements */
        }
        .asset-card-preview-container { /* Container for the single preview image */
            width: 100%;
            max-width: 200px; /* Limit preview size */
            min-height: 100px; /* Ensure some space */
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 0.5rem;
            background-color: rgba(0,0,0,0.1); /* Subtle bg */
            border-radius: calc(var(--radius) / 3);
            border: 1px solid var(--border-color);
        }
        .asset-card-preview-container img { /* Styling for the extracted preview */
            max-width: 90%;
            max-height: 150px; /* Adjust max height as needed */
            object-fit: contain;
            border-radius: calc(var(--radius) / 4);
            background-color: #333; /* Placeholder bg */
            cursor: pointer;
        }
         .asset-card-preview-container p { /* Fallback text if image fails */
            font-size: 0.8em;
            color: var(--text-muted);
            text-align: center;
         }
        .asset-card p { /* General paragraphs in the card */
            margin: 0.2rem 0;
            font-size: 0.9rem;
            color: var(--text-muted);
            word-wrap: break-word;
            text-align: center; /* Center text below image */
        }
        .asset-card p strong {
            color: var(--text);
            font-weight: 600;
        }
        .asset-card p.timestamp { /* Specific style for timestamp */
            font-size: 0.75em;
            color: #888;
            margin-top: 0.5rem;
        }
        .asset-card button { /* Style download button in history */
             padding: 0.4rem 0.8rem;
             font-size: 0.8rem;
             margin-top: 0.5rem;
             width: auto; /* Don't force full width */
        }

        /* --- Other Sections (How-it-works) --- */
        #how-it-works-section {
            text-align: center;
            border-top: 1px solid var(--border-color);
            margin-top: 2rem; /* Restore margin */
            padding-top: 1.5rem; /* Restore padding */
            width: 100%;
        }
        #how-it-works-section h2 { color: var(--accent); border-bottom: none; margin-bottom: 2rem; }
        .steps-container { display: block; text-align: left; }
        .step-card {
            width: 100%;
            margin-bottom: 1.5rem;
            background: var(--input-bg);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        .step-card .step-number { font-size: 1.5rem; font-weight: 700; color: var(--accent); margin-bottom: 0.5rem; }
        .step-card h3 { margin: 0 0 1rem 0; font-size: 1.2rem; font-weight: 600; color: var(--text); }
        .step-card img { max-width: 100%; height: auto; border-radius: calc(var(--radius) / 2); margin-bottom: 1rem; border: 1px solid var(--border-color); }
        .step-card p { font-size: 1rem; color: var(--text-muted); line-height: 1.6; margin-bottom: 0; }
        #how-it-works-section button { margin-top: 1.5rem; background: var(--accent-hover); color: var(--bg); }

        /* --- Utility & Feedback Styles --- */
        #credit-warning { /* Used for thumbnail gen */
             color: var(--warning-color);
             font-size: 0.9em;
             margin-top: 0.8em;
             padding: 0.5rem;
             background-color: rgba(251, 191, 36, 0.1);
             border: 1px solid var(--warning-color);
             border-radius: calc(var(--radius) / 3);
             text-align: center;
        }
        #credit-warning a {
             color: var(--accent);
             text-decoration: underline;
             font-weight: bold;
             margin-left: 0.5em;
        }
        #credit-warning a:hover { color: var(--accent-hover); }

        .download-error-message {
             color: var(--warning-color);
             font-size: 0.85em;
             margin-top: 0.5rem;
        }

        /* --- Added for AI Badge & How-it-works Intro --- */
        .ai-badge { /* Renamed from openai-badge */
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 0.5rem; /* Adjust as needed */
            margin-bottom: 2rem; /* Space before How it Works */
        }
        .how-it-works-intro {
            font-size: 0.95rem;
            color: var(--text-muted);
            margin-bottom: 1.5rem; /* Space before the steps */
            text-align: center;
            max-width: 600px; /* Optional: constrain width */
            margin-left: auto; /* Center if max-width is set */
            margin-right: auto; /* Center if max-width is set */
        }

        /* --- Added for Generation Note --- */
        .generation-note {
             font-size: 0.85rem;
             color: var(--text-muted);
             text-align: center;
             margin-top: 1rem; /* Space below the form/button */
             margin-bottom: 1.5rem; /* Space above the divider/prompt preview */
             padding: 0 1rem; /* Optional padding */
         }


        /* --- Styles for Prompt Option Buttons --- */
        #prompt-options-container {
            margin-top: 1rem; /* Space below niche input */
            margin-bottom: 1.5rem; /* Space above suggest button */
            display: flex;
            flex-wrap: wrap; /* Allow buttons to wrap */
            gap: 0.5rem; /* Space between buttons */
            align-items: center; /* Align items vertically */
        }
        #prompt-options-container label {
            margin-bottom: 0; /* Remove bottom margin for the label */
            margin-right: 0.5rem; /* Space after label */
            font-size: 0.95rem; /* Match other labels */
            color: var(--text-muted);
            font-weight: 600;
        }
        .option-button {
            padding: 0.4rem 0.8rem; /* Smaller padding */
            font-size: 0.85rem; /* Smaller font */
            background-color: var(--option-bg); /* Light gray */
            color: var(--option-text);
            border: 1px solid transparent; /* Add border for structure */
            border-radius: calc(var(--radius) / 2.5); /* Slightly smaller radius */
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, transform 0.1s;
            font-weight: normal;
            display: inline-flex; align-items: center; justify-content: center;
            gap: 0; /* Remove gap */
        }
        .option-button:hover {
            background-color: var(--option-bg-hover);
            border-color: var(--border-color);
            transform: none; /* No lift on hover */
        }
        .option-button.active {
            background-color: var(--option-bg-active); /* Darker gray */
            border-color: var(--accent); /* Highlight border when active */
            color: var(--text);
            font-weight: 600; /* Make active text bolder */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.2); /* Subtle inner shadow */
        }


        /* --- Responsive Adjustments --- */
        @media (max-width: 600px) {
             body { padding: 0.5rem; }
             .container { padding: 1.5rem 1rem; }
             h1 { padding-top: 1rem; }
             .tab-button { font-size: 0.9rem; padding: 0.8rem 0.5rem; }

             /* Responsive header bar */
             .user-info-container { flex-direction: column; align-items: stretch; padding-bottom: 1rem; }
             .user-info-container > div, .user-info-container > button#logout-button { text-align: center; width: 100%; margin-bottom: 0.5rem; }
             .credits-display, .user-info-display { justify-content: center; }
             .purchase-controls { width: auto; margin-bottom: 0; text-align: center; }
             #logout-button { order: 2; margin-top: 0.5rem; margin-bottom: 0; width: 100%; }
             .header-buy-button { width: auto; margin-left: 0; }
             .user-info-container > div:has(#credits-container) { order: 1; align-items: center; }
             .user-info-display { order: 0; flex-grow: 0; }


             button { padding: 0.8rem 1rem; font-size: 0.95rem; }

             #how-it-works-section { padding: 1.5rem 1rem; margin-top: 1rem; }
             #how-it-works-section h2 { font-size: 1.4rem; margin-bottom: 1.5rem;}
             .step-card h3 { font-size: 1.1rem; }
             .step-card p { font-size: 0.95rem; }

             .ai-badge { margin-bottom: 1.5rem; }
             .how-it-works-intro { margin-bottom: 1rem; }

             #prompt-options-container { gap: 0.4rem; justify-content: center; }
              #prompt-options-container label { width: 100%; text-align: center; margin-bottom: 0.5rem; margin-right: 0; }
             .option-button { padding: 0.3rem 0.6rem; font-size: 0.8rem; }

             /* Asset Extraction Responsive */
             .asset-card-previews { grid-template-columns: 1fr; } /* Stack previews on mobile */
             .asset-card-previews img { max-height: 100px; }
             /* Simplified Asset History Card for Mobile */
             .asset-card { flex-direction: column; align-items: center; }
             .asset-card-preview-container { max-width: 150px; margin-bottom: 0.75rem; }

        }

        /* --- NEW: Style Profile UI Styles --- */
        #style-profile-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            width: 100%;
        }
        
        .style-upload-area {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
        }
        
        .thumbnail-upload-container {
            margin: 1rem 0;
        }
        
        .thumbnail-previews {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .thumbnail-preview {
            position: relative;
            width: 150px;
            height: 100px;
            border-radius: calc(var(--radius) / 2);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .thumbnail-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .thumbnail-preview .remove-thumbnail {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
        }
        
        .json-editor-container {
            background: var(--input-bg);
            border-radius: calc(var(--radius) / 2);
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .saved-styles-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .style-card {
            background: var(--surface);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .style-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .style-card-header h4 {
            color: var(--accent);
            margin: 0;
            cursor: pointer;
            position: relative;
            display: inline-block;
            padding-right: 20px;
        }
        
        .style-card-header h4::after {
            content: '▼';
            font-size: 0.7em;
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.2s ease;
        }
        
        .style-card-header h4:hover {
            color: var(--accent-hover);
        }
        
        .style-card.expanded .style-card-header h4::after {
            transform: translateY(-50%) rotate(180deg);
        }
        
        .style-card-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .style-card-actions button {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        
        .style-card-content {
            max-height: 200px;
            overflow-y: auto;
            background: var(--input-bg);
            border-radius: calc(var(--radius) / 2);
            padding: 0.5rem;
            font-family: monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            display: none;
        }
        
        .style-card.expanded .style-card-content {
            display: block;
        }
        
        .style-card.editing .style-card-content {
            display: none;
        }
        
        .style-edit-container {
            margin-top: 0.5rem;
            display: none;
        }
        
        .style-card.editing .style-edit-container {
            display: block;
        }
        
        .style-edit-container textarea {
            width: 100%;
            font-family: monospace;
            font-size: 0.85rem;
            min-height: 150px;
            margin-bottom: 0.5rem;
            background: var(--input-bg);
            color: var(--text);
            border: 1px solid var(--border-color);
            border-radius: calc(var(--radius) / 3);
            padding: 0.5rem;
            resize: vertical;
        }
        
        .style-edit-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        /* --- simple image modal --- */
        #img-modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;
             align-items:center;justify-content:center;z-index:9999}
        #img-modal img{max-width:90vw;max-height:90vh;border-radius:12px}

        /* --- NEW: Canvas Controls Styles --- */
        .tool-controls, .color-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 0.5rem;
        }
        
        .tool-button {
            padding: 0.5rem 1rem;
            background-color: var(--option-bg);
            color: var(--text);
            border: none;
            border-radius: calc(var(--radius) / 4);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .tool-button:hover {
            background-color: var(--option-bg-hover);
        }
        
        .tool-button.active {
            background-color: var(--accent);
            color: var(--bg);
        }
        
        .color-button {
            width: 30px;
            height: 30px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .color-button:hover {
            transform: scale(1.1);
        }
        
        .color-button.active {
            border: 2px solid var(--text);
            transform: scale(1.2);
        }
        
        .upload-sketch-container {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px dashed var(--border-color);
            border-radius: var(--radius);
            text-align: center;
        }
        
        .upload-sketch-container p {
            margin-bottom: 0.5rem;
            color: var(--text-muted);
        }
        
        /* --- Modal Styles --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
        }
    </style>
</head>
<body>

 <div class="tab-bar">
     <button id="tab-prompt-gen" class="tab-button active">Image Generation</button>
     <button id="tab-asset-extraction" class="tab-button">Object Extraction</button>
     <button id="tab-style-profile" class="tab-button">Style Profile</button>
 </div>

 <div class="container">
     <h1>✨ AI Thumbnail Copilot</h1>

     <div id="auth">
         <h2>Login or Sign up</h2>
         <p id="signup-encouragement" style="color: var(--accent); text-align: center; margin-bottom: 1.5rem; font-size: 1.05rem;">
              ✨ New here? Sign up to get <strong>10 free credits</strong> and start creating amazing thumbnails! ✨
         </p>
         <label for="auth-email">Email</label>
         <input type="email" id="auth-email" placeholder="you@example.com" required />
         <label for="auth-password">Password</label>
         <input type="password" id="auth-password" placeholder="••••••••" required />
         <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
              <button onclick="login()" style="flex: 1;">Log In</button>
              <button class="secondary-button" onclick="signup()" style="flex: 1;">Sign Up</button>
         </div>
         <p id="auth-status"></p>
     </div>

     <div id="main-app-content" style="display: none; width: 100%;">

         <div class="user-info-container">
             <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.5rem;">
                 <div id="credits-container" class="credits-display" style="display: none;">
                      Credits: <strong id="credits-display">--</strong>
                 </div>
                 <div class="purchase-controls" style="display: none;">
                      <button class="buy-credits-button header-buy-button" data-price-id="price_1RIwfTFj9LYfI1R0gVPq3kRS"> Buy 50 Credits (€9.99) </button>
                      <p id="purchase-status" class="header-purchase-status"></p>
                 </div>
             </div>
             <div id="user-info-display" class="user-info-display" style="display: none;">
                  User: <span id="user-email-display"></span>
             </div>
             <button id="logout-button" onclick="logout()">Log Out</button>
         </div>

         <div id="prompt-gen-tab-content" style="display: none; width: 100%;">
             <form id="thumbnailForm">
                 <label for="title">Video Title</label>
                 <input type="text" id="title" placeholder="e.g. How I Got 1M Views From Shorts" required />
                 <label for="niche">Channel Niche / Video Topic</label>
                 <input type="text" id="niche" placeholder="e.g. Tech Reviews, Travel Vlogs, Cooking Tutorials" required />

                 <div id="prompt-options-container">
                      <label>Special requests:</label>
                      <button type="button" class="option-button">no text</button>
                      <button type="button" class="option-button">no humans</button>
                      <button type="button" class="option-button">cartoon style</button>
                      <button type="button" class="option-button">photorealistic</button>
                      <button type="button" class="option-button">pixel art</button>
                      <button type="button" class="option-button">3d render</button>
                      <button type="button" class="option-button">oil painting</button>
                      <button type="button" class="option-button">watercolor</button>
                      <button type="button" class="option-button">retro</button>
                      <button type="button" class="option-button">bright and cheerful</button>
                      <button type="button" class="option-button">dark and mysterious</button>
                 </div>
                 <label for="styleProfileSelect">Select Style Profile (Optional):</label>
                 <select id="styleProfileSelect" name="styleProfile" style="appearance: none; -webkit-appearance: none; -moz-appearance: none; background-color: var(--input-bg); color: var(--text); padding: 0.8rem 1rem; border-radius: var(--radius); border: 1px solid var(--border-color); width: 100%; font-family: 'Outfit', sans-serif; cursor: pointer; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23a0a0a0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>'); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1rem;">
                     <option value="">-- None --</option>
                 </select>
                 <div style="margin-top: 1rem; text-align: center;"> <button type="submit" id="generate-prompt-button">Suggest Prompt Idea</button>
                 </div>
             </form>

             <div id="prompt-preview" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                 <label for="custom-prompt">Edit AI Prompt Suggestion (or enter your own)</label>
                 <textarea id="custom-prompt" rows="4" placeholder="Describe the thumbnail you want the AI to create..."></textarea>
                 <button onclick="confirmPrompt()" id="confirm-prompt-button" style="margin-top: 0.5rem; width: 100%;">Generate 2 Thumbnails (Cost: 2 Credits)</button>
                 <p id="credit-warning" style="display: none;"></p>
             </div>

             <div id="result">
                 </div>

             <div style="margin-top: 2rem; text-align: center;">
                 <button id="history-button" onclick="fetchHistory()" class="secondary-button">Show My History</button>
             </div>

             <div id="history" style="display: none; margin-top: 1rem;">
                  </div>
             <div id="history-load-more-container" style="text-align: center; margin-top: 1rem; display: none;">
                 <button id="history-load-more-button" class="secondary-button">Load More History</button>
             </div>

         </div>

         <div id="asset-extraction-content" style="display: none; width: 100%;">
             <h2>✂️ Asset Extractor</h2>
             <p style="text-align: center; color: var(--text-muted); margin-top: -1rem; margin-bottom: 1rem;">Upload a PNG image, describe the object you want to keep, and the AI will attempt to remove the background.</p>

             <div class="asset-input-area">
                 <label for="asset-source-image">1. Upload Source Image (PNG or JPG/JPEG)</label>
                 <input type="file" id="asset-source-image" accept="image/png,image/jpeg,image/jpg" required />
                 <p class="file-note">The AI works best with clear subjects against contrasting backgrounds.</p>
                 <div id="asset-preview-container">
                      <img id="asset-preview-image" src="" alt="Selected image preview" />
                      <p id="asset-preview-placeholder" style="color: var(--text-muted);">Image preview will appear here</p>
                 </div>

                 <label for="asset-description" style="margin-top: 1rem;">2. Describe the Asset to Extract</label>
                 <input type="text" id="asset-description" placeholder="e.g., 'the cat', 'the logo in the center', 'person wearing red'" required />

                 <button id="extract-asset-button" style="margin-top: 1rem; width: 100%;" disabled>Extract Asset (Cost: 3 Credits)</button>
                 <p id="asset-status"></p>
             </div>

             <div class="asset-result-area" id="asset-result-area" style="display: none;">
                 <h3>Extraction Result:</h3>
                 <div id="asset-result-container">
                      <img id="asset-result-image" src="" alt="Extracted asset result" />
                 </div>
                 <div class="asset-result-actions">
                      <button id="asset-download-button" class="secondary-button" style="display: none;">⬇ Download Extracted PNG</button>
                 </div>
                 <p class="generation-note">Note: AI background removal isn't perfect. Complex backgrounds or subjects might have artifacts.</p>
             </div>

              <div style="margin-top: 2rem; text-align: center;">
                 <button id="asset-history-button" class="secondary-button">Show My Asset History</button>
             </div>

             <div id="asset-history-display" style="display: none; margin-top: 1rem;">
                  </div>
             <div id="asset-history-load-more-container" style="text-align: center; margin-top: 1rem; display: none;">
                 <button id="asset-history-load-more-button" class="secondary-button">Load More Asset History</button>
             </div>

         </div>

         <div id="style-profile-content" style="display: none; width: 100%;">
              <h2>🎨 Style Profile</h2>
              <p style="text-align: center; color: var(--text-muted); margin-top: -1rem; margin-bottom: 1rem;">Upload thumbnails you like and get an AI-generated style profile to use in your future thumbnails.</p>
              
              <div class="style-upload-area">
                  <h3>Upload Reference Thumbnails</h3>
                  <p>Select up to 5 thumbnails that represent the style you want to analyze.</p>
                  <div class="thumbnail-upload-container">
                      <input type="file" id="style-thumbnails-upload" accept="image/png, image/jpeg, image/jpg" multiple>
                      <p class="file-note">For best results, choose thumbnails with a consistent style.</p>
                  </div>
                  <div id="thumbnail-previews" class="thumbnail-previews"></div>
                  <button id="analyze-style-button" style="margin-top: 1rem; width: 100%;">Analyze Style (Cost: 5 Credits)</button>
                  <p id="style-analysis-status"></p>
              </div>
              
              <div id="style-profile-result" style="display: none; margin-top: 2rem;">
                  <h3>Style Profile</h3>
                  <div class="json-editor-container">
                      <textarea id="style-profile-json" rows="10" style="width: 100%; font-family: monospace;" spellcheck="false"></textarea>
                  </div>
                  <div class="style-profile-actions">
                      <div class="style-name-input" style="margin-top: 1rem;">
                          <label for="style-name">Name this style:</label>
                          <input type="text" id="style-name" placeholder="e.g., Vibrant Tech Style">
                          <p id="style-name-warning" class="warning" style="margin-top: 0.25rem; font-size: 0.9rem; display: none;">Please enter a name for this style</p>
                      </div>
                      <button id="save-style-button" class="secondary-button" style="margin-top: 1rem; width: 100%;">Save Style Profile</button>
                  </div>
              </div>
              
              <div id="saved-styles-section" style="margin-top: 2rem;">
                  <h3>My Styles</h3>
                  <div id="saved-styles-list" class="saved-styles-list">
                      <p id="no-saved-styles-message">You haven't saved any style profiles yet.</p>
                  </div>
              </div>
         </div>
         </div> <p class="ai-badge">🚀 Powered by advanced AI image generation & editing</p>

     <div id="how-it-works-section" style="display: none;"> <h2>Create Thumbnails in 3 Easy Steps</h2>
         <p class="how-it-works-intro">
             Our AI utilizes state-of-the-art models, renowned for delivering stunningly creative and high-quality visual results.
         </p>
         <div class="steps-container">
             <div class="step-card">
                 <span class="step-number">1.</span>
                 <h3>Enter Video Details</h3>
                 <img src="images/step1-input.png" alt="Screenshot of entering video title and niche" onerror="this.style.display='none'">
                 <p>Provide your video title and niche/topic. Optionally, select special requests like style or content exclusions.</p> </div>
             <div class="step-card">
                 <span class="step-number">2.</span>
                 <h3>Get Prompt Ideas</h3>
                  <img src="images/step2-prompt.png" alt="Screenshot showing AI generated prompt" onerror="this.style.display='none'">
                 <p>Click "Suggest Prompt Idea". Our AI suggests a visual prompt based on your input and requests. You can edit it or write your own from scratch.</p> </div>
             <div class="step-card">
                 <span class="step-number">3.</span>
                 <h3>Generate Thumbnails</h3>
                  <img src="images/step3-thumbnail.png" alt="Screenshot of a generated thumbnail" onerror="this.style.display='none'">
                 <p>Click "Generate Thumbnails". The AI creates two unique, eye-catching options based on your final prompt!</p>
             </div>
         </div>
         <button onclick="scrollToElement('auth')">
              Sign Up Now & Get 10 Free Credits!
         </button>
     </div>

 </div> <div id="img-modal" onclick="this.style.display='none'">
     <img src="" alt="preview"/>
 </div>


 <script>
     // --- Configuration (Ensure these match your setup) ---
     const SUPABASE_URL = "https://mjwjxxfnqbaroxwjewms.supabase.co"; // Your Supabase URL
     const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qd2p4eGZucWJhcm94d2pld21zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQzNDg1NDQsImV4cCI6MjA1OTkyNDU0NH0.dYc-6m6gjpWlCD-qXYP5q_biO0Ai_CdpZMsPcPfD6Vk"; // Your Supabase Anon Key
     const BACKEND_URL = "https://ai-thumbnail-maker.onrender.com"; // Your Flask backend URL
     const STRIPE_PUBLISHABLE_KEY = "pk_live_51RGO3VFj9LYfI1R0cQJetymluTuFJypOZ50kEaYzTNuyldVzHAp44DzqZWasbk5mBd2Rw0x5dXW4zAJxnPsP7SKK00aGiig0wu"; // Your Stripe Publishable Key

     // --- Constants ---
     const NUM_IMAGES_EXPECTED = 2;
     const CREDIT_COST_PER_IMAGE = 1;
     const TOTAL_GENERATION_COST = NUM_IMAGES_EXPECTED * CREDIT_COST_PER_IMAGE;
     const HISTORY_ITEMS_PER_PAGE = 10;
     // --- NEW Asset Extraction Constants ---
     const CREDIT_COST_PER_ASSET_EXTRACTION = 3; // Match backend
     const ASSET_HISTORY_ITEMS_PER_PAGE = 5; // Match backend default or choose your own

     // --- Initialization ---
     let stripe = null;
     try {
         if (!STRIPE_PUBLISHABLE_KEY || STRIPE_PUBLISHABLE_KEY === "YOUR_STRIPE_PUBLISHABLE_KEY") {
             throw new Error("Stripe Publishable Key is not configured.");
         }
         stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
     } catch (e) {
         console.error("Stripe initialization failed:", e);
         const purchaseStatusElement = document.getElementById('purchase-status');
         if (purchaseStatusElement) {
             purchaseStatusElement.innerText = "Payment system error.";
             purchaseStatusElement.className = 'error header-purchase-status'; // Add header class
         }
         const buyButtons = document.querySelectorAll('.buy-credits-button');
         buyButtons.forEach(btn => btn.disabled = true);
     }
     const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

     // --- Global state ---
     let currentSession = null;
     let currentUserCredits = null;
     // Thumbnail History State
     let currentHistoryPage = 1;
     let totalHistoryItems = 0;
     let isLoadingHistory = false;
     // --- NEW Asset History State ---
     let currentAssetHistoryPage = 1;
     let totalAssetHistoryItems = 0;
     let isLoadingAssetHistory = false;
     let selectedAssetImageDataUri = null; // Store selected PNG data URI

     // --- DOM Element References ---
     const form = document.getElementById('thumbnailForm');
     const resultDiv = document.getElementById('result');
     const authDiv = document.getElementById('auth');
     const authStatusP = document.getElementById('auth-status');
     const mainAppContentDiv = document.getElementById('main-app-content');
     const promptGenContentDiv = document.getElementById('prompt-gen-tab-content');
     // Tabs
     const promptGenTabButton = document.getElementById('tab-prompt-gen');
     const assetExtractionTabButton = document.getElementById('tab-asset-extraction');
     const styleProfileTabButton = document.getElementById('tab-style-profile');
     // User Info Header
     const logoutButton = document.getElementById('logout-button');
     const creditsContainer = document.getElementById('credits-container');
     const creditsDisplaySpan = document.getElementById('credits-display');
     const userInfoDisplayDiv = document.getElementById('user-info-display');
     const userEmailDisplaySpan = document.getElementById('user-email-display');
     const purchaseStatusP = document.getElementById('purchase-status');
     const purchaseControlsDiv = document.querySelector('.purchase-controls');
     const userInfoContainer = document.querySelector('.user-info-container'); // Reference user info header
     // Thumbnail Generation Elements
     const generatePromptButton = document.getElementById('generate-prompt-button');
     const promptPreviewDiv = document.getElementById('prompt-preview');
     const confirmPromptButton = document.getElementById('confirm-prompt-button');
     const creditWarningP = document.getElementById('credit-warning');
     const optionsContainer = document.getElementById('prompt-options-container');
     // Thumbnail History Elements
     const historyButton = document.getElementById('history-button');
     const historyDiv = document.getElementById('history');
     const loadMoreContainer = document.getElementById('history-load-more-container');
     const loadMoreButton = document.getElementById('history-load-more-button');
     // How it Works Section
     const howItWorksSection = document.getElementById('how-it-works-section');
     // --- NEW Asset Extraction Elements ---
     const assetExtractionContentDiv = document.getElementById('asset-extraction-content');
     const assetSourceImageInput = document.getElementById('asset-source-image');
     const assetPreviewContainer = document.getElementById('asset-preview-container');
     const assetPreviewImage = document.getElementById('asset-preview-image');
     const assetPreviewPlaceholder = document.getElementById('asset-preview-placeholder');
     const assetDescriptionInput = document.getElementById('asset-description');
     const extractAssetButton = document.getElementById('extract-asset-button');
     const assetStatusP = document.getElementById('asset-status');
     const assetResultArea = document.getElementById('asset-result-area');
     const assetResultContainer = document.getElementById('asset-result-container');
     const assetResultImage = document.getElementById('asset-result-image');
     const assetDownloadButton = document.getElementById('asset-download-button');
     // --- NEW Asset History Elements ---
     const assetHistoryButton = document.getElementById('asset-history-button');
     const assetHistoryDisplayDiv = document.getElementById('asset-history-display');
     const assetHistoryLoadMoreContainer = document.getElementById('asset-history-load-more-container');
     const assetHistoryLoadMoreButton = document.getElementById('asset-history-load-more-button');

     // --- NEW: Style Profile Elements ---
     const styleProfileContentDiv = document.getElementById('style-profile-content');
     const styleThumbnailsUpload = document.getElementById('style-thumbnails-upload');
     const thumbnailPreviewsDiv = document.getElementById('thumbnail-previews');
     const analyzeStyleButton = document.getElementById('analyze-style-button');
     const styleAnalysisStatus = document.getElementById('style-analysis-status');
     const styleProfileResult = document.getElementById('style-profile-result');
     const styleProfileJson = document.getElementById('style-profile-json');
     const styleNameInput = document.getElementById('style-name');
     const saveStyleButton = document.getElementById('save-style-button');
     const savedStylesList = document.getElementById('saved-styles-list');
     const noSavedStylesMessage = document.getElementById('no-saved-styles-message');

     // --- Helper: Display Status Messages ---
     function showStatus(element, message, type = 'info', duration = 0) {
         if (!element) { console.warn("showStatus: Element not found"); return; }
         const isPurchaseStatus = element.id === 'purchase-status';
         element.innerHTML = message; // Use innerHTML to allow basic formatting like links
         element.className = type + (isPurchaseStatus ? ' header-purchase-status' : '');
         if (duration > 0) {
             setTimeout(() => {
                 if (element.innerHTML === message) { // Check if message is still the same
                     element.innerHTML = '';
                     element.className = (isPurchaseStatus ? 'header-purchase-status' : '');
                 }
             }, duration);
         }
     }

     // --- Purchase Button Event Listener (Attached to user info container) ---
     if (userInfoContainer) {
         userInfoContainer.addEventListener('click', async (event) => {
             const button = event.target.closest('.buy-credits-button.header-buy-button');
             if (button && stripe) {
                 event.preventDefault();
                 if (!currentSession) { showStatus(purchaseStatusP, "Please log in to purchase credits.", 'warning', 3000); return; }
                 const priceId = button.dataset.priceId;
                 if (!priceId || priceId === "YOUR_STRIPE_PRICE_ID_HERE") { console.error("Buy button missing or has placeholder data-price-id attribute."); showStatus(purchaseStatusP, "Error: Purchase option not configured.", 'error', 5000); return; }

                 const originalButtonText = button.innerText;
                 showStatus(purchaseStatusP, "Processing...", 'info');
                 button.disabled = true; button.innerText = "Redirecting...";

                 try {
                     const token = currentSession.access_token;
                     const res = await fetch(`${BACKEND_URL}/create-checkout-session`, {
                         method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                         body: JSON.stringify({ priceId: priceId })
                     });
                     const responseBody = await res.text(); let data;
                     try { data = JSON.parse(responseBody); } catch(e) { throw new Error(`Server returned invalid response (Status: ${res.status})`); }
                     if (!res.ok) { throw new Error(data.error || `Failed to start purchase (Status: ${res.status})`); }
                     if (data.url) { window.location.href = data.url; }
                     else { throw new Error("Could not get checkout URL from server."); }
                 } catch (err) {
                     console.error("Purchase initiation failed:", err);
                     showStatus(purchaseStatusP, `Error: ${err.message}`, 'error', 5000);
                     button.disabled = false; button.innerText = originalButtonText;
                     if (err.message.includes("Authent")) { showStatus(authStatusP, "Authentication error. Please log in again.", 'error'); await logout(); }
                 }
             }
         });
     } else { console.warn("User info container not found in DOM for purchase listener."); }


     // --- Tab switching function ---
     function handleTabSwitch(clickedTab) {
         // Get all tab buttons and content divs
         const tabButtons = document.querySelectorAll('.tab-button');
         const tabContents = [
             document.getElementById('prompt-gen-tab-content'),
             document.getElementById('asset-extraction-content'),
             document.getElementById('style-profile-content')
         ];
         const howItWorksSection = document.getElementById('how-it-works-section');
         
         // Remove active class from all tabs
         tabButtons.forEach(tab => tab.classList.remove('active'));
         
         // Add active class to clicked tab
         clickedTab.classList.add('active');
         
         // Hide all tab contents
         tabContents.forEach(content => {
             if (content) content.style.display = 'none';
         });
         
         // Show the corresponding content
         if (clickedTab.id === 'tab-prompt-gen' && tabContents[0]) {
             tabContents[0].style.display = 'block';
             // Show "How it Works" section only on Image Generation tab
             if (howItWorksSection) howItWorksSection.style.display = 'block';
         } else if (clickedTab.id === 'tab-asset-extraction' && tabContents[1]) {
             tabContents[1].style.display = 'block';
             // Hide "How it Works" section on other tabs
             if (howItWorksSection) howItWorksSection.style.display = 'none';
         } else if (clickedTab.id === 'tab-style-profile' && tabContents[2]) {
             tabContents[2].style.display = 'block';
             // Hide "How it Works" section on other tabs
             if (howItWorksSection) howItWorksSection.style.display = 'none';
         }
         
         // Also update the content view to ensure everything is properly displayed
         updateContentView();
     }

     // --- Utility to update Credit UI and Button States ---
     function updateCreditState(credits) {
         currentUserCredits = credits;
         const creditsWrapper = creditsContainer ? creditsContainer.parentElement : null;

         // Update Credits Display in Header
         if (credits === 'loading') {
             creditsDisplaySpan.innerText = '...';
             if (creditsContainer) creditsContainer.style.display = 'inline-flex';
             if (creditsWrapper && creditsWrapper !== userInfoContainer) creditsWrapper.style.display = 'flex';
         } else if (credits !== null && typeof credits === 'number' && credits >= 0) {
             creditsDisplaySpan.innerText = credits;
             if (creditsContainer) creditsContainer.style.display = 'inline-flex';
             if (creditsWrapper && creditsWrapper !== userInfoContainer) creditsWrapper.style.display = 'flex';
         } else {
             if (creditsContainer) creditsContainer.style.display = 'none';
              if (creditsWrapper && creditsWrapper !== userInfoContainer) creditsWrapper.style.display = 'none';
             creditsDisplaySpan.innerText = '--';
         }

         // Update Thumbnail Generation Button State
         const canGenerateThumbnails = (credits !== null && typeof credits === 'number' && credits >= TOTAL_GENERATION_COST);
          if (confirmPromptButton) {
              confirmPromptButton.disabled = !canGenerateThumbnails;
              confirmPromptButton.innerText = `Generate ${NUM_IMAGES_EXPECTED} Thumbnails (Cost: ${TOTAL_GENERATION_COST} Credits)`;
              // Handle edge cases for button text
              if (credits === null && !currentSession) { confirmPromptButton.innerText = `Generate ${NUM_IMAGES_EXPECTED} Thumbnails (Login Required)`; confirmPromptButton.disabled = true; }
              else if (credits === null && currentSession) { confirmPromptButton.innerText = `Generate ${NUM_IMAGES_EXPECTED} Thumbnails (Credit Error)`; confirmPromptButton.disabled = true; }
          } else { console.warn("Element 'confirm-prompt-button' not found during credit state update."); }

         // Update Thumbnail Credit Warning Message
         if (creditWarningP) {
             if (credits !== null && typeof credits === 'number' && credits < TOTAL_GENERATION_COST) {
                  const creditsTargetElement = creditsContainer.closest('.user-info-container > div') || creditsContainer;
                  creditWarningP.innerHTML = `You need ${TOTAL_GENERATION_COST} credits (have ${credits}). <a href="#" onclick="event.preventDefault(); scrollToElement(creditsTargetElement.id || 'credits-container');">Buy More Credits?</a>`;
                  creditWarningP.style.display = 'block';
              } else {
                  creditWarningP.style.display = 'none';
                  creditWarningP.innerHTML = '';
              }
         }

         // --- NEW: Update Asset Extraction Button State ---
         const canExtractAssets = (credits !== null && typeof credits === 'number' && credits >= CREDIT_COST_PER_ASSET_EXTRACTION);
         if (extractAssetButton) {
             // Enable button only if credits are sufficient AND an image is selected AND description is entered
             const isReadyToExtract = canExtractAssets && selectedAssetImageDataUri && assetDescriptionInput?.value.trim();
             extractAssetButton.disabled = !isReadyToExtract;
             extractAssetButton.innerText = `Extract Asset (Cost: ${CREDIT_COST_PER_ASSET_EXTRACTION} Credits)`;
              // Handle edge cases for button text
             if (credits === null && !currentSession) { extractAssetButton.innerText = `Extract Asset (Login Required)`; extractAssetButton.disabled = true; }
             else if (credits === null && currentSession) { extractAssetButton.innerText = `Extract Asset (Credit Error)`; extractAssetButton.disabled = true; }
             else if (credits !== null && typeof credits === 'number' && credits < CREDIT_COST_PER_ASSET_EXTRACTION) {
                  extractAssetButton.innerText = `Extract Asset (Need ${CREDIT_COST_PER_ASSET_EXTRACTION} Credits)`;
                  extractAssetButton.disabled = true;
             }
         } else { console.warn("Element 'extract-asset-button' not found during credit state update."); }

         // --- NEW: Update Asset Extraction Status Message (for low credits) ---
         if (assetStatusP && credits !== null && typeof credits === 'number' && credits < CREDIT_COST_PER_ASSET_EXTRACTION) {
             const creditsTargetElement = creditsContainer.closest('.user-info-container > div') || creditsContainer;
              showStatus(assetStatusP, `Insufficient credits. You need ${CREDIT_COST_PER_ASSET_EXTRACTION} (have ${credits}). <a href="#" onclick="event.preventDefault(); scrollToElement(creditsTargetElement.id || 'credits-container');">Buy More</a>`, 'warning');
         } else if (assetStatusP && assetStatusP.innerText.includes("Insufficient credits")) {
             // Clear the low credit warning if credits are now sufficient
             showStatus(assetStatusP, '');
         }
     }

     // --- Function to Fetch User Credits ---
     async function fetchUserCredits() {
         if (!currentSession) { updateCreditState(null); return; }
         console.log("Fetching user credits...");
         updateCreditState('loading'); // Show loading state

         try {
             const token = currentSession.access_token;
             const res = await fetch(`${BACKEND_URL}/get_profile`, {
                 method: "GET", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` }
             });
             const responseBody = await res.text(); let data;
             try { data = JSON.parse(responseBody); } catch(e) { throw new Error(`Server returned invalid response (Status: ${res.status})`); }
             if (!res.ok) { if (res.status === 401) { console.warn("fetchUserCredits received 401, letting auth listener handle logout."); return; } throw new Error(data.error || `Failed to fetch credits (Status: ${res.status})`); }
             updateCreditState(data.credits);
         } catch (err) {
             console.error("Error fetching credits:", err);
             if(currentSession) { showStatus(authStatusP, `Error loading credits: ${err.message}`, 'error'); }
             updateCreditState(null); // Error state
         }
     }


     // --- Auth Functions (Login, Signup, Logout) ---
     async function login() {
         showStatus(authStatusP, 'Logging in...', 'info');
         const email = document.getElementById('auth-email').value;
         const password = document.getElementById('auth-password').value;
         
         try {
             // Attempt to sign in with password
             const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
             
             if (error) {
                 // Check if the error is related to email verification
                 if (error.message && (error.message.toLowerCase().includes('email not confirmed') || 
                                        error.message.toLowerCase().includes('email confirmation') ||
                                        error.message.toLowerCase().includes('not verified'))) {
                     showStatus(authStatusP, 'Please verify your email before logging in. Check your inbox for a verification link.', 'warning', 10000);
                     
                     try {
                         // Send another verification email
                         const { data: resendData, error: resendError } = await supabaseClient.auth.resend({
                             type: 'signup',
                             email: email,
                             options: {
                                 emailRedirectTo: `${window.location.origin}/app/`
                             }
                         });
                         
                         if (resendError) {
                             console.error("Error resending verification email:", resendError);
                             showStatus(authStatusP, `Could not resend verification email: ${resendError.message}`, 'error', 10000);
                         } else {
                             showStatus(authStatusP, 'Verification email resent. Please check your inbox.', 'info', 10000);
                         }
                     } catch (resendErr) {
                         console.error("Exception resending verification email:", resendErr);
                         showStatus(authStatusP, 'Could not resend verification email. Please try signing up again.', 'error', 10000);
                     }
                     return;
                 }
                 throw error;
             }
             
             // Check if user is verified by checking if session exists
             if (!data.session) {
                 showStatus(authStatusP, 'Please verify your email before logging in. Check your inbox for a verification link.', 'warning', 10000);
                 
                 try {
                     // Send another verification email
                     const { data: resendData, error: resendError } = await supabaseClient.auth.resend({
                         type: 'signup',
                         email: email,
                         options: {
                             emailRedirectTo: `${window.location.origin}/app/`
                         }
                     });
                     
                     if (resendError) {
                         console.error("Error resending verification email:", resendError);
                         showStatus(authStatusP, `Could not resend verification email: ${resendError.message}`, 'error', 10000);
                     } else {
                         showStatus(authStatusP, 'Verification email resent. Please check your inbox.', 'info', 10000);
                     }
                 } catch (resendErr) {
                     console.error("Exception resending verification email:", resendErr);
                     showStatus(authStatusP, 'Could not resend verification email. Please try signing up again.', 'error', 10000);
                 }
                 return;
             }
             
             // If we get here, user is verified and logged in successfully
             showStatus(authStatusP, 'Login successful! Loading app...', 'success');
         } catch (error) {
             console.error("Login Error:", error);
             showStatus(authStatusP, `Login Failed: ${error.message || 'Unknown error'}`, 'error');
         }
      }
     async function signup() {
          showStatus(authStatusP, "Signing up...", 'info');
          const email = document.getElementById("auth-email").value;
          const password = document.getElementById("auth-password").value;
          try {
              // Configure signup to require email confirmation
              const { data, error } = await supabaseClient.auth.signUp({
                email,
                password,
                options: {
                  emailRedirectTo: `${window.location.origin}/app/`,
                  data: {
                    confirmed_at: null // Ensure email confirmation is required
                  }
                }
              });

              if (error) {
                  console.error("Signup Error Object:", error);
                  if (error.message && error.message.toLowerCase().includes("user already registered")) {
                      showStatus(authStatusP, "This email is already registered. Please log in.", 'warning');
                  } else {
                      showStatus(authStatusP, `Signup failed: ${error.message}`, 'error');
                  }
              } else if (data && data.user) {
                  console.log("Signup Data Object:", data);
                  
                  // Check if email verification is needed
                  if (!data.session) {
                      // No session means email verification is required
                      showStatus(authStatusP, "Signup successful! Please check your email for a verification link. You must verify your email before logging in.", 'success', 15000);
                      
                      // Clear the password field for security
                      document.getElementById("auth-password").value = "";
                      
                      // Log the user out to ensure they verify email first
                      if (currentSession) {
                          await supabaseClient.auth.signOut();
                      }
                  } else {
                      // This shouldn't happen if email verification is properly enforced
                      console.warn("User was signed up and logged in without email verification");
                      showStatus(authStatusP, "Account created, but email verification is still required. Please check your inbox.", 'warning', 10000);
                      
                      // Force logout to ensure verification
                      await supabaseClient.auth.signOut();
                  }
              } else {
                  console.warn("Signup returned no error and no user data:", data);
                  showStatus(authStatusP, "Signup status unclear. Please check your email for verification instructions.", 'warning', 10000);
              }
          } catch (e) {
              showStatus(authStatusP, `Signup error: ${e.message}`, 'error');
          }
      }
     async function logout() {
         console.log("--- Logout function called ---");
         showStatus(authStatusP, "Logging out...", 'info');
         selectedAssetImageDataUri = null; // Clear selected asset on logout
         try {
             const { error } = await supabaseClient.auth.signOut();
             if (error) {
                 console.error("--- Supabase signOut error:", error.message);
                  currentSession = null; updateContentView(); updateCreditState(null);
                  showStatus(authStatusP, "Logout may have failed, please refresh if needed.", 'warning');
             } else {
                 console.log("--- Supabase signOut successful (callback pending) ---");
                 // The onAuthStateChange listener should handle the UI update
             }
         } catch (e) {
             console.error("--- Error during logout function execution:", e);
              currentSession = null; updateContentView(); updateCreditState(null);
              showStatus(authStatusP, "Error during logout, please refresh.", 'error');
         }
     }

     // --- Core View Update Logic ---
     function updateContentView() {
         const isLoggedIn = !!currentSession;
         const activeTabButton = document.querySelector('.tab-button.active');
         const activeTabId = activeTabButton ? activeTabButton.id : 'tab-prompt-gen'; // Default to first tab

         console.log(`Updating view. Logged in: ${isLoggedIn}, Active Tab: ${activeTabId}`);

         // Toggle Auth vs Main App visibility
         if (authDiv) authDiv.style.display = isLoggedIn ? 'none' : 'block';
         if (mainAppContentDiv) mainAppContentDiv.style.display = isLoggedIn ? 'block' : 'none';
          
         // Hide tabs when logged out, show when logged in
         const tabBar = document.querySelector('.tab-bar');
         if (tabBar) tabBar.style.display = isLoggedIn ? 'flex' : 'none';

         // Clear status messages on view change
         showStatus(authStatusP, '');
         showStatus(purchaseStatusP, '');
         if (assetStatusP) showStatus(assetStatusP, ''); // Clear asset status too

         if (isLoggedIn) {
             // --- Logged In View ---
             if (mainAppContentDiv) mainAppContentDiv.style.display = 'block';
             if (authDiv) authDiv.style.display = 'none';

             // Show User Info Header elements
             if (purchaseControlsDiv) {
                  purchaseControlsDiv.style.display = 'flex';
                  const wrapper = purchaseControlsDiv.parentElement;
                  if(wrapper && wrapper !== userInfoContainer){ wrapper.style.display = 'flex'; }
             }
             if (currentSession.user?.email) {
                  if (userEmailDisplaySpan) userEmailDisplaySpan.innerText = currentSession.user.email;
                  if (userInfoDisplayDiv) userInfoDisplayDiv.style.display = 'inline-flex';
             } else { if (userInfoDisplayDiv) userInfoDisplayDiv.style.display = 'none'; }

             // Show the active tab content, hide others
             if (promptGenContentDiv) promptGenContentDiv.style.display = (activeTabId === 'tab-prompt-gen') ? 'block' : 'none';
             if (assetExtractionContentDiv) assetExtractionContentDiv.style.display = (activeTabId === 'tab-asset-extraction') ? 'block' : 'none';
             if (styleProfileContentDiv) styleProfileContentDiv.style.display = (activeTabId === 'tab-style-profile') ? 'block' : 'none';

             // Update credit state (shows credits, enables/disables buttons)
             updateCreditState(currentUserCredits === null ? 'loading' : currentUserCredits);

             // Manage History Button Text & Visibility
             if (activeTabId === 'tab-prompt-gen') {
                  if (historyDiv && historyButton) {
                      historyButton.innerText = historyDiv.style.display === "block" ? "Hide History" : "Show My History";
                      const currentlyLoadedCount = historyDiv.querySelectorAll('.card').length;
                      if (loadMoreContainer) loadMoreContainer.style.display = (historyDiv.style.display === "block" && currentlyLoadedCount > 0 && currentlyLoadedCount < totalHistoryItems) ? 'block' : 'none';
                  }
                   // Hide asset history if switching back to thumbnail tab
                   if(assetHistoryDisplayDiv) assetHistoryDisplayDiv.style.display = 'none';
                   if(assetHistoryLoadMoreContainer) assetHistoryLoadMoreContainer.style.display = 'none';
                   if(assetHistoryButton) assetHistoryButton.innerText = "Show My Asset History";
             } else if (activeTabId === 'tab-asset-extraction') {
                   if (assetHistoryDisplayDiv && assetHistoryButton) {
                       assetHistoryButton.innerText = assetHistoryDisplayDiv.style.display === "block" ? "Hide Asset History" : "Show My Asset History";
                       const currentlyLoadedCount = assetHistoryDisplayDiv.querySelectorAll('.asset-card').length; // Use .asset-card selector
                       if (assetHistoryLoadMoreContainer) assetHistoryLoadMoreContainer.style.display = (assetHistoryDisplayDiv.style.display === "block" && currentlyLoadedCount > 0 && currentlyLoadedCount < totalAssetHistoryItems) ? 'block' : 'none';
                   }
                   // Hide thumbnail history if switching to asset tab
                   if(historyDiv) historyDiv.style.display = 'none';
                   if(loadMoreContainer) loadMoreContainer.style.display = 'none';
                   if(historyButton) historyButton.innerText = "Show My History";
             } else if (activeTabId === 'tab-style-profile') {
                  if (historyDiv) historyDiv.style.display = 'none';
                  if (loadMoreContainer) loadMoreContainer.style.display = 'none';
                  if (historyButton) historyButton.innerText = "Show My History";
                  if (assetHistoryDisplayDiv) assetHistoryDisplayDiv.style.display = 'none';
                  if (assetHistoryLoadMoreContainer) assetHistoryLoadMoreContainer.style.display = 'none';
                  if (assetHistoryButton) assetHistoryButton.innerText = "Show My Asset History";
             }

         } else {
             // --- Logged Out View ---
             currentUserCredits = null; updateCreditState(null); // Reset credits
             selectedAssetImageDataUri = null; // Clear selected asset image

             if (mainAppContentDiv) mainAppContentDiv.style.display = 'none';
             if (authDiv) authDiv.style.display = 'block';

             // Show "How it Works" section when logged out on the Image Generation tab
             const howItWorksSection = document.getElementById('how-it-works-section');
             if (howItWorksSection) {
                 howItWorksSection.style.display = 'block';
             }

             // Optionally show signup encouragement only on the default tab when logged out
             const signupEncouragement = document.getElementById("signup-encouragement");
             if(signupEncouragement) signupEncouragement.style.display = (activeTabId === 'tab-prompt-gen') ? 'block' : 'none';

             // Hide user-specific elements
             if (userInfoDisplayDiv) userInfoDisplayDiv.style.display = 'none';
             if (purchaseControlsDiv) {
                  purchaseControlsDiv.style.display = 'none';
                  const wrapper = purchaseControlsDiv.parentElement;
                  if(wrapper && wrapper !== userInfoContainer){ wrapper.style.display = 'none'; }
             }
             if (historyDiv) historyDiv.style.display = "none";
             if (historyButton) historyButton.innerText = "Show My History";
             currentHistoryPage = 1; totalHistoryItems = 0; isLoadingHistory = false;
             currentAssetHistoryPage = 1; totalAssetHistoryItems = 0; isLoadingAssetHistory = false;
             if(historyDiv) historyDiv.innerHTML = "";
             if(assetHistoryDisplayDiv) assetHistoryDisplayDiv.innerHTML = "";
             if(loadMoreContainer) loadMoreContainer.style.display = 'none';
             if(assetHistoryLoadMoreContainer) assetHistoryLoadMoreContainer.style.display = 'none';
             if (resultDiv) resultDiv.innerHTML = "";
             if (promptPreviewDiv) promptPreviewDiv.style.display = "none";
             if (assetResultArea) assetResultArea.style.display = "none"; // Hide asset result area
             if (assetPreviewImage) assetPreviewImage.style.display = 'none'; // Hide asset preview
             if (assetPreviewPlaceholder) assetPreviewPlaceholder.style.display = 'block';


             // Show "How it Works" only on the Image Generation tab when logged out
             if(howItWorksSection) howItWorksSection.style.display = (activeTabId === 'tab-prompt-gen') ? 'block' : 'none';
         }

         // Always show the AI badge regardless of login state
         const badge = document.querySelector('.ai-badge');
         if (badge) badge.style.display = 'block';
     }


     // --- Tab Switching ---
     promptGenTabButton.addEventListener('click', () => handleTabSwitch(promptGenTabButton));
     assetExtractionTabButton.addEventListener('click', () => handleTabSwitch(assetExtractionTabButton));
     styleProfileTabButton.addEventListener('click', () => handleTabSwitch(styleProfileTabButton));

     // --- NEW: Event Listener for Option Buttons (Thumbnail Gen) ---
     if (optionsContainer) {
         optionsContainer.addEventListener('click', (event) => {
             if (event.target.classList.contains('option-button')) {
                 event.target.classList.toggle('active');
             }
         });
     } else { console.warn("Prompt options container not found."); }


     // --- API Call Logic ---

     // Generate Prompt Suggestion (Step 1 - Thumbnail Gen)
     if (form) {
         form.addEventListener('submit', async (e) => {
             e.preventDefault();
             if (!currentSession) { showStatus(authStatusP, "Please log in to get prompt suggestions.", 'warning', 3000); return; }
             if(resultDiv) resultDiv.innerHTML = "<p style='text-align:center;'>🧠 Generating prompt idea...</p>";
             if(promptPreviewDiv) promptPreviewDiv.style.display = "none";
             if(generatePromptButton) { generatePromptButton.disabled = true; generatePromptButton.innerText = "Generating..."; }
             const title = document.getElementById('title')?.value;
             const niche = document.getElementById('niche')?.value;

             const selectedOptionElements = optionsContainer ? optionsContainer.querySelectorAll('.option-button.active') : [];
             const selectedOptions = Array.from(selectedOptionElements).map(button => button.textContent.trim());
             console.log("Selected options for prompt:", selectedOptions);

             const styleProfileSelect = document.getElementById('styleProfileSelect');
            let selectedProfileJson = null; // Default to null if none selected or data missing
            if (styleProfileSelect && styleProfileSelect.value) { // Check if an option other than "-- None --" (value="") is selected
                const selectedOption = styleProfileSelect.options[styleProfileSelect.selectedIndex];
                // Check if the selected option exists and has the data attribute
                if (selectedOption && selectedOption.dataset.profileJson) { 
                    selectedProfileJson = selectedOption.dataset.profileJson; // Get the JSON string
                    console.log("Selected Profile JSON:", selectedProfileJson); 
                } else {
                    console.log("Selected dropdown option has no profile JSON data attached or attribute is missing.");
                }
            } else {
                console.log("No style profile selected from dropdown.");
            }

              try {
                  const token = currentSession.access_token;
                  const res = await fetch(`${BACKEND_URL}/prompt_suggestion`, {
                      method: "POST", 
                      headers: { 
                          "Content-Type": "application/json",
                          "Authorization": `Bearer ${token}`
                      },
                      body: JSON.stringify({ title, niche, options: selectedOptions, style_profile_json: selectedProfileJson })
                  });
                 const responseBody = await res.text(); let data;
                 try { data = JSON.parse(responseBody); } catch(e) { throw new Error(`Server returned invalid response (Status: ${res.status})`); }
                 if (!res.ok) { throw new Error(data.error || `Server error: ${res.status}`); }
                 if (data.prompt) {
                     if (resultDiv) resultDiv.innerHTML = `<p style="color:var(--success-color); text-align: center;">✅ Prompt suggestion generated!</p>`;
                      if (promptPreviewDiv) {
                          const customPromptTextarea = document.getElementById("custom-prompt");
                          if (customPromptTextarea) { customPromptTextarea.value = data.prompt; }
                          else { console.error("Textarea #custom-prompt not found!"); }
                          promptPreviewDiv.style.display = "block";
                          updateCreditState(currentUserCredits); // Update button state inside preview div
                          scrollToElement('prompt-preview');
                      } else { console.error("Div #prompt-preview not found!"); if(resultDiv) resultDiv.innerHTML += `<p style="color:var(--error-color); text-align: center;">❌ Error: UI element missing.</p>`; }
                 } else { throw new Error('AI did not return a prompt.'); }
             } catch (err) {
                 console.error("Prompt Generation Error:", err);
                 if(resultDiv) resultDiv.innerHTML = `<p style="color:var(--error-color); text-align: center;">❌ Error Generating Prompt: ${err.message}</p>`;
                 if (promptPreviewDiv) promptPreviewDiv.style.display = "none";
             } finally { if(generatePromptButton) { generatePromptButton.disabled = false; generatePromptButton.innerText = "Suggest Prompt Idea"; }}
         });
     } else { console.warn("Thumbnail form not found."); }


     // --- Image Preview Modal Helper ---
     function showModal(src){
         const modal=document.getElementById('img-modal');
         const modalImg = modal ? modal.querySelector('img') : null;
         if (!modal || !modalImg || !src) return; // Add safety check for src
         modalImg.src=src;
         modal.style.display='flex';
     }


     // Generate Thumbnails (Step 2 - Confirm Prompt - Thumbnail Gen)
     async function confirmPrompt() {
         const promptInput = document.getElementById("custom-prompt");
         const prompt = promptInput ? promptInput.value : null;
         if (!prompt || !prompt.trim()) { showStatus(creditWarningP, "Please enter a prompt describing the thumbnail.", 'warning', 3000); scrollToElement('custom-prompt'); return; }
         if (!currentSession) { showStatus(authStatusP, "Please log in to generate thumbnails.", 'warning', 3000); scrollToElement('auth'); return; }
          const creditsTargetElement = creditsContainer.closest('.user-info-container > div') || creditsContainer;
          if (currentUserCredits === null || currentUserCredits < TOTAL_GENERATION_COST) { scrollToElement(creditsTargetElement.id || 'credits-container'); return; }

         if (resultDiv) resultDiv.innerHTML = `<p style="text-align: center;">🎨 Generating ${NUM_IMAGES_EXPECTED} thumbnails... (Cost: ${TOTAL_GENERATION_COST} credits). It can take up to a minute. Please wait.</p>`;
         if (promptPreviewDiv) promptPreviewDiv.style.display = "none";
         if (confirmPromptButton) { confirmPromptButton.disabled = true; confirmPromptButton.innerText = "Generating..."; }
         const title = document.getElementById("title")?.value;
         const niche = document.getElementById("niche")?.value;
         const styleProfileSelect = document.getElementById('styleProfileSelect');
         let selectedStyleJson = null;

         if (styleProfileSelect && styleProfileSelect.value) {
             try {
                 selectedStyleJson = JSON.parse(styleProfileSelect.options[styleProfileSelect.selectedIndex].dataset.profileJson);
                 console.log("Selected Style Profile JSON:", selectedStyleJson);
             } catch (e) {
                 console.error("Error parsing stored style profile JSON:", e);
                 showStatus(creditWarningP, 'Error retrieving selected style profile data.', 'error', 3000);
                 return; // Stop if the stored data is corrupt
             }
         }

         try {
             const token = currentSession.access_token;
             const res = await fetch(`${BACKEND_URL}/generate`, {
                 method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                 body: JSON.stringify({ title, niche, prompt, style_profile_json: selectedStyleJson })
             });
             const responseBody = await res.text(); let data;
             try { data = JSON.parse(responseBody); } catch (e) { throw new Error(`Server returned non-JSON response (Status: ${res.status})`); }
             if (!res.ok) {
                 if (res.status === 401) throw new Error("Authentication error.");
                 if (res.status === 403 && data.error?.includes("Insufficient credits")) throw new Error(data.error);
                 if (res.status === 0) { throw new Error("NetworkError when attempting to fetch resource."); }
                 throw new Error(data.error || `Server error: ${res.status}`);
             }
             if (data.image_urls && Array.isArray(data.image_urls) && data.image_urls.length > 0 && resultDiv) {
                  resultDiv.innerHTML = `<h2>Generated Thumbnails:</h2>`;
                  const gridDiv = document.createElement('div'); gridDiv.className = 'thumbnail-results-grid';
                  let displayedImages = 0;
                  data.image_urls.forEach((imageUrl, index) => {
                      if (imageUrl && imageUrl.startsWith('data:image')) {
                          displayedImages++;
                          const itemDiv = document.createElement('div'); itemDiv.className = 'thumbnail-item';
                          const img = document.createElement('img'); img.src = imageUrl; img.alt = `Generated Thumbnail Option ${index + 1}`;
                          img.onclick = () => showModal(imageUrl);
                          img.onerror = () => { img.alt = 'Error loading image'; }
                          const button = document.createElement('button');
                          const downloadFilename = `${title || 'thumbnail'}_${index + 1}`;
                          button.innerText = `⬇ Download Option ${index + 1}`;
                          button.onclick = () => downloadImage(imageUrl, downloadFilename);
                          itemDiv.appendChild(img); itemDiv.appendChild(button);
                          gridDiv.appendChild(itemDiv);
                      } else {
                          console.warn(`Received invalid image URL at index ${index}:`, imageUrl);
                          const itemDiv = document.createElement('div'); itemDiv.className = 'thumbnail-item';
                          itemDiv.innerHTML = `<p style="color:var(--warning-color); text-align: center; padding: 2rem 0;">⚠️ Image ${index + 1} failed.</p>`;
                          gridDiv.appendChild(itemDiv);
                      }
                  });
                  resultDiv.appendChild(gridDiv);
                  resultDiv.insertAdjacentHTML('beforeend', `<div class="prompt-text"><strong>Prompt Used:</strong><br>${data.prompt || prompt}</div>`);
                  scrollToElement('result');
                  if (data.new_credits !== undefined) { updateCreditState(data.new_credits); }
                  else { fetchUserCredits(); } // Fallback if backend doesn't return new credits
                  if (displayedImages < NUM_IMAGES_EXPECTED) { showStatus(resultDiv, `Generated ${displayedImages}/${NUM_IMAGES_EXPECTED} images successfully.`, 'warning', 5000); }
              } else { throw new Error('Received invalid image data from server.'); }
         } catch (err) {
             console.error("Image Generation Error:", err);
             if(resultDiv) resultDiv.innerHTML = `<p style="color:var(--error-color); text-align: center;">❌ Generation Failed: ${err.message}</p>`;
             if(promptPreviewDiv) promptPreviewDiv.style.display = "block"; // Show prompt box again even on error
             if (err.message.includes("Insufficient credits")) { await fetchUserCredits(); scrollToElement(creditsTargetElement.id || 'credits-container'); }
             else if (err.message.includes("Authent")) { await logout(); }
             else { updateCreditState(currentUserCredits); } // Refresh credit state but keep current value
         } finally {
             if(confirmPromptButton) {
                  confirmPromptButton.disabled = false;
                  updateCreditState(currentUserCredits); // Ensure button text/state reflects current credits
             }
         }
     }


     // --- History Fetch (Thumbnails) ---
     async function fetchHistory(loadMore = false) {
         if (isLoadingHistory && loadMore) return;
         if (!currentSession) { showStatus(authStatusP, "Log in to view history.", 'warning', 3000); if(historyDiv) historyDiv.style.display = "none"; if (loadMoreContainer) loadMoreContainer.style.display = 'none'; return; }
         if (!historyDiv || !historyButton) { console.warn("History elements not found."); return; }

         if (!loadMore) {
             if (historyDiv.style.display === "block") { historyDiv.style.display = "none"; historyButton.innerText = "Show My History"; if (loadMoreContainer) loadMoreContainer.style.display = 'none'; return; }
             else { currentHistoryPage = 1; totalHistoryItems = 0; historyDiv.innerHTML = "<p>📦 Loading history...</p>"; historyDiv.style.display = "block"; historyButton.innerText = "Fetching..."; if (loadMoreContainer) loadMoreContainer.style.display = 'none'; }
         } else { if (loadMoreButton) { loadMoreButton.disabled = true; loadMoreButton.innerText = "Loading..."; } }
         isLoadingHistory = true; historyButton.disabled = true;

         try {
             const token = currentSession.access_token;
             const fetchUrl = `${BACKEND_URL}/history?page=${currentHistoryPage}&limit=${HISTORY_ITEMS_PER_PAGE}`;
             const res = await fetch(fetchUrl, { method: "GET", headers: { "Authorization": `Bearer ${token}` } });
             const responseBody = await res.text(); let data;
             try { data = JSON.parse(responseBody); } catch(e) { throw new Error(`Server returned invalid history response (Status: ${res.status})`); }
             if (res.status === 401) throw new Error("Authentication error.");
             if (!res.ok) { throw new Error(data.error || `Server error fetching history: ${res.status}`); }
             const items = data.items || []; totalHistoryItems = data.total || 0;

             if (currentHistoryPage === 1) {
                 historyDiv.innerHTML = ""; // Clear loading message or previous content
                 if (items.length === 0 && totalHistoryItems === 0) { historyDiv.innerHTML = "<h2>History</h2><p>🕸️ No thumbnails generated yet.</p>"; }
                 else if (items.length > 0 || totalHistoryItems > 0) { historyDiv.innerHTML = `<h2>History (${totalHistoryItems} total)</h2>`; }
             }

             const itemsHtml = items.map(item => {
                 const displayImageUrl = item.preview_image_url || item.image_url || '';
                 const fullImageUrl    = item.image_url;
                 const canClickPreview = displayImageUrl && displayImageUrl.startsWith('data:image');
                 const showDownload    = fullImageUrl && fullImageUrl.startsWith('data:image');
                 const generatedDate   = item.created_at ? new Date(item.created_at).toLocaleString() : 'N/A';
                 const maxPromptLength = 100;
                 const displayPrompt   = (item.prompt && item.prompt.length > maxPromptLength) ? item.prompt.substring(0, maxPromptLength) + '…' : (item.prompt || 'N/A');
                 const safeTitle       = (item.title || 'thumbnail').replace(/[^a-z0-9_]/gi, '_').toLowerCase();

                 return `
                   <div class="card">
                        ${displayImageUrl ? `<img src="${displayImageUrl}" alt="Thumbnail Preview: ${item.title || 'Untitled'}" ${canClickPreview ? `onclick="showModal('${fullImageUrl || displayImageUrl}')"` : ''} style="${canClickPreview ? '' : 'cursor:default;'}" onerror="this.alt='Error loading preview'; this.nextElementSibling?.remove();">` : '<p style="text-align:center; padding: 2rem 0; color: var(--text-muted);">⚠️ Image unavailable</p>'}
                        ${showDownload ? `<button onclick="downloadImage('${fullImageUrl}','${safeTitle}')" class="secondary-button">⬇ Download</button>` : ''}
                        <p><strong>Title:</strong> ${item.title || 'N/A'}</p>
                        <p><strong>Niche:</strong> ${item.niche || 'N/A'}</p>
                        <p><strong>Prompt:</strong> ${displayPrompt}</p>
                        <p class="timestamp">Generated: ${generatedDate}</p>
                   </div>`;
             }).join('');

             historyDiv.insertAdjacentHTML('beforeend', itemsHtml);
             const currentlyLoadedCount = historyDiv.querySelectorAll('.card').length;
             if (loadMoreContainer) {
                 if (items.length > 0 && currentlyLoadedCount < totalHistoryItems) {
                     loadMoreContainer.style.display = 'block';
                     if (loadMoreButton) { loadMoreButton.disabled = false; loadMoreButton.innerText = "Load More History"; }
                     currentHistoryPage++;
                 } else {
                     loadMoreContainer.style.display = 'none';
                     if (currentlyLoadedCount > 0 && currentHistoryPage > 1 && currentlyLoadedCount >= totalHistoryItems) {
                          if (!historyDiv.querySelector('.no-more-history')) { historyDiv.insertAdjacentHTML('beforeend', '<p class="no-more-history">-- End of History --</p>'); }
                     }
                 }
             }
         } catch (err) {
             console.error("Error fetching history:", err);
             if (currentHistoryPage === 1 && historyDiv) { historyDiv.innerHTML = `<p style="color:var(--error-color);">❌ Error fetching history: ${err.message}</p>`; historyDiv.style.display = "block"; }
             else { /* Handle load more error display if needed */ }
             if (err.message.includes("Authent")) await logout();
         } finally {
             isLoadingHistory = false; if(historyButton) historyButton.disabled = false;
             if (historyDiv && historyButton) historyButton.innerText = historyDiv.style.display === "block" ? "Hide History" : "Show My History";
              if (loadMoreButton && loadMoreContainer && loadMoreContainer.style.display === 'block') { loadMoreButton.disabled = false; loadMoreButton.innerText = "Load More History"; }
         }
     }
     // NOTE: history load more button listener is outside DOMContentLoaded


     // --- NEW: Asset Extraction File Input Handling ---
     if (assetSourceImageInput) {
         assetSourceImageInput.addEventListener('change', (event) => {
             const file = event.target.files[0];
             selectedAssetImageDataUri = null; // Reset previous selection
             if (assetPreviewImage) assetPreviewImage.style.display = 'none';
             if (assetPreviewPlaceholder) assetPreviewPlaceholder.style.display = 'block';
             if (assetResultArea) assetResultArea.style.display = 'none'; // Hide previous result
             if (assetStatusP) showStatus(assetStatusP, ''); // Clear previous status
             updateCreditState(currentUserCredits); // Update button state

             if (file) {
                 if (file.type !== 'image/png') {
                     showStatus(assetStatusP, 'Invalid file type. Please select a PNG image.', 'error', 5000);
                     assetSourceImageInput.value = ''; // Clear the input
                     return;
                 }

                 const reader = new FileReader();
                 reader.onload = (e) => {
                     selectedAssetImageDataUri = e.target.result;
                     if (assetPreviewImage) {
                         assetPreviewImage.src = selectedAssetImageDataUri;
                         assetPreviewImage.style.display = 'block';
                     }
                     if (assetPreviewPlaceholder) assetPreviewPlaceholder.style.display = 'none';
                     updateCreditState(currentUserCredits); // Update button state now that image is loaded
                 }
                 reader.onerror = (e) => {
                     console.error("FileReader error:", e);
                     showStatus(assetStatusP, 'Error reading the selected file.', 'error', 5000);
                     selectedAssetImageDataUri = null;
                      assetSourceImageInput.value = '';
                      updateCreditState(currentUserCredits);
                 }
                 reader.readAsDataURL(file);
             }
         });
     } else { console.warn("Asset source image input not found."); }

     // --- NEW: Asset Description Input Handling ---
     if (assetDescriptionInput) {
         assetDescriptionInput.addEventListener('input', () => {
             // Update button state whenever description changes
             updateCreditState(currentUserCredits);
         });
     }

     // --- NEW: Extract Asset API Call ---
     async function extractAsset() {
         if (!currentSession) { showStatus(authStatusP, "Please log in to extract assets.", 'warning', 3000); scrollToElement('auth'); return; }
         if (!selectedAssetImageDataUri) { showStatus(assetStatusP, 'Please select a PNG image first.', 'warning', 3000); return; }
         const description = assetDescriptionInput ? assetDescriptionInput.value.trim() : null;
         if (!description) { showStatus(assetStatusP, 'Please describe the asset you want to extract.', 'warning', 3000); scrollToElement('asset-description'); return; }
         const creditsTargetElement = creditsContainer ? creditsContainer.closest('.user-info-container > div') : null;
          if (currentUserCredits === null || currentUserCredits < CREDIT_COST_PER_ASSET_EXTRACTION) {
             showStatus(assetStatusP, `Insufficient credits. You need ${CREDIT_COST_PER_ASSET_EXTRACTION}.`, 'error', 4000);
             scrollToElement(creditsTargetElement?.id || 'credits-container');
             return;
          }

         if (assetStatusP) showStatus(assetStatusP, '⏳ Extracting asset... This might take a minute.', 'info');
         if (extractAssetButton) { extractAssetButton.disabled = true; extractAssetButton.innerText = "Extracting..."; }
         if (assetResultArea) assetResultArea.style.display = 'none'; // Hide previous result

         try {
             const token = currentSession.access_token;
             const res = await fetch(`${BACKEND_URL}/extract_asset`, {
                 method: "POST", 
                 headers: { 
                     "Content-Type": "application/json",
                     "Authorization": `Bearer ${token}`
                 },
                 // Only send the required parameters for asset extraction
                 body: JSON.stringify({ 
                     image_data_uri: selectedAssetImageDataUri,
                     asset_description: description
                 }) 
             });

             const responseBody = await res.text(); let data;
             try { data = JSON.parse(responseBody); } catch (e) { throw new Error(`Server returned non-JSON response (Status: ${res.status})`); }

             if (!res.ok) {
                 if (res.status === 401) throw new Error("Authentication error.");
                 if (res.status === 403 && data.error?.includes("Insufficient credits")) throw new Error(data.error);
                 // Handle specific DALL-E content policy error
                 if (res.status === 400 && data.error?.includes("content policy violation")) {
                     throw new Error("Extraction failed: The request violated the AI's content policy.");
                 }
                 if (res.status === 0) { throw new Error("NetworkError when attempting to fetch resource."); }
                 throw new Error(data.error || `Asset extraction failed (Status: ${res.status})`);
             }

             if (data.result_png_uri && data.result_png_uri.startsWith('data:image/png')) {
                 if (assetResultImage) {
                     assetResultImage.src = data.result_png_uri;
                     assetResultImage.onclick = () => showModal(data.result_png_uri);
                     assetResultImage.onerror = () => {
                         assetResultImage.alt = 'Error loading extracted image preview';
                         // Optionally add a visible error message if preview fails
                         console.error("Error loading asset preview image.");
                         // You could add text here like: previewContainer.innerHTML = "<p>Preview failed</p>";
                     };
                     assetResultImage.style.display = 'block';
                 } else { console.warn("Asset result image element not found."); }

                 if (assetResultContainer) assetResultContainer.style.display = 'flex'; // Make sure container is visible

                 if (assetDownloadButton) {
                     assetDownloadButton.onclick = () => downloadImage(data.result_png_uri, `extracted_${description.replace(/[^a-z0-9_]/gi, '_').toLowerCase() || 'asset'}`);
                     assetDownloadButton.style.display = 'inline-block';
                 } else { console.warn("Asset download button element not found."); }

                 if (assetResultArea) assetResultArea.style.display = 'block'; // Show the results area

                 if (assetStatusP) showStatus(assetStatusP, '✅ Asset extracted successfully!', 'success', 5000);
                 scrollToElement('asset-result-area');

                 if (data.new_credits !== undefined) {
                     updateCreditState(data.new_credits);
                 } else {
                     fetchUserCredits(); // Fetch credits if backend didn't return them
                 }
             } else {
                 // It's possible the b64_json was empty/invalid from the start
                 console.error("Received success status but invalid/missing 'result_png_uri'."); // Use console.error
                 throw new Error('AI did not return valid image data.');
             }

         } catch (err) {
             console.error("Asset Extraction Error:", err);
             if(assetStatusP) showStatus(assetStatusP, `❌ Extraction Failed: ${err.message}`, 'error');
             if (err.message.includes("Insufficient credits")) { await fetchUserCredits(); scrollToElement(creditsTargetElement?.id || 'credits-container'); }
             else if (err.message.includes("Authent")) { await logout(); }
             else { updateCreditState(currentUserCredits); } // Refresh credit state but keep current value
         } finally {
             if (extractAssetButton) {
                 // Re-enable button based on current state after API call
                 updateCreditState(currentUserCredits);
             }
         }
     }
     // Attach listener to the button
     if (extractAssetButton) { extractAssetButton.addEventListener('click', extractAsset); }

     // --- UPDATED Asset History Fetch Function ---
     async function fetchAssetHistory(loadMore = false) {
        // Keep initial logs for checking if function starts
        console.log("FETCH ASSET HISTORY STARTING - loadMore:", loadMore); // Changed to console.log
        console.log("isLoadingAssetHistory:", isLoadingAssetHistory, "currentSession:", !!currentSession);

        // --- Initial Checks ---
        if (isLoadingAssetHistory && loadMore) {
            console.log("Exiting: Already loading more history.");
            return;
        }
        if (!currentSession) { console.error("Exiting fetchAssetHistory: No current session."); showStatus(authStatusP, "Log in to view asset history.", 'warning', 3000); if (assetHistoryDisplayDiv) assetHistoryDisplayDiv.style.display = "none"; if (assetHistoryLoadMoreContainer) assetHistoryLoadMoreContainer.style.display = 'none'; if (assetHistoryButton) assetHistoryButton.innerText = "Show My Asset History"; return; }
        // Ensure DOM elements exist
        if (!assetHistoryDisplayDiv || !assetHistoryButton || !assetHistoryLoadMoreContainer || !assetHistoryLoadMoreButton) {
            console.error("CRITICAL: Asset history DOM elements not found! Check IDs: asset-history-display, asset-history-button, asset-history-load-more-container, asset-history-load-more-button");
            showStatus(assetStatusP || authStatusP, "UI Error: History elements missing.", 'error', 5000);
            if(assetHistoryButton) assetHistoryButton.innerText = "Show My Asset History"; // Reset button text if possible
            return;
        }

        console.log("Proceeding to fetch/toggle history display.");

        // --- Button State & Toggle Logic ---
        assetHistoryButton.disabled = true; // Disable main button during operation

        if (!loadMore) {
            // This is the first click on "Show My Asset History"
            if (assetHistoryDisplayDiv.style.display === "block") {
                // If already visible, hide it
                console.log("Toggling history OFF");
                assetHistoryDisplayDiv.style.display = "none";
                assetHistoryButton.innerText = "Show My Asset History";
                assetHistoryLoadMoreContainer.style.display = 'none';
                assetHistoryButton.disabled = false; // Re-enable button
                return; // Exit function
            } else {
                // If hidden, prepare to show (set loading message but DON'T set display:block yet)
                console.log("Toggling history ON - preparing for fetch.");
                currentAssetHistoryPage = 1;
                totalAssetHistoryItems = 0;
                assetHistoryDisplayDiv.innerHTML = "<p>📦 Loading asset history...</p>"; // Show loading message
                // NOTE: display: block is now set AFTER fetch succeeds
                assetHistoryButton.innerText = "Fetching..."; // Update button text while loading
                assetHistoryLoadMoreContainer.style.display = 'none'; // Hide load more initially
            }
        } else {
            // This is a click on "Load More"
            console.log("Loading more history...");
            assetHistoryLoadMoreButton.disabled = true;
            assetHistoryLoadMoreButton.innerText = "Loading...";
            // Keep main button disabled
        }

        isLoadingAssetHistory = true; // Flag that we are loading

        // --- Fetch Data ---
        try {
            const token = currentSession.access_token;
            const fetchUrl = `${BACKEND_URL}/asset_history?page=${currentAssetHistoryPage}&limit=${ASSET_HISTORY_ITEMS_PER_PAGE}`;
            console.log(`Workspaceing asset history from: ${fetchUrl}`); // Changed log prefix

            const res = await fetch(fetchUrl, { method: "GET", headers: { "Authorization": `Bearer ${token}` } });
            console.log(`Workspace response status: ${res.status}`); // Changed log prefix

            const responseBody = await res.text();
            let data;
            try {
                data = JSON.parse(responseBody);
            } catch (err) {
                console.error("Failed to parse JSON response:", responseBody);
                throw new Error(`Server returned invalid asset history response (Status: ${res.status})`);
            }

            // Handle HTTP errors
            if (res.status === 401) throw new Error("Authentication error.");
            if (!res.ok) { throw new Error(data.error || `Server error fetching asset history: ${res.status}`); }
            const items = data.items || []; totalAssetHistoryItems = data.total || 0;
            console.log(`Received ${items.length} items. Total items: ${totalAssetHistoryItems}`);

            // ---> Make the container visible NOW, just before adding content <---
            assetHistoryDisplayDiv.style.display = "block";

            // --- Prepare Display Area (Page 1 Only) ---
            if (currentAssetHistoryPage === 1) {
                assetHistoryDisplayDiv.innerHTML = ""; // Clear loading message
                // Add Heading
                const heading = document.createElement('h2');
                heading.textContent = `Asset History (${totalAssetHistoryItems} total)`;
                assetHistoryDisplayDiv.appendChild(heading);
                // Handle case where history is empty
                if (items.length === 0 && totalAssetHistoryItems === 0) { assetHistoryDisplayDiv.innerHTML = `<h2>Asset History</h2><p>✂️ No assets extracted yet.</p>`; }
                else if (items.length > 0 || totalAssetHistoryItems > 0) { assetHistoryDisplayDiv.innerHTML = `<h2>Asset History (${totalAssetHistoryItems} total)</h2>`; }
            }

            // --- Render History Items (Simplified Look) ---
            if (items.length > 0) {
                const itemsHtml = items.map(item => {
                    const extractedPreviewUrl = item.extracted_asset_preview_url || '';
                    const extractedFullUrl = item.extracted_asset_url || ''; // Full URI for download/modal

                    // Only show extracted asset preview
                    const extractedImgHtml = extractedPreviewUrl.startsWith('data:image')
                        ? `<img src="${extractedPreviewUrl}" alt="Extracted Asset Preview" style="cursor:pointer;" onclick="showModal('${extractedFullUrl || extractedPreviewUrl}')">`
                        : '<p style="font-size:0.8em; color:var(--text-muted);">Extracted Preview N/A</p>';

                    // Download button logic
                    const canDownload = extractedFullUrl.startsWith('data:image/png');
                    const safeDescription = (item.asset_description || 'asset').replace(/[^a-z0-9_]/gi, '_').toLowerCase();
                    const downloadFilename = `extracted_${safeDescription}_${item.id || Date.now()}`;
                    const downloadButtonHtml = canDownload
                        ? `<button onclick="downloadImage('${extractedFullUrl}','${downloadFilename}')" class="secondary-button">⬇ Download</button>`
                        : '';

                    const generatedDate = item.created_at ? new Date(item.created_at).toLocaleString() : 'N/A';

                    // Simplified card structure: Image centered above text/button
                    return `
                        <div class="asset-card">
                             <div class="asset-card-preview-container">
                                ${extractedImgHtml}
                             </div>
                             <p><strong>Description:</strong> ${item.asset_description || 'N/A'}</p>
                             <p class="timestamp">Generated: ${generatedDate}</p>
                             ${downloadButtonHtml}
                        </div>`;
                }).join('');

                assetHistoryDisplayDiv.insertAdjacentHTML('beforeend', itemsHtml);
                const currentlyLoadedCount = assetHistoryDisplayDiv.querySelectorAll('.asset-card').length;
                console.log("Currently loaded asset card count:", currentlyLoadedCount);

                if (assetHistoryLoadMoreContainer) {
                    if (items.length > 0 && currentlyLoadedCount < totalAssetHistoryItems) {
                        // Show "Load More" button if there are more items to load
                        assetHistoryLoadMoreContainer.style.display = 'block';
                        if (assetHistoryLoadMoreButton) {
                            assetHistoryLoadMoreButton.disabled = false;
                            assetHistoryLoadMoreButton.innerText = "Load More Asset History";
                        }
                        currentAssetHistoryPage++; // Increment page number for the next fetch
                    } else {
                        assetHistoryLoadMoreContainer.style.display = 'none';
                        // Add "End of History" message if appropriate
                        if (currentlyLoadedCount > 0 && currentlyLoadedCount >= totalAssetHistoryItems) {
                            if (!assetHistoryDisplayDiv.querySelector('.no-more-history')) {
                                const endMsg = document.createElement('p');
                                endMsg.className = 'no-more-history'; // Use class for styling
                                endMsg.textContent = '-- End of Asset History --';
                                assetHistoryDisplayDiv.appendChild(endMsg);
                            }
                        }
                    }
                }
            }
            console.log("FETCH ASSET HISTORY FINISHED TRY BLOCK successfully.");

        } catch (err) {
            // --- Error Handling ---
            console.error("FETCH ASSET HISTORY CAUGHT ERROR:", err);
            if (currentAssetHistoryPage === 1 && assetHistoryDisplayDiv) {
                // Show error message only if it's the first page load attempt
                assetHistoryDisplayDiv.innerHTML = `<h2>Asset History</h2><p style="color:var(--error-color);">❌ Error fetching asset history: ${err.message}</p>`;
                assetHistoryDisplayDiv.style.display = "block"; // Ensure div is visible to show error
            } else if (assetHistoryDisplayDiv){
                // Optionally show error near load more button if loading more fails
                 showStatus(assetHistoryLoadMoreContainer || assetStatusP, `Error loading more: ${err.message}`, 'error', 4000);
            }
            // Handle specific errors
            if (err.message.includes("Authent")) await logout();
            // Ensure button text is reset even on error for the main button
            if (assetHistoryButton) assetHistoryButton.innerText = "Show My Asset History";

        } finally {
            // --- Cleanup & Final Button State ---
            console.log("FETCH ASSET HISTORY FINALLY BLOCK");
            isLoadingAssetHistory = false; // Reset loading flag

            // Reset main history button state based on final visibility
            if (assetHistoryButton) {
                assetHistoryButton.disabled = false; // Always re-enable main button
                if (assetHistoryDisplayDiv) {
                     // Set text based on whether the div ended up visible or not
                    assetHistoryButton.innerText = assetHistoryDisplayDiv.style.display === "block" ? "Hide Asset History" : "Show My Asset History";
                } else {
                    assetHistoryButton.innerText = "Show My Asset History"; // Fallback
                }
            }

            // Ensure Load More button is correctly enabled/disabled if it's visible
            if (assetHistoryLoadMoreButton && assetHistoryLoadMoreContainer && assetHistoryLoadMoreContainer.style.display === 'block') {
                assetHistoryLoadMoreButton.disabled = false;
                assetHistoryLoadMoreButton.innerText = "Load More Asset History";
            } else if (assetHistoryLoadMoreButton) {
                // Ensure it's disabled if the container is hidden
                assetHistoryLoadMoreButton.disabled = true;
            }
            console.log("FETCH ASSET HISTORY FINISHED FINALLY BLOCK.");
        }
    }
     // Attach listeners for asset history buttons (Done in DOMContentLoaded)


     // --- Download Image Utility ---
     function downloadImage(url, baseFilename = 'download') {
         // Find the button that triggered this (if any) to show errors nearby
         const buttons = document.querySelectorAll('button'); let downloadButton = null;
         buttons.forEach(btn => { if (btn.onclick && btn.onclick.toString().includes(url.substring(0, 50))) { downloadButton = btn; } });
         // Determine where to show error messages (near button or in a general area)
         const parentElement = downloadButton ? downloadButton.closest('.thumbnail-item, .card, .asset-card, .asset-result-actions') : (resultDiv || assetResultArea);
         let errorTarget = parentElement || resultDiv || assetResultArea || document.body; // Fallback target
          // Clear previous error messages in the target area
          const existingError = errorTarget.querySelector('.download-error-message');
          if (existingError) existingError.remove();

          if (!url || !(url.startsWith('data:image') || url.startsWith('blob:'))) { // Allow blob URLs too
              console.error("Download failed: Invalid or missing Data/Blob URI.", url);
              const errorP = document.createElement('p'); errorP.className = 'download-error-message';
              errorP.innerText = `Download failed: Image data missing or invalid.`;
              errorTarget.appendChild(errorP); // Append error to the determined target
              return;
          }
          const safeFilename = baseFilename.replace(/[^a-z0-9_.\-]/gi, '_').toLowerCase() || 'download'; // Allow dots and hyphens
          let extension = 'png'; // Default extension
          if (url.startsWith('data:image')) {
              const formatMatch = url.match(/^data:image\/([a-zA-Z+]+);base64,/);
              extension = formatMatch ? formatMatch[1].replace('+', '').toLowerCase() : 'png';
              // Handle jpeg vs jpg
              if (extension === 'jpeg') extension = 'jpg';
          }
          // Ensure filename has the correct extension
          const filename = safeFilename.endsWith('.' + extension) ? safeFilename : `${safeFilename}.${extension}`;

          try {
              const link = document.createElement("a"); link.href = url; link.download = filename;
              document.body.appendChild(link); link.click(); document.body.removeChild(link);
              console.log(`Download initiated for: ${filename}`);
          } catch (err) {
              console.error("Download failed via link click:", err);
              const errorP = document.createElement('p'); errorP.className = 'download-error-message';
              errorP.innerText = `Download failed (${err.message}). Try right-clicking the image > 'Save Image As...'.`;
              errorTarget.appendChild(errorP);
          }
     }


     // --- Scroll Utility ---
      function scrollToElement(elementId) {
          let element;
          if (typeof elementId === 'string') { element = document.getElementById(elementId); }
          else if (elementId instanceof Element) { element = elementId; }

          if (element) {
              element.scrollIntoView({ behavior: 'smooth', block: 'center' });
              // Optional highlight effect
              const elementIdentifier = element.id || '';
              const parentWrapper = element.closest('.user-info-container > div');
              const highlightTarget = parentWrapper || element;
               // Apply highlight to specific interactive areas or results
               if (['auth', 'credit-warning', 'custom-prompt', 'result', 'credits-container', 'asset-description', 'asset-result-area'].includes(elementIdentifier) || parentWrapper) {
                   highlightTarget.style.transition = 'background-color 0.5s ease-in-out, box-shadow 0.5s ease-in-out';
                   const highlightColor = ['result', 'asset-result-area'].includes(elementIdentifier) ? 'rgba(167, 139, 250, 0.05)' : 'rgba(167, 139, 250, 0.1)';
                   highlightTarget.style.backgroundColor = highlightColor;
                   highlightTarget.style.boxShadow = '0 0 15px rgba(167, 139, 250, 0.3)';
                   setTimeout(() => {
                       highlightTarget.style.backgroundColor = '';
                       highlightTarget.style.boxShadow = '';
                   }, 1500);
               }
           } else { console.warn(`scrollToElement: Element not found for identifier:`, elementId); }
      }


     // --- Style Profile Functions ---
     // Store uploaded thumbnails
     let uploadedThumbnails = [];
     const MAX_THUMBNAILS = 5;
     
     // Initialize style profile functionality
     function initStyleProfile() {
         if (styleThumbnailsUpload) {
             styleThumbnailsUpload.addEventListener('change', handleThumbnailUpload);
         }
         
         if (analyzeStyleButton) {
             analyzeStyleButton.addEventListener('click', analyzeStyle);
         }
         
         if (saveStyleButton) {
             saveStyleButton.addEventListener('click', saveStyleProfile);
         }
         
         // Load saved styles from Supabase
         loadSavedStyles();
     }
     
     // Handle thumbnail upload
     function handleThumbnailUpload(e) {
         const files = e.target.files;
         if (!files || files.length === 0) return;
         
         // Check if adding these files would exceed the limit
         if (uploadedThumbnails.length + files.length > MAX_THUMBNAILS) {
             showStatus(styleAnalysisStatus, `You can only upload up to ${MAX_THUMBNAILS} thumbnails. Please remove some first.`, 'warning', 4000);
             return;
         }
         
         // Process each file
         Array.from(files).forEach(file => {
             // Check if file is an image
             if (!file.type.startsWith('image/')) {
                 showStatus(styleAnalysisStatus, `File '${file.name}' is not an image. Skipping.`, 'warning', 3000);
                 return;
             }
             
             // Create a thumbnail preview
             const reader = new FileReader();
             reader.onload = function(event) {
                 // Create thumbnail object
                 const thumbnail = {
                     id: Date.now() + Math.random().toString(36).substring(2, 9), // Generate unique ID
                     file: file,
                     dataUrl: event.target.result
                 };
                 
                 // Add to array
                 uploadedThumbnails.push(thumbnail);
                 
                 // Create and add preview element
                 addThumbnailPreview(thumbnail);
             };
             reader.onerror = function(event) {
                 console.error("Error reading file:", event);
                 showStatus(styleAnalysisStatus, `Error reading file '${file.name}'.`, 'error', 3000);
             };
             reader.readAsDataURL(file);
         });
         
         // Reset file input
         e.target.value = '';
     }
     
     // Add thumbnail preview to the UI
     function addThumbnailPreview(thumbnail) {
         if (!thumbnailPreviewsDiv) return;
         
         // Create preview element
         const previewDiv = document.createElement('div');
         previewDiv.className = 'thumbnail-preview';
         previewDiv.dataset.id = thumbnail.id;
         
         // Create image
         const img = document.createElement('img');
         img.src = thumbnail.dataUrl;
         img.alt = 'Thumbnail preview';
         
         // Create remove button
         const removeButton = document.createElement('button');
         removeButton.className = 'remove-thumbnail';
         removeButton.innerHTML = '&times;';
         removeButton.addEventListener('click', () => removeThumbnail(thumbnail.id));
         
         // Add elements to preview
         previewDiv.appendChild(img);
         previewDiv.appendChild(removeButton);
         
         // Add to container
         thumbnailPreviewsDiv.appendChild(previewDiv);
         
         // Update UI state
         updateStyleUIState();
     }
     
     // Remove thumbnail
     function removeThumbnail(id) {
         // Remove from array
         uploadedThumbnails = uploadedThumbnails.filter(thumb => thumb.id !== id);
         
         // Remove from UI
         const previewElement = thumbnailPreviewsDiv?.querySelector(`.thumbnail-preview[data-id="${id}"]`);
         if (previewElement) {
             previewElement.remove();
         }
         
         // Update UI state
         updateStyleUIState();
     }
     
     // Update UI state based on uploaded thumbnails
     function updateStyleUIState() {
         if (!analyzeStyleButton) return;
         
         // Enable/disable analyze button based on whether thumbnails are uploaded
         analyzeStyleButton.disabled = uploadedThumbnails.length === 0;
         
         // Update button text to show count
         analyzeStyleButton.innerText = `Analyze Style (${uploadedThumbnails.length}/${MAX_THUMBNAILS}) (Cost: 5 Credits)`;
     }
     
     // Analyze style using ChatGPT
     // Analyze style using ChatGPT
async function analyzeStyle() {
    if (!currentSession || uploadedThumbnails.length === 0) {
        showStatus(styleAnalysisStatus, 'Please upload at least one thumbnail to analyze.', 'warning', 3000);
        return;
    }
    
    // Check if user has enough credits
    const CREDIT_COST_PER_STYLE_ANALYSIS = 5;
    if (currentUserCredits === null || currentUserCredits < CREDIT_COST_PER_STYLE_ANALYSIS) {
        const creditsTargetElement = creditsContainer ? creditsContainer.closest('.user-info-container > div') : null;
        showStatus(styleAnalysisStatus, `Insufficient credits. You need ${CREDIT_COST_PER_STYLE_ANALYSIS}.`, 'error', 4000);
        scrollToElement(creditsTargetElement?.id || 'credits-container');
        return;
    }
    
    // Disable button and show status
    if (analyzeStyleButton) {
        analyzeStyleButton.disabled = true;
        analyzeStyleButton.innerText = 'Analyzing...';
    }
    showStatus(styleAnalysisStatus, '🎨 Analyzing thumbnails... This may take up to a minute.', 'info');
    
    try {
        // Create FormData with all thumbnails
        const formData = new FormData();
        uploadedThumbnails.forEach((thumb, index) => {
            formData.append(`thumbnail_${index}`, thumb.file);
        });
        
        // Send to backend
        const token = currentSession.access_token;
        const res = await fetch(`${BACKEND_URL}/analyze_style`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        // Parse response
        const data = await res.json();
        
        // Handle errors
        if (!res.ok) {
            if (res.status === 401) throw new Error('Authentication error.');
            if (res.status === 403 && data.error?.includes('Insufficient credits')) throw new Error(data.error);
            throw new Error(data.error || `Server error: ${res.status}`);
        }
        
        // Handle success
        if (data.style_profile) {
            // Show result
            if (styleProfileResult) styleProfileResult.style.display = 'block';
            if (styleProfileJson) {
                // Format JSON for better readability
                const formattedJson = JSON.stringify(JSON.parse(data.style_profile), null, 2);
                styleProfileJson.value = formattedJson;
            }
            
            // Update credits
            if (data.new_credits !== undefined) {
                updateCreditState(data.new_credits);
            } else {
                fetchUserCredits(); // Fetch credits if backend didn't return them
            }
            
            // Show success message
            showStatus(styleAnalysisStatus, '✅ Style analysis completed!', 'success', 3000);
            scrollToElement('style-profile-result');
        } else {
            throw new Error('Server did not return a style profile.');
        }
    } catch (err) {
        console.error('Style Analysis Error:', err);
        showStatus(styleAnalysisStatus, `❌ Error: ${err.message}`, 'error', 6000);
        // Handle specific errors
        if (err.message?.includes("Authentication error")) { await logout(); }
        else if (err.message?.includes("Insufficient credits")) { await fetchUserCredits(); }
    } finally {
        // Re-enable button
        if (analyzeStyleButton) {
            analyzeStyleButton.disabled = false;
            updateStyleUIState();
        }
    }
}


// Save style profile
function saveStyleProfile() {
    if (!styleProfileJson || !styleNameInput) return;
    
    // Get style profile JSON and name
    const styleProfile = styleProfileJson.value.trim();
    const styleName = styleNameInput.value.trim();
    
    // Validate
    if (!styleProfile) {
        showStatus(styleAnalysisStatus, 'No style profile to save.', 'warning', 3000);
        return;
    }
    
    if (!styleName) {
        const styleNameWarning = document.getElementById('style-name-warning');
        if (styleNameWarning) {
            styleNameWarning.style.display = 'block';
            styleNameWarning.className = 'warning';
        }
        styleNameInput.focus();
        return;
    } else {
        const styleNameWarning = document.getElementById('style-name-warning');
        if (styleNameWarning) {
            styleNameWarning.style.display = 'none';
        }
    }
    
    if (!currentSession) {
        showStatus(styleAnalysisStatus, 'Please log in to save styles.', 'warning', 3000);
        return;
    }
    
    // Save to Supabase
    saveStyleToSupabase(styleName, styleProfile);
}
     
     // Save style to Supabase
     async function saveStyleToSupabase(name, profile) {
         try {
             const token = currentSession.access_token;
             const res = await fetch(`${BACKEND_URL}/style_profiles`, {
                 method: "POST",
                 headers: {
                     "Content-Type": "application/json",
                     "Authorization": `Bearer ${token}`
                 },
                 body: JSON.stringify({ name, profile })
             });
             
             const responseBody = await res.text();
             let data;
             try {
                 data = JSON.parse(responseBody);
             } catch(e) {
                 throw new Error(`Server returned invalid response (Status: ${res.status})`);
             }
             
             if (!res.ok) {
                 throw new Error(data.error || `Failed to save style profile (Status: ${res.status})`);
             }
             
             // Clear inputs
             styleNameInput.value = '';
             
             // Show success message
             showStatus(styleAnalysisStatus, `✅ Style "${name}" saved successfully!`, 'success', 3000);
             
             // Reload saved styles
             loadSavedStyles();
         } catch (err) {
             console.error("Error saving style profile:", err);
             showStatus(styleAnalysisStatus, `❌ Error: ${err.message}`, 'error', 4000);
             // Handle specific errors
             if (err.message?.includes("Authentication error")) { await logout(); }
         }
     }
// Helper function to add a style profile to the dropdown
function addStyleToDropdown(profile) {
    const styleProfileSelect = document.getElementById('styleProfileSelect');
    if (styleProfileSelect && profile && profile.name && profile.id) { // Use profile.name instead of profile.profile_name
        // Check if this profile ID already exists in the dropdown
        const existingOption = Array.from(styleProfileSelect.options).find(opt => opt.value === profile.id);
        if (existingOption) {
            console.warn(`Style profile with ID ${profile.id} already exists in dropdown. Skipping.`);
            return;
        }
        
        const option = document.createElement('option');
        option.value = profile.id; // Use profile ID as the value
        option.textContent = profile.name || 'Unnamed Profile'; // Use name, fallback if missing
        option.dataset.profileJson = profile.profile; // Store the actual profile JSON string in a data attribute
        styleProfileSelect.appendChild(option);
    } else {
        console.warn("Could not add style to dropdown. Element or profile data missing/invalid:", profile);
    }
}



// ----- Function to Create a Style Card Element (with Expand/Edit) -----
function createStyleCard(profile) {
    if (!profile || !profile.id || !profile.name) {
        console.error("Cannot create style card: profile data is incomplete.", profile);
        return null;
    }

    const card = document.createElement('div');
    card.className = 'style-card';
    card.dataset.profileId = profile.id;

    // Clickable Header for Name and Expand/Collapse
    const cardHeader = document.createElement('div');
    cardHeader.className = 'style-card-header'; // Add CSS for this
    cardHeader.style.display = 'flex';
    cardHeader.style.justifyContent = 'space-between';
    cardHeader.style.alignItems = 'center';
    cardHeader.style.cursor = 'pointer';
    
    const nameHeader = document.createElement('h3');
    nameHeader.textContent = profile.name;
    nameHeader.style.margin = '0';
    cardHeader.appendChild(nameHeader);
    
    const expandIndicator = document.createElement('span'); // Optional: for a +/- or arrow
    expandIndicator.className = 'expand-indicator';
    expandIndicator.textContent = ' [+]'; // Simple text indicator
    cardHeader.appendChild(expandIndicator);

    // JSON Viewer (hidden by default)
    const jsonViewer = document.createElement('div');
    jsonViewer.className = 'style-card-json-viewer'; // Add CSS for this
    jsonViewer.style.display = 'none';
    jsonViewer.style.padding = '10px';
    jsonViewer.style.backgroundColor = 'rgba(0,0,0,0.05)';
    jsonViewer.style.borderRadius = '4px';
    jsonViewer.style.marginTop = '8px';
    jsonViewer.style.marginBottom = '8px';
    jsonViewer.style.maxHeight = '300px';
    jsonViewer.style.overflow = 'auto';
    
    const pre = document.createElement('pre');
    pre.style.margin = '0';
    pre.style.whiteSpace = 'pre-wrap';
    pre.style.wordBreak = 'break-word';
    
    try {
        // Attempt to parse and re-stringify for pretty printing
        const parsedProfile = JSON.parse(profile.profile);
        pre.textContent = JSON.stringify(parsedProfile, null, 2);
    } catch (e) {
        console.warn(`Could not parse profile JSON for pretty printing (ID: ${profile.id}). Displaying raw.`, e);
        pre.textContent = profile.profile; // Fallback to raw string
    }
    jsonViewer.appendChild(pre);

    // Store the expanded state in a data attribute to maintain state
    card.dataset.expanded = 'false';
    
    cardHeader.addEventListener('click', () => {
        const isExpanded = card.dataset.expanded === 'true';
        jsonViewer.style.display = isExpanded ? 'none' : 'block';
        expandIndicator.textContent = isExpanded ? ' [+]' : ' [-]';
        card.dataset.expanded = isExpanded ? 'false' : 'true';
        
        // If edit form is visible, hide it when expanding/collapsing JSON
        if (editForm.style.display === 'block' && !isExpanded) {
            // This case should ideally not happen if edit mode hides the header,
            // but as a safe guard:
            // editForm.style.display = 'none';
            // actionsDiv.style.display = 'flex'; // Or your original display type
        }
    });

    // Edit Form (hidden by default)
    const editForm = document.createElement('div');
    editForm.className = 'style-card-edit-form'; // Add CSS for this
    editForm.style.display = 'none';
    editForm.style.padding = '10px';
    editForm.style.backgroundColor = 'rgba(0,0,0,0.03)';
    editForm.style.borderRadius = '4px';
    editForm.style.marginTop = '8px';

    const nameLabel = document.createElement('label');
    nameLabel.textContent = 'Style Name:';
    nameLabel.htmlFor = `edit-style-name-${profile.id}`;
    nameLabel.style.display = 'block';
    nameLabel.style.marginBottom = '4px';
    nameLabel.style.fontWeight = 'bold';
    
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.id = `edit-style-name-${profile.id}`;
    nameInput.value = profile.name;
    nameInput.style.width = '100%';
    nameInput.style.padding = '8px';
    nameInput.style.marginBottom = '12px';
    nameInput.style.borderRadius = '4px';
    nameInput.style.border = '1px solid var(--border-color)';

    const jsonLabel = document.createElement('label');
    jsonLabel.textContent = 'Profile JSON:';
    jsonLabel.htmlFor = `edit-style-json-${profile.id}`;
    jsonLabel.style.display = 'block';
    jsonLabel.style.marginBottom = '4px';
    jsonLabel.style.fontWeight = 'bold';
    
    const jsonTextarea = document.createElement('textarea');
    jsonTextarea.id = `edit-style-json-${profile.id}`;
    jsonTextarea.rows = 10; // Adjust as needed
    jsonTextarea.value = profile.profile;
    jsonTextarea.style.width = '100%';
    jsonTextarea.style.padding = '8px';
    jsonTextarea.style.marginBottom = '12px';
    jsonTextarea.style.borderRadius = '4px';
    jsonTextarea.style.border = '1px solid var(--border-color)';
    jsonTextarea.style.fontFamily = 'monospace';
    jsonTextarea.style.fontSize = '14px';

    const saveEditButton = document.createElement('button');
    saveEditButton.textContent = 'Save Changes';
    saveEditButton.className = 'button primary-button';
    saveEditButton.style.marginRight = '8px';
    saveEditButton.addEventListener('click', async () => {
        const updatedName = nameInput.value.trim();
        const updatedProfileJson = jsonTextarea.value.trim();
        const statusP = document.getElementById('style-analysis-status') || document.getElementById('status');

        if (!updatedName) {
            if (statusP) showStatus(statusP, 'Style name cannot be empty.', 'error', 3000);
            else alert('Style name cannot be empty.');
            nameInput.focus();
            return;
        }
        try {
            JSON.parse(updatedProfileJson); // Validate JSON
        } catch (e) {
            if (statusP) showStatus(statusP, 'Invalid JSON in profile.', 'error', 4000);
            else alert('Invalid JSON in profile.');
            jsonTextarea.focus();
            return;
        }

        // Show loading state
        saveEditButton.disabled = true;
        saveEditButton.textContent = 'Saving...';

        const success = await updateStyleInSupabase(profile.id, { name: updatedName, profile: updatedProfileJson });
        
        // Reset button state
        saveEditButton.disabled = false;
        saveEditButton.textContent = 'Save Changes';
        
        if (success) {
            // Hide edit form and restore view
            editForm.style.display = 'none';
            cardHeader.style.display = 'flex';
            actionsDiv.style.display = 'flex';
            
            // Update the name header with the new name
            nameHeader.textContent = updatedName;
            
            // Update the JSON viewer with the new content
            try {
                const parsedProfile = JSON.parse(updatedProfileJson);
                pre.textContent = JSON.stringify(parsedProfile, null, 2);
            } catch (e) {
                pre.textContent = updatedProfileJson;
            }
            
            // If it was expanded, keep it expanded
            if (card.dataset.expanded === 'true') {
                jsonViewer.style.display = 'block';
            }
        } else {
            // Error message already shown by updateStyleInSupabase
        }
    });

    const cancelEditButton = document.createElement('button');
    cancelEditButton.textContent = 'Cancel';
    cancelEditButton.className = 'button secondary-button';
    cancelEditButton.addEventListener('click', () => {
        // Reset form values to original
        nameInput.value = profile.name;
        jsonTextarea.value = profile.profile;
        // Toggle visibility
        editForm.style.display = 'none';
        cardHeader.style.display = 'flex'; // Or your original display type for header
        
        // Restore JSON viewer state based on expanded state
        if (card.dataset.expanded === 'true') {
            jsonViewer.style.display = 'block';
            expandIndicator.textContent = ' [-]';
        } else {
            jsonViewer.style.display = 'none';
            expandIndicator.textContent = ' [+]';
        }
        
        actionsDiv.style.display = 'flex'; // Or your original display type
    });

    editForm.appendChild(nameLabel);
    editForm.appendChild(nameInput);
    editForm.appendChild(document.createElement('br'));
    editForm.appendChild(jsonLabel);
    editForm.appendChild(jsonTextarea);
    editForm.appendChild(document.createElement('br'));
    editForm.appendChild(saveEditButton);
    editForm.appendChild(cancelEditButton);

    // Action Buttons (Use, Edit, Delete)
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'style-card-actions';
    actionsDiv.style.display = 'flex';
    actionsDiv.style.justifyContent = 'flex-start';
    actionsDiv.style.gap = '8px';
    actionsDiv.style.marginTop = '8px';

    const useButton = document.createElement('button');
    useButton.textContent = 'Use';
    useButton.className = 'button primary-button';
    useButton.style.padding = '6px 12px';
    useButton.style.fontSize = '14px';
    useButton.addEventListener('click', () => {
        // (Existing Use button logic - copied from your previous working version)
        console.log(`Use button clicked for profile: ${profile.name}`, profile);
        const styleProfileSelect = document.getElementById('styleProfileSelect');
        const statusP = document.getElementById('style-analysis-status') || document.getElementById('prompt-status') || document.getElementById('status');
        if (styleProfileSelect) {
            styleProfileSelect.value = profile.id;
            const promptGenTabButton = document.getElementById('tab-prompt-gen');
            if (promptGenTabButton && !promptGenTabButton.classList.contains('active')) {
                handleTabSwitch(promptGenTabButton);
            }
            scrollToElement('styleProfileSelect');
            if(statusP) showStatus(statusP, `Selected style profile: \"${profile.name}\"`, 'info', 3000);
            else alert(`Selected style profile: \"${profile.name}\"`);
        } else {
            if(statusP) showStatus(statusP, 'Error: Style profile dropdown not found.', 'error', 3000);
            else alert('Error: Style profile dropdown not found.');
        }
    });

    const editButton = document.createElement('button');
    editButton.textContent = 'Edit';
    editButton.className = 'button secondary-button';
    editButton.style.padding = '6px 12px';
    editButton.style.fontSize = '14px';
    editButton.addEventListener('click', () => {
        cardHeader.style.display = 'none'; // Hide header
        jsonViewer.style.display = 'none'; // Hide JSON viewer
        actionsDiv.style.display = 'none'; // Hide action buttons
        editForm.style.display = 'block';  // Show edit form
        nameInput.value = profile.name;    // Ensure form is populated
        jsonTextarea.value = profile.profile;
        
        // Focus on the name input for better UX
        setTimeout(() => nameInput.focus(), 0);
    });

    const deleteButton = document.createElement('button');
    deleteButton.textContent = 'Delete';
    deleteButton.className = 'button secondary-button';
    deleteButton.style.padding = '6px 12px';
    deleteButton.style.fontSize = '14px';
    deleteButton.addEventListener('click', (event) => {
        event.stopPropagation();
        if (confirm(`Are you sure you want to delete the style profile \"${profile.name}\"?`)) {
            deleteStyleFromSupabase(profile.id);
        }
    });

    actionsDiv.appendChild(useButton);
    actionsDiv.appendChild(editButton); // Added Edit button
    actionsDiv.appendChild(deleteButton);

    // Style the card itself
    card.style.border = '1px solid var(--border-color)';
    card.style.borderRadius = '8px';
    card.style.padding = '12px';
    card.style.marginBottom = '16px';
    card.style.backgroundColor = 'var(--card-bg)';
    
    // Append main elements to card
    card.appendChild(cardHeader);
    card.appendChild(jsonViewer);
    card.appendChild(editForm);
    card.appendChild(actionsDiv);

    return card;
}

     
                    // Load saved styles from Supabase and update UI elements
            async function loadSavedStyles() {
              console.log("Executing loadSavedStyles...");
              // --- Get references to UI elements ---
              const styleProfileSelect = document.getElementById('styleProfileSelect'); // Dropdown in Image Gen tab
              const savedStylesListContainer = document.getElementById('saved-styles-list'); // Container for style cards in Styles tab
              const noSavedStylesMsgElement = document.getElementById('no-saved-styles-message');   // Message when no styles in Styles tab
              const styleStatusPElement = document.getElementById('style-status');        // Status message element in Styles tab
     
              // --- Reset UI Elements ---
              if (savedStylesListContainer) savedStylesListContainer.innerHTML = ''; // Clear old cards
              if (noSavedStylesMsgElement) noSavedStylesMsgElement.style.display = 'none'; // Hide message initially
              
              // Reset dropdown specifically
              if (styleProfileSelect) {
                  styleProfileSelect.innerHTML = '<option value="">-- Loading... --</option>';
                  styleProfileSelect.disabled = true;
              } else {
                  console.warn("Style profile select dropdown (#styleProfileSelect) not found in the DOM.");
              }
     
              // --- Check Authentication ---
              if (!currentSession) {
                  console.log("loadSavedStyles: No active session. Styles cannot be loaded.");
                  if (noSavedStylesMsgElement) {
                      noSavedStylesMsgElement.textContent = 'Please log in to view saved styles.';
                      noSavedStylesMsgElement.style.display = 'block';
                  }
                  if (styleProfileSelect) {
                      styleProfileSelect.innerHTML = '<option value="">-- Log in --</option>';
                      // Keep it disabled
                  }
                  if (styleStatusPElement) showStatus(styleStatusPElement, ''); // Clear status message
                  return; // Exit if not logged in
              }
     
              // --- Fetch Styles --- 
              try {
                  const token = currentSession.access_token;
                  const response = await fetch(`${BACKEND_URL}/style_profiles`, {
                      headers: { 'Authorization': `Bearer ${token}` }
                  });
              
                  if (!response.ok) {
                      const errorData = await response.json().catch(() => ({ error: `HTTP error ${response.status}` }));
                      throw new Error(errorData.error || `Failed to fetch styles`);
                  }
              
                  const responseData = await response.json(); // Get the full response object
                  let styles = responseData.profiles;      // Extract the 'profiles' array
                  console.log("Fetched styles:", styles);    // Should now log the array

                  // Filter out duplicate styles based on ID
                  if (Array.isArray(styles)) {
                      const uniqueIds = new Set();
                      styles = styles.filter(profile => {
                          if (!profile || !profile.id) {
                              console.warn('Invalid profile found without ID. Removing it.');
                              return false;
                          }
                          if (uniqueIds.has(profile.id)) {
                              console.warn(`Duplicate style profile found with ID: ${profile.id}. Removing duplicate.`);
                              return false;
                          }
                          uniqueIds.add(profile.id);
                          return true;
                      });
                      console.log("After removing duplicates:", styles);
                  }
              
                  // --- Update UI based on fetched data --- 
              
                  // Reset dropdown to default "None" before populating
                  if (styleProfileSelect) {
                      styleProfileSelect.innerHTML = '<option value="">-- None --</option>';
                  }
              
                  // Ensure 'styles' is actually an array before proceeding
                  if (!Array.isArray(styles) || styles.length === 0) { 
                      // No styles found
                      if (noSavedStylesMsgElement) {
                          noSavedStylesMsgElement.textContent = 'No saved styles found. Create one below!';
                          noSavedStylesMsgElement.style.display = 'block';
                      }
                      if (styleProfileSelect) {
                          styleProfileSelect.disabled = true; // Keep dropdown disabled as there are no options
                      }
                      console.log("No saved styles found for the user or response was not an array.");
                  } else {
                      // Styles found - populate cards and dropdown
                      if (noSavedStylesMsgElement) noSavedStylesMsgElement.style.display = 'none'; // Hide "no styles" message
                      
                      if (styleProfileSelect) {
                          styleProfileSelect.disabled = false; // Enable dropdown since there are options
                      }
                      
                      // Populate dropdown and cards
                      styles.forEach(profile => {
                          console.log("Processing profile:", profile);
                           
                          // Call helper to add to dropdown
                          addStyleToDropdown(profile); 
     
                          // Create and add style card to the UI
                          if (savedStylesListContainer) {
                              // Check if a card with this profile ID already exists
                              const existingCard = savedStylesListContainer.querySelector(`[data-profile-id="${profile.id}"]`);
                              if (existingCard) {
                                  console.warn(`Style card with ID ${profile.id} already exists in the UI. Skipping.`);
                                  return;
                              }
                               
                              const cardElement = createStyleCard(profile);
                              if (cardElement) {
                                  savedStylesListContainer.appendChild(cardElement);
                              }
                          }
                      });
     
                      // Log after populating
                      console.log("Styles loaded and UI populated (cards & dropdown).");
                  }
                  if (styleStatusPElement) showStatus(styleStatusPElement, ''); // Clear any previous error status message
     
              } catch (error) {
                  console.error('❌ Error during loadSavedStyles:', error);
                  if (styleStatusPElement) showStatus(styleStatusPElement, `Error loading styles: ${error.message}`, 'error');
                  // Reset UI elements to an error state
                  if (savedStylesListContainer) savedStylesListContainer.innerHTML = ''; // Clear potentially partial cards
                  if (noSavedStylesMsgElement) {
                      noSavedStylesMsgElement.textContent = 'Could not load styles.';
                      noSavedStylesMsgElement.style.display = 'block';
                  }
                  if (styleProfileSelect) {
                      styleProfileSelect.innerHTML = '<option value="">-- Error --</option>';
                      styleProfileSelect.disabled = true;
                  }
                  // Specific error handling can be added here, e.g., for authentication errors
                  if (error.message?.includes("auth")) {
                      console.warn("Authentication error detected while loading styles.");
                      // Consider actions like logging out the user or prompting re-login
                  }
              }
          }
     
     // Get saved styles from Supabase
     async function getSavedStylesFromSupabase() {
         if (!currentSession) {
             // If not logged in, show message and return
             return [];
         }
         
         try {
             const token = currentSession.access_token;
             const res = await fetch(`${BACKEND_URL}/style_profiles`, {
                 method: "GET",
                 headers: {
                     "Content-Type": "application/json",
                     "Authorization": `Bearer ${token}`
                 }
             });
             
             const responseBody = await res.text();
             let data;
             try {
                 data = JSON.parse(responseBody);
             } catch(e) {
                 throw new Error(`Server returned invalid response (Status: ${res.status})`);
             }
             
             if (!res.ok) {
                 throw new Error(data.error || `Failed to load styles (Status: ${res.status})`);
             }
             
             return data.profiles || [];
         } catch (err) {
             console.error("Error loading styles:", err);
             return [];
         }
     }
     
     // Update style in Supabase
     async function updateStyleInSupabase(styleId, updatedData) {
         try {
             const token = currentSession.access_token;
             const res = await fetch(`${BACKEND_URL}/style_profiles/${styleId}`, {
                 method: "PUT",
                 headers: {
                     "Content-Type": "application/json",
                     "Authorization": `Bearer ${token}`
                 },
                 body: JSON.stringify(updatedData)
             });
             
             const responseBody = await res.text();
             let data;
             try {
                 data = JSON.parse(responseBody);
             } catch(e) {
                 throw new Error(`Server returned invalid response (Status: ${res.status})`);
             }
             
             if (!res.ok) {
                 throw new Error(data.error || `Failed to update style (Status: ${res.status})`);
             }
             
             // Show success message
             showStatus(styleAnalysisStatus, `✅ Style "${updatedData.name}" updated successfully!`, 'success', 3000);
             
             // Reload saved styles to reflect changes immediately
             loadSavedStyles();
             
             return true;
         } catch (err) {
             console.error("Error updating style:", err);
             showStatus(styleAnalysisStatus, `❌ Error: ${err.message}`, 'error', 4000);
             // Handle specific errors
             if (err.message?.includes("Authentication error")) { await logout(); }
             return false;
         }
     }
     
     // Delete style from Supabase
     async function deleteStyleFromSupabase(styleId) {
         try {
             const token = currentSession.access_token;
             const res = await fetch(`${BACKEND_URL}/style_profiles/${styleId}`, {
                 method: "DELETE",
                 headers: {
                     "Content-Type": "application/json",
                     "Authorization": `Bearer ${token}`
                 }
             });
             
             const responseBody = await res.text();
             let data;
             try {
                 data = JSON.parse(responseBody);
             } catch(e) {
                 throw new Error(`Server returned invalid response (Status: ${res.status})`);
             }
             
             if (!res.ok) {
                 throw new Error(data.error || `Failed to delete style (Status: ${res.status})`);
             }
             
             // Show success message
             showStatus(styleAnalysisStatus, `✅ Style deleted successfully!`, 'success', 3000);
             
             // Reload saved styles
             loadSavedStyles();
         } catch (err) {
             console.error("Error deleting style:", err);
             showStatus(styleAnalysisStatus, `❌ Error: ${err.message}`, 'error', 4000);
             // Handle specific errors
             if (err.message?.includes("Authentication error")) { await logout(); }
         }
     }
     // --- Initialization and Auth State Change Listener ---
     document.addEventListener('DOMContentLoaded', () => {
         // Attach Tab Listeners
         console.log("DOM Content Loaded - Attaching Tab Listeners..."); // Add log
         if (promptGenTabButton) {
             promptGenTabButton.addEventListener('click', () => handleTabSwitch(promptGenTabButton));
             console.log("Attached listener to promptGenTabButton");
         } else { console.warn("promptGenTabButton not found"); }
         if (assetExtractionTabButton) {
              assetExtractionTabButton.addEventListener('click', () => handleTabSwitch(assetExtractionTabButton));
              console.log("Attached listener to assetExtractionTabButton");
         } else { console.warn("assetExtractionTabButton not found"); }
          
          // Add missing event listener for Style Profile tab
          if (styleProfileTabButton) {
               styleProfileTabButton.addEventListener('click', () => handleTabSwitch(styleProfileTabButton));
               console.log("Attached listener to styleProfileTabButton");
          } else { console.warn("styleProfileTabButton not found"); }


          // ---> Attach Asset History Button Listeners HERE <---
         console.log("Attaching Asset History Listeners...");
         if (assetHistoryButton) {
             assetHistoryButton.addEventListener('click', () => fetchAssetHistory(false));
              console.log("Attached listener to assetHistoryButton");
         } else {
             console.error("ERROR: assetHistoryButton element NOT FOUND during DOMContentLoaded!");
         }
         if (assetHistoryLoadMoreButton) {
             assetHistoryLoadMoreButton.addEventListener('click', () => fetchAssetHistory(true));
              console.log("Attached listener to assetHistoryLoadMoreButton");
         } else {
             console.warn("assetHistoryLoadMoreButton not found (this might be ok if history isn't loaded yet)");
         }
          // ---> End History Listener Attachment <---


         // Check for payment status from Stripe redirect
         const urlParams = new URLSearchParams(window.location.search);
         const paymentStatus = urlParams.get('payment');
         const statusTargetElement = purchaseStatusP; // Target header status

         if (statusTargetElement) {
             if (paymentStatus === 'success') {
                 showStatus(statusTargetElement, "✅ Payment successful! Credits updating...", 'success');
                 setTimeout(() => { if (currentSession) fetchUserCredits(); }, 4000);
                 setTimeout(() => { if (statusTargetElement.innerText.includes("Payment successful")) showStatus(statusTargetElement, ''); }, 10000);
                 if (window.history.replaceState) window.history.replaceState(null, '', window.location.pathname + window.location.hash);
             } else if (paymentStatus === 'cancel') {
                 showStatus(statusTargetElement, "⚠️ Purchase cancelled.", 'warning', 5000);
                 if (window.history.replaceState) window.history.replaceState(null, '', window.location.pathname + window.location.hash);
             }
         }
         // Initial view setup is handled by onAuthStateChange
     });

     // NOTE: Need listener for Thumbnail history load more button outside DOMContentLoaded
     if (loadMoreButton) { loadMoreButton.addEventListener('click', () => fetchHistory(true)); }
     // The listener for the main thumbnail history button #history-button uses onclick in the HTML
     // The listener for asset extraction button #extract-asset-button is attached directly below the function def

     // Auth state change listener
     supabaseClient.auth.onAuthStateChange((event, session) => {
         console.log('--- Supabase Auth Event ---:', event, session ? `User: ${session.user?.id}` : "No session");
         const previousSession = currentSession; // Store previous state
         currentSession = session;

         // Determine if a major UI update is needed
         const needsFullUpdate =
             event === 'INITIAL_SESSION' ||
             (event === 'SIGNED_IN' && !previousSession) || // Logged in from null state
             (event === 'SIGNED_OUT' && previousSession);   // Logged out from logged in state

         if (needsFullUpdate) {
             console.log(` ---> Triggering full UI update (updateContentView) for event: ${event}`);
              updateContentView(); // Set up basic view (logged in/out, tabs)
              if (session) {
                  console.log(` ---> Session exists, triggering fetchUserCredits`);
                   fetchUserCredits(); // Fetch credits and update buttons etc.
                  
                   // Load styles for the current user
                   console.log(` ---> Session exists, triggering loadSavedStyles`);
                   loadSavedStyles(); // Load styles for the logged-in user
              } else {
                  console.log(` ---> Session is null, triggering updateCreditState(null)`);
                   updateCreditState(null); // Ensure credits UI is reset
                   
                   // Clear styles list when logged out
                   console.log(` ---> Session is null, clearing saved styles list.`);
                   if (savedStylesList) savedStylesList.innerHTML = ''; // Clear the visual list
                   if (noSavedStylesMessage) {
                       noSavedStylesMessage.style.display = 'block'; 
                       noSavedStylesMessage.textContent = 'Please log in to view your saved styles.';
                   }
              }
         } else if (session && (event === "TOKEN_REFRESHED" || event === "USER_UPDATED")) {
             // If already logged in and token refreshes or user updates, just fetch credits
             console.log(` ---> Event ${event} received while logged in, triggering fetchUserCredits`);
              fetchUserCredits();
         } else {
             console.log(` ---> Event ${event} did not trigger specific action.`);
              if (event === "PASSWORD_RECOVERY") { showStatus(authStatusP, "Password recovery email sent.", 'info', 5000); }
         }
     });

     // Initialize style profile functionality
     initStyleProfile();
 </script>

</body>
</html>